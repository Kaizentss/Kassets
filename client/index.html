<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kassets - Asset Management</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Dark theme (default) */
      --bg-primary: #09090b;
      --bg-secondary: #0f172a;
      --bg-tertiary: #1e293b;
      --bg-card: rgba(30, 41, 59, 0.7);
      --bg-card-solid: #1e293b;
      --bg-input: rgba(15, 23, 42, 0.8);
      --border-color: rgba(148, 163, 184, 0.1);
      --border-color-hover: rgba(59, 130, 246, 0.3);
      --text-primary: #e2e8f0;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --accent-blue: #3b82f6;
      --accent-green: #34d399;
      --accent-red: #f87171;
      --accent-gold: #ffd700;
      --shadow-color: rgba(0, 0, 0, 0.3);
      --modal-bg: rgba(0, 0, 0, 0.8);
      --gradient-primary: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      --gradient-modal: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    }

    [data-theme="light"] {
      --bg-primary: #f8fafc;
      --bg-secondary: #f1f5f9;
      --bg-tertiary: #e2e8f0;
      --bg-card: rgba(255, 255, 255, 0.9);
      --bg-card-solid: #ffffff;
      --bg-input: rgba(241, 245, 249, 0.9);
      --border-color: rgba(100, 116, 139, 0.2);
      --border-color-hover: rgba(59, 130, 246, 0.4);
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --text-muted: #64748b;
      --accent-blue: #2563eb;
      --accent-green: #059669;
      --accent-red: #dc2626;
      --accent-gold: #d97706;
      --shadow-color: rgba(0, 0, 0, 0.1);
      --modal-bg: rgba(0, 0, 0, 0.5);
      --gradient-primary: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f8fafc 100%);
      --gradient-modal: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-primary); color: var(--text-primary); overflow-x: hidden; transition: background 0.3s ease, color 0.3s ease; }
    .glass-card { background: var(--bg-card); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border-color); border-radius: 16px; box-shadow: 0 8px 32px var(--shadow-color); transition: all 0.3s ease; }
    .stat-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px; transition: all 0.3s ease; }
    .stat-card:hover { transform: translateY(-2px); border-color: var(--border-color-hover); }
    .btn-primary { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border: none; padding: 12px 24px; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-family: inherit; font-size: 14px; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-secondary { background: var(--bg-card); color: var(--text-secondary); border: 1px solid var(--border-color); padding: 12px 24px; border-radius: 10px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; font-family: inherit; font-size: 14px; }
    .btn-secondary:hover { background: var(--bg-tertiary); color: var(--text-primary); }
    .btn-danger { background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3); padding: 10px 20px; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; font-family: inherit; }
    .btn-danger:hover { background: rgba(239, 68, 68, 0.3); }
    .btn-gold { background: linear-gradient(135deg, #ffd700, #d4a000); color: #0f172a; border: none; padding: 12px 24px; border-radius: 10px; font-weight: 600; cursor: pointer; font-family: inherit; }
    .btn-gold:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4); }
    .input-field { width: 100%; padding: 12px 16px; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-primary); font-size: 15px; transition: all 0.3s ease; font-family: inherit; outline: none; }
    .input-field:focus { border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    .input-field::placeholder { color: var(--text-muted); }
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--modal-bg); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
    .modal-content { background: var(--gradient-modal); border: 1px solid var(--border-color); border-radius: 20px; padding: 32px; max-width: 500px; width: 100%; max-height: 85vh; overflow-y: auto; }
    .tab-btn { padding: 12px 20px; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s ease; border-bottom: 2px solid transparent; font-family: inherit; }
    .tab-btn:hover { color: var(--text-secondary); }
    .tab-btn.active { color: var(--accent-blue); border-bottom-color: var(--accent-blue); }
    .category-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    .location-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .asset-row { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px 20px; margin-bottom: 12px; transition: all 0.3s ease; }
    .asset-row:hover { background: var(--bg-tertiary); border-color: var(--border-color-hover); }
    .asset-row.selected { background: rgba(59, 130, 246, 0.15); border-color: rgba(59, 130, 246, 0.4); }
    .theme-toggle { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; font-size: 18px; }
    .theme-toggle:hover { background: var(--bg-tertiary); transform: rotate(15deg); }

    /* Chart styles */
    .chart-container { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 20px; }
    .chart-bar { height: 24px; border-radius: 6px; transition: all 0.3s ease; min-width: 4px; }
    .chart-bar:hover { opacity: 0.8; transform: scaleY(1.05); }
    .chart-legend { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 16px; }
    .chart-legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-secondary); }
    .chart-legend-dot { width: 10px; height: 10px; border-radius: 50%; }

    /* Mobile improvements */
    @media (max-width: 768px) {
      .hide-mobile { display: none !important; }
      .modal-content { padding: 20px; margin: 10px; max-height: 90vh; }
      .stat-card { padding: 16px; }
      .asset-row { padding: 12px 14px; }
      header { padding: 12px 16px !important; }
      main { padding: 16px !important; }
      nav { padding: 0 16px !important; }
      .tab-btn { padding: 10px 14px; font-size: 13px; }
      .btn-primary, .btn-secondary { padding: 10px 16px; font-size: 13px; }
      .input-field { padding: 10px 14px; font-size: 14px; }
      .header-buttons { width: 100%; justify-content: flex-end; }
      .mobile-full { width: 100% !important; max-width: none !important; }
    }

    @media (max-width: 480px) {
      .stat-grid { grid-template-columns: 1fr !important; }
      .form-grid-2 { grid-template-columns: 1fr !important; }
      .btn-group-mobile { flex-direction: column; width: 100%; }
      .btn-group-mobile > * { width: 100%; }
    }
    
    /* Print Styles for Balance Sheet */
    @media print {
      * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
      body { background: white !important; color: black !important; font-size: 12pt; }
      header, nav, .btn-primary, .btn-secondary, .btn-danger, .modal-overlay { display: none !important; }
      main { padding: 0 !important; }
      .glass-card { background: white !important; border: 1px solid #ccc !important; box-shadow: none !important; backdrop-filter: none !important; padding: 20px !important; }
      .stat-card, [style*="rgba(15,23,42"] { background: #f5f5f5 !important; border: 1px solid #ddd !important; }
      table { width: 100% !important; border-collapse: collapse !important; }
      th, td { border: 1px solid #ccc !important; padding: 8px !important; color: black !important; }
      th { background: #f0f0f0 !important; }
      tr:last-child { background: #e0e0e0 !important; font-weight: bold !important; }
      h2 { color: black !important; font-size: 18pt !important; }
      p { color: #333 !important; }
      [style*="color: #34d399"], [style*="color:#34d399"] { color: #059669 !important; }
      [style*="color: #f87171"], [style*="color:#f87171"] { color: #dc2626 !important; }
      [style*="JetBrains Mono"] { font-family: 'Courier New', monospace !important; }
      @page { margin: 0.5in; size: landscape; }
    }
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect } = React;

// API Helper
const api = async (endpoint, options = {}) => {
  const token = localStorage.getItem('kassets_token');
  const res = await fetch('/api' + endpoint, {
    ...options,
    headers: {
      'Content-Type': 'application/json',
      ...(token && { Authorization: 'Bearer ' + token }),
      ...options.headers
    }
  });
  const data = await res.json();
  if (!res.ok) throw new Error(data.error || 'Error');
  return data;
};

// Login Page Component
const LoginPage = ({ onLogin, theme, toggleTheme }) => {
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const playCoinSound = () => {
    try {
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      
      // Create multiple coin "clinks" for bag of coins effect
      for (let i = 0; i < 10; i++) {
        const delay = i * 0.06 + Math.random() * 0.04;
        
        const osc = audioCtx.createOscillator();
        const osc2 = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        
        const baseFreq = 1800 + Math.random() * 2500;
        osc.frequency.setValueAtTime(baseFreq, audioCtx.currentTime + delay);
        osc.frequency.exponentialRampToValueAtTime(500, audioCtx.currentTime + delay + 0.12);
        osc.type = 'sine';
        
        osc2.frequency.setValueAtTime(baseFreq * 1.5, audioCtx.currentTime + delay);
        osc2.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + delay + 0.1);
        osc2.type = 'triangle';
        
        gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime + delay);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + delay + 0.2);
        
        osc.connect(gainNode);
        osc2.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        
        osc.start(audioCtx.currentTime + delay);
        osc2.start(audioCtx.currentTime + delay);
        osc.stop(audioCtx.currentTime + delay + 0.25);
        osc2.stop(audioCtx.currentTime + delay + 0.25);
      }
      
      // Bag rustle noise
      const bufferSize = audioCtx.sampleRate * 0.4;
      const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
      const output = noiseBuffer.getChannelData(0);
      for (let i = 0; i < bufferSize; i++) {
        output[i] = Math.random() * 2 - 1;
      }
      const noise = audioCtx.createBufferSource();
      noise.buffer = noiseBuffer;
      const noiseFilter = audioCtx.createBiquadFilter();
      noiseFilter.type = 'lowpass';
      noiseFilter.frequency.value = 600;
      const noiseGain = audioCtx.createGain();
      noiseGain.gain.setValueAtTime(0.1, audioCtx.currentTime);
      noiseGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.6);
      noise.connect(noiseFilter);
      noiseFilter.connect(noiseGain);
      noiseGain.connect(audioCtx.destination);
      noise.start();
    } catch (e) {
      console.log('Audio error:', e);
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError('');
    try {
      const data = await api('/auth/login', { method: 'POST', body: JSON.stringify({ username, password }) });
      localStorage.setItem('kassets_token', data.token);
      localStorage.setItem('kassets_user', JSON.stringify(data.user));
      playCoinSound();
      onLogin(data.user);
    } catch (err) {
      setError(err.message);
    }
    setLoading(false);
  };

  return (
    <div style={{ minHeight: '100vh', background: 'var(--gradient-primary)', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: 20, position: 'relative' }}>
      {/* Theme toggle on login page */}
      <button className="theme-toggle" onClick={toggleTheme} style={{ position: 'absolute', top: 20, right: 20 }} title={theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode'}>
        {theme === 'dark' ? '‚òÄÔ∏è' : 'üåô'}
      </button>
      <div style={{ background: 'var(--bg-card)', backdropFilter: 'blur(20px)', border: '1px solid var(--border-color)', borderRadius: 24, padding: 48, width: '100%', maxWidth: 420 }}>
        <div style={{ textAlign: 'center', marginBottom: 32 }}>
          <svg viewBox="0 0 400 400" width="80" height="80" style={{ marginBottom: 16 }}>
            <defs>
              <linearGradient id="lgGoldTop" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style={{stopColor:'#ffe566'}}/>
                <stop offset="50%" style={{stopColor:'#ffd700'}}/>
                <stop offset="100%" style={{stopColor:'#e6b800'}}/>
              </linearGradient>
              <linearGradient id="lgGoldSide" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" style={{stopColor:'#d4a000'}}/>
                <stop offset="50%" style={{stopColor:'#b8960b'}}/>
                <stop offset="100%" style={{stopColor:'#8b7000'}}/>
              </linearGradient>
              <linearGradient id="lgEmblemGold" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style={{stopColor:'#ffd700'}}/>
                <stop offset="25%" style={{stopColor:'#ffec80'}}/>
                <stop offset="50%" style={{stopColor:'#f4d03f'}}/>
                <stop offset="75%" style={{stopColor:'#d4a000'}}/>
                <stop offset="100%" style={{stopColor:'#b8860b'}}/>
              </linearGradient>
              <linearGradient id="lgEmblemEdge" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style={{stopColor:'#ffec80'}}/>
                <stop offset="50%" style={{stopColor:'#d4a000'}}/>
                <stop offset="100%" style={{stopColor:'#8b6914'}}/>
              </linearGradient>
              <linearGradient id="lgCoinFaceBg" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" style={{stopColor:'#2a2a35'}}/>
                <stop offset="50%" style={{stopColor:'#1a1a22'}}/>
                <stop offset="100%" style={{stopColor:'#12121a'}}/>
              </linearGradient>
              <linearGradient id="lgInnerRingGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style={{stopColor:'#ffd700'}}/>
                <stop offset="100%" style={{stopColor:'#b8860b'}}/>
              </linearGradient>
            </defs>
            <circle cx="200" cy="200" r="150" fill="url(#lgEmblemGold)"/>
            <circle cx="200" cy="200" r="150" fill="none" stroke="url(#lgEmblemEdge)" strokeWidth="8"/>
            <circle cx="200" cy="200" r="130" fill="url(#lgCoinFaceBg)"/>
            <circle cx="200" cy="200" r="130" fill="none" stroke="url(#lgInnerRingGrad)" strokeWidth="3"/>
            <g transform="translate(200, 210)">
              <g transform="translate(-60, 0)">
                {[0,1,2,3,4].map(i => (<g key={i}><ellipse cx="0" cy={24-i*8} rx="20" ry="8" fill="url(#lgGoldSide)"/><ellipse cx="0" cy={20-i*8} rx="20" ry="8" fill="url(#lgGoldTop)"/></g>))}
              </g>
              <g transform="translate(-20, -8)">
                {[0,1,2,3,4,5,6].map(i => (<g key={i}><ellipse cx="0" cy={24-i*8} rx="20" ry="8" fill="url(#lgGoldSide)"/><ellipse cx="0" cy={20-i*8} rx="20" ry="8" fill="url(#lgGoldTop)"/></g>))}
              </g>
              <g transform="translate(20, -16)">
                {[0,1,2,3,4,5,6,7,8].map(i => (<g key={i}><ellipse cx="0" cy={24-i*8} rx="20" ry="8" fill="url(#lgGoldSide)"/><ellipse cx="0" cy={20-i*8} rx="20" ry="8" fill="url(#lgGoldTop)"/></g>))}
              </g>
              <g transform="translate(60, -24)">
                {[0,1,2,3,4,5,6,7,8,9,10].map(i => (<g key={i}><ellipse cx="0" cy={24-i*8} rx="20" ry="8" fill="url(#lgGoldSide)"/><ellipse cx="0" cy={20-i*8} rx="20" ry="8" fill="url(#lgGoldTop)"/></g>))}
              </g>
            </g>
          </svg>
          <h1 style={{ fontSize: 32, fontWeight: 700, background: 'linear-gradient(135deg, #ffd700, #d4a000)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent', margin: 0 }}>KASSETS</h1>
          <p style={{ color: 'var(--text-muted)', marginTop: 8 }}>Asset Management System</p>
        </div>
        <form onSubmit={handleSubmit}>
          {error && <div style={{ background: 'rgba(239,68,68,0.1)', border: '1px solid rgba(239,68,68,0.3)', borderRadius: 12, padding: 12, marginBottom: 20, color: 'var(--accent-red)' }}>{error}</div>}
          <div style={{ marginBottom: 20 }}>
            <label style={{ display: 'block', marginBottom: 8, color: 'var(--text-secondary)', fontSize: 14 }}>Username</label>
            <input type="text" className="input-field" value={username} onChange={e => setUsername(e.target.value)} placeholder="Enter username" required />
          </div>
          <div style={{ marginBottom: 28 }}>
            <label style={{ display: 'block', marginBottom: 8, color: 'var(--text-secondary)', fontSize: 14 }}>Password</label>
            <input type="password" className="input-field" value={password} onChange={e => setPassword(e.target.value)} placeholder="Enter password" required />
          </div>
          <button type="submit" className="btn-gold" style={{ width: '100%', padding: 16, fontSize: 16 }} disabled={loading}>
            {loading ? 'Signing in...' : 'Sign In'}
          </button>
        </form>
      </div>
    </div>
  );
};

// User Management Modal
const UserManagement = ({ currentUser, onClose }) => {
  const [users, setUsers] = useState([]);
  const [showAdd, setShowAdd] = useState(false);
  const [newUser, setNewUser] = useState({ username: '', password: '', displayName: '', role: 'viewer' });
  const [editUser, setEditUser] = useState(null);

  useEffect(() => { loadUsers(); }, []);
  const loadUsers = async () => { try { setUsers(await api('/users')); } catch(e) { console.error(e); } };

  const handleAdd = async () => {
    if (!newUser.username || !newUser.password) return alert('Username and password required');
    try {
      await api('/users', { method: 'POST', body: JSON.stringify(newUser) });
      setShowAdd(false);
      setNewUser({ username: '', password: '', displayName: '', role: 'viewer' });
      loadUsers();
    } catch(e) { alert(e.message); }
  };

  const handleUpdate = async () => {
    try {
      await api('/users/' + editUser.id, { method: 'PUT', body: JSON.stringify({ displayName: editUser.display_name, email: editUser.email, role: editUser.role, isActive: editUser.is_active }) });
      setEditUser(null);
      loadUsers();
    } catch(e) { alert(e.message); }
  };

  const handleResetPw = async (id) => {
    const pw = prompt('New password (min 6 characters):');
    if (pw && pw.length >= 6) {
      try {
        await api('/users/' + id + '/reset-password', { method: 'POST', body: JSON.stringify({ newPassword: pw }) });
        alert('Password reset!');
      } catch(e) { alert(e.message); }
    }
  };

  const roleColors = { admin: { bg: 'rgba(239,68,68,0.2)', color: '#f87171' }, editor: { bg: 'rgba(59,130,246,0.2)', color: '#60a5fa' }, viewer: { bg: 'rgba(34,197,94,0.2)', color: '#4ade80' } };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content" onClick={e => e.stopPropagation()} style={{ maxWidth: 700 }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 24 }}>
          <h2 style={{ margin: 0 }}>üë• User Management</h2>
          <button className="btn-primary" onClick={() => setShowAdd(true)}>+ Add User</button>
        </div>
        <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
          {users.map(u => (
            <div key={u.id} style={{ background: 'rgba(30,41,59,0.5)', borderRadius: 12, padding: 16, display: 'flex', justifyContent: 'space-between', alignItems: 'center', opacity: u.is_active ? 1 : 0.5 }}>
              <div>
                <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                  <strong>{u.display_name || u.username}</strong>
                  <span style={{ padding: '4px 12px', borderRadius: 20, fontSize: 12, fontWeight: 600, ...roleColors[u.role] }}>{u.role.toUpperCase()}</span>
                  {!u.is_active && <span style={{ color: '#f87171', fontSize: 12 }}>INACTIVE</span>}
                </div>
                <p style={{ margin: '4px 0 0', fontSize: 13, color: '#64748b' }}>@{u.username}</p>
              </div>
              <div style={{ display: 'flex', gap: 8 }}>
                <button className="btn-secondary" style={{ padding: '8px 12px' }} onClick={() => setEditUser({...u})}>Edit</button>
                {u.id !== currentUser.id && <button className="btn-secondary" style={{ padding: '8px 12px' }} onClick={() => handleResetPw(u.id)}>Reset PW</button>}
              </div>
            </div>
          ))}
        </div>
        <div style={{ marginTop: 24, textAlign: 'right' }}><button className="btn-secondary" onClick={onClose}>Close</button></div>
        
        {showAdd && (
          <div className="modal-overlay" onClick={() => setShowAdd(false)}>
            <div className="modal-content" onClick={e => e.stopPropagation()} style={{ maxWidth: 400 }}>
              <h3 style={{ marginBottom: 20 }}>Add User</h3>
              <input className="input-field" placeholder="Username *" value={newUser.username} onChange={e => setNewUser({...newUser, username: e.target.value})} style={{ marginBottom: 12 }} />
              <input className="input-field" type="password" placeholder="Password *" value={newUser.password} onChange={e => setNewUser({...newUser, password: e.target.value})} style={{ marginBottom: 12 }} />
              <input className="input-field" placeholder="Display Name" value={newUser.displayName} onChange={e => setNewUser({...newUser, displayName: e.target.value})} style={{ marginBottom: 12 }} />
              <select className="input-field" value={newUser.role} onChange={e => setNewUser({...newUser, role: e.target.value})} style={{ marginBottom: 20 }}>
                <option value="viewer">Viewer (read-only)</option>
                <option value="editor">Editor (can edit)</option>
                <option value="admin">Admin (full access)</option>
              </select>
              <div style={{ display: 'flex', gap: 12, justifyContent: 'flex-end' }}>
                <button className="btn-secondary" onClick={() => setShowAdd(false)}>Cancel</button>
                <button className="btn-primary" onClick={handleAdd}>Add</button>
              </div>
            </div>
          </div>
        )}
        
        {editUser && (
          <div className="modal-overlay" onClick={() => setEditUser(null)}>
            <div className="modal-content" onClick={e => e.stopPropagation()} style={{ maxWidth: 400 }}>
              <h3 style={{ marginBottom: 20 }}>Edit: {editUser.username}</h3>
              <input className="input-field" placeholder="Display Name" value={editUser.display_name || ''} onChange={e => setEditUser({...editUser, display_name: e.target.value})} style={{ marginBottom: 12 }} />
              <select className="input-field" value={editUser.role} onChange={e => setEditUser({...editUser, role: e.target.value})} style={{ marginBottom: 12 }} disabled={editUser.id === currentUser.id}>
                <option value="viewer">Viewer</option>
                <option value="editor">Editor</option>
                <option value="admin">Admin</option>
              </select>
              {editUser.id !== currentUser.id && (
                <label style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 20, cursor: 'pointer' }}>
                  <input type="checkbox" checked={editUser.is_active} onChange={e => setEditUser({...editUser, is_active: e.target.checked ? 1 : 0})} />
                  Active (can log in)
                </label>
              )}
              <div style={{ display: 'flex', gap: 12, justifyContent: 'flex-end' }}>
                <button className="btn-secondary" onClick={() => setEditUser(null)}>Cancel</button>
                <button className="btn-primary" onClick={handleUpdate}>Save</button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};


// Main Asset Manager Component (with API integration)
const AssetManager = ({ user, onLogout }) => {
  const [assets, setAssets] = useState([]);
  const [locations, setLocations] = useState([]);
  const [categories, setCategories] = useState([]);
  const [companyName, setCompanyName] = useState('');
  const [activeTab, setActiveTab] = useState('dashboard');
  const [filterLocation, setFilterLocation] = useState('all');
  const [filterCategory, setFilterCategory] = useState('all');
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedAssets, setSelectedAssets] = useState([]);
  const [showAddAsset, setShowAddAsset] = useState(false);
  const [isAddingAsset, setIsAddingAsset] = useState(false);
  const [isUploadingPhotos, setIsUploadingPhotos] = useState(false);
  const [showAddLocation, setShowAddLocation] = useState(false);
  const [showSettings, setShowSettings] = useState(false);
  const [showUserMgmt, setShowUserMgmt] = useState(false);
  const [showManageCategories, setShowManageCategories] = useState(false);
  const [showBulkTransfer, setShowBulkTransfer] = useState(false);
  const [showBulkDelete, setShowBulkDelete] = useState(false);
  const [showBulkCategory, setShowBulkCategory] = useState(false);
  const [bulkTransferTo, setBulkTransferTo] = useState('');
  const [bulkCategoryTo, setBulkCategoryTo] = useState('');
  const [editingAsset, setEditingAsset] = useState(null);
  const [editingLocation, setEditingLocation] = useState(null);
  const [showNotesModal, setShowNotesModal] = useState(null);
  const [showPhotoViewer, setShowPhotoViewer] = useState(null);
  const [fullscreenPhoto, setFullscreenPhoto] = useState(null);
  const [newNote, setNewNote] = useState('');
  const [newCategory, setNewCategory] = useState('');
  const [editingCategory, setEditingCategory] = useState(null);
  const [editingCategoryName, setEditingCategoryName] = useState('');
  const [newAsset, setNewAsset] = useState({ name: '', category: '', purchaseDate: '', purchaseCost: 0, currentValue: 0, quantity: 1, locationId: '', description: '', serialNumber: '', partNumber: '', depreciationRate: 10, photos: [] });
  const [newLocation, setNewLocation] = useState({ name: '', address: '' });
  const [showChangePassword, setShowChangePassword] = useState(false);
  const [passwordData, setPasswordData] = useState({ current: '', new: '', confirm: '' });

  const canEdit = user && ['admin', 'editor'].includes(user.role);
  const isAdmin = user && user.role === 'admin';

  // Load data on mount
  useEffect(() => { loadAllData(); }, []);

  const loadAllData = async () => {
    try {
      const [assetsData, locsData, catsData, settings] = await Promise.all([
        api('/assets'), api('/locations'), api('/categories'), api('/settings')
      ]);
      setAssets(assetsData.map(a => ({
        id: a.id, name: a.name, category: a.category, serialNumber: a.serial_number, partNumber: a.part_number,
        description: a.description, purchaseDate: a.purchase_date, purchaseCost: a.purchase_cost,
        currentValue: a.current_value, quantity: a.quantity, depreciationRate: a.depreciation_rate,
        locationId: a.location_id, photos: a.photos || [], notes: a.notes || []
      })));
      setLocations(locsData.map(l => ({ id: l.id, name: l.name, address: l.address })));
      setCategories(catsData.map(c => c.name));
      setCompanyName(settings.company_name || '');
    } catch (e) { console.error('Load error:', e); }
  };

  // Helpers
  const formatCurrency = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount || 0);
  const getLocationName = (id) => locations.find(l => l.id === id)?.name || 'Unknown';
  
  const calculateTotals = () => {
    const filtered = filterLocation === 'all' ? assets : assets.filter(a => a.locationId === parseInt(filterLocation));
    return filtered.reduce((acc, a) => ({
      totalPurchaseCost: acc.totalPurchaseCost + (a.purchaseCost * a.quantity),
      totalCurrentValue: acc.totalCurrentValue + (a.currentValue * a.quantity),
      totalAssets: acc.totalAssets + a.quantity
    }), { totalPurchaseCost: 0, totalCurrentValue: 0, totalAssets: 0 });
  };

  const filteredAssets = assets.filter(a => {
    const matchLoc = filterLocation === 'all' || a.locationId === parseInt(filterLocation);
    const matchCat = filterCategory === 'all' || a.category === filterCategory;
    const matchSearch = a.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
      a.category?.toLowerCase().includes(searchTerm.toLowerCase()) ||
      a.serialNumber?.toLowerCase().includes(searchTerm.toLowerCase()) ||
      a.partNumber?.toLowerCase().includes(searchTerm.toLowerCase());
    return matchLoc && matchCat && matchSearch;
  }).sort((a, b) => a.name.localeCompare(b.name));

  // Asset CRUD
  const handleAddAsset = async () => {
    if (!newAsset.name) return alert('Name required');
    setIsAddingAsset(true);
    try {
      const assetData = {
        ...newAsset,
        purchaseCost: parseFloat(newAsset.purchaseCost) || 0,
        currentValue: parseFloat(newAsset.currentValue) || 0,
        quantity: parseInt(newAsset.quantity) || 1
      };
      delete assetData.photos; // Remove photos from asset data, we'll add them separately
      
      const result = await api('/assets', { method: 'POST', body: JSON.stringify(assetData) });
      
      // Upload photos if any were added (in parallel for speed)
      if (newAsset.photos?.length > 0) {
        await Promise.all(newAsset.photos.map(photo => 
          api('/assets/' + result.id + '/photos', { method: 'POST', body: JSON.stringify({ url: photo.url, name: photo.name }) })
        ));
      }
      
      await loadAllData();
      setShowAddAsset(false);
      setIsAddingAsset(false);
      setNewAsset({ name: '', category: '', purchaseDate: '', purchaseCost: 0, currentValue: 0, quantity: 1, locationId: '', description: '', serialNumber: '', partNumber: '', depreciationRate: 10, photos: [] });
    } catch (e) { 
      setIsAddingAsset(false);
      alert(e.message); 
    }
  };

  const handleUpdateAsset = async () => {
    try {
      // Find original asset to compare changes
      const originalAsset = assets.find(a => a.id === editingAsset.id);
      const autoNotes = [];
      const now = new Date();
      const timestamp = now.toLocaleString('en-US', { 
        year: 'numeric', month: 'short', day: 'numeric', 
        hour: '2-digit', minute: '2-digit' 
      });
      const userName = user.displayName || user.username;
      
      // Check for quantity change
      const oldQty = originalAsset ? parseInt(originalAsset.quantity) || 0 : 0;
      const newQty = parseInt(editingAsset.quantity) || 0;
      if (originalAsset && oldQty !== newQty) {
        const diff = newQty - oldQty;
        const noteText = diff < 0 
          ? `üì¶ QUANTITY DEDUCTED: ${Math.abs(diff)} unit(s) removed (${oldQty} ‚Üí ${newQty}) by ${userName} on ${timestamp}`
          : `üì¶ QUANTITY ADDED: ${diff} unit(s) added (${oldQty} ‚Üí ${newQty}) by ${userName} on ${timestamp}`;
        autoNotes.push(noteText);
      }
      
      // Check for location change
      const oldLocId = originalAsset ? (originalAsset.locationId || null) : null;
      const newLocId = editingAsset.locationId || null;
      if (originalAsset && String(oldLocId) !== String(newLocId)) {
        const oldLocation = locations.find(l => l.id === oldLocId)?.name || 'Unknown';
        const newLocation = locations.find(l => l.id === parseInt(newLocId))?.name || 'Unknown';
        const noteText = `üìç LOCATION CHANGED: Moved from "${oldLocation}" to "${newLocation}" by ${userName} on ${timestamp}`;
        autoNotes.push(noteText);
      }
      
      // Update the asset first
      await api('/assets/' + editingAsset.id, { method: 'PUT', body: JSON.stringify({
        name: editingAsset.name, category: editingAsset.category, serialNumber: editingAsset.serialNumber, partNumber: editingAsset.partNumber,
        description: editingAsset.description, purchaseDate: editingAsset.purchaseDate,
        purchaseCost: editingAsset.purchaseCost, currentValue: editingAsset.currentValue,
        quantity: editingAsset.quantity, depreciationRate: editingAsset.depreciationRate,
        locationId: editingAsset.locationId
      })});
      
      // Add automatic notes if there were changes
      for (const noteText of autoNotes) {
        if (noteText && noteText.trim()) {
          await api('/assets/' + editingAsset.id + '/notes', { method: 'POST', body: JSON.stringify({ text: noteText }) });
        }
      }
      
      setEditingAsset(null);
      loadAllData();
    } catch (e) { alert(e.message); }
  };

  const handleDeleteAsset = async (id) => {
    if (!confirm('Delete this asset?')) return;
    try {
      await api('/assets/' + id, { method: 'DELETE' });
      loadAllData();
    } catch (e) { alert(e.message); }
  };

  const handleDuplicateAsset = async (asset) => {
    try {
      const newAssetData = {
        name: asset.name + ' (Copy)',
        category: asset.category,
        serialNumber: '',
        partNumber: asset.partNumber,
        description: asset.description,
        purchaseDate: asset.purchaseDate,
        purchaseCost: asset.purchaseCost,
        currentValue: asset.currentValue,
        quantity: asset.quantity,
        depreciationRate: asset.depreciationRate,
        locationId: asset.locationId
      };
      await api('/assets', { method: 'POST', body: JSON.stringify(newAssetData) });
      loadAllData();
    } catch (e) { alert(e.message); }
  };

  const handleDeletePhoto = async (assetId, photoId) => {
    if (!confirm('Delete this photo?')) return;
    try {
      await api('/assets/' + assetId + '/photos/' + photoId, { method: 'DELETE' });
      loadAllData();
      if (editingAsset) {
        const updated = (await api('/assets')).find(a => a.id === assetId);
        if (updated) setEditingAsset({ ...editingAsset, photos: updated.photos || [] });
      }
    } catch (e) { alert(e.message); }
  };

  const handleBulkTransfer = async () => {
    if (!bulkTransferTo) return;
    try {
      await api('/assets/bulk-transfer', { method: 'POST', body: JSON.stringify({ assetIds: selectedAssets, locationId: parseInt(bulkTransferTo) }) });
      setShowBulkTransfer(false);
      setSelectedAssets([]);
      setBulkTransferTo('');
      loadAllData();
    } catch (e) { alert(e.message); }
  };

  const handleBulkCategory = async () => {
    if (!bulkCategoryTo) return;
    try {
      await api('/assets/bulk-category', { method: 'POST', body: JSON.stringify({ assetIds: selectedAssets, category: bulkCategoryTo }) });
      setShowBulkCategory(false);
      setSelectedAssets([]);
      setBulkCategoryTo('');
      loadAllData();
    } catch (e) { alert(e.message); }
  };

  const handleBulkDelete = async () => {
    try {
      await api('/assets/bulk-delete', { method: 'POST', body: JSON.stringify({ assetIds: selectedAssets }) });
      setShowBulkDelete(false);
      setSelectedAssets([]);
      loadAllData();
    } catch (e) { alert(e.message); }
  };

  // Location CRUD
  const handleAddLocation = async () => {
    if (!newLocation.name) return;
    try {
      await api('/locations', { method: 'POST', body: JSON.stringify(newLocation) });
      setShowAddLocation(false);
      setNewLocation({ name: '', address: '' });
      loadAllData();
    } catch (e) { alert(e.message); }
  };

  const handleUpdateLocation = async () => {
    try {
      await api('/locations/' + editingLocation.id, { method: 'PUT', body: JSON.stringify(editingLocation) });
      setEditingLocation(null);
      loadAllData();
    } catch (e) { alert(e.message); }
  };

  const handleDeleteLocation = async (id) => {
    try {
      await api('/locations/' + id, { method: 'DELETE' });
      loadAllData();
    } catch (e) { alert(e.message); }
  };

  // Category CRUD
  const handleAddCategory = async () => {
    if (!newCategory.trim() || categories.includes(newCategory.trim())) return;
    try {
      await api('/categories', { method: 'POST', body: JSON.stringify({ name: newCategory.trim() }) });
      setNewCategory('');
      loadAllData();
    } catch (e) { alert(e.message); }
  };

  const handleRenameCategory = async () => {
    if (!editingCategoryName.trim() || editingCategoryName === editingCategory) {
      setEditingCategory(null);
      return;
    }
    try {
      await api('/categories/rename', { method: 'POST', body: JSON.stringify({ oldName: editingCategory, newName: editingCategoryName.trim() }) });
      setEditingCategory(null);
      setEditingCategoryName('');
      loadAllData();
    } catch (e) { alert(e.message); }
  };

  const handleDeleteCategory = async (catName) => {
    const cat = await api('/categories');
    const found = cat.find(c => c.name === catName);
    if (found) {
      try {
        await api('/categories/' + found.id, { method: 'DELETE' });
        loadAllData();
      } catch (e) { alert(e.message); }
    }
  };

  // Settings
  const handleSaveSettings = async () => {
    try {
      await api('/settings', { method: 'PUT', body: JSON.stringify({ companyName }) });
      setShowSettings(false);
    } catch (e) { alert(e.message); }
  };

  const handleChangePassword = async () => {
    if (!passwordData.current || !passwordData.new || !passwordData.confirm) {
      return alert('Please fill in all fields');
    }
    if (passwordData.new !== passwordData.confirm) {
      return alert('New passwords do not match');
    }
    if (passwordData.new.length < 6) {
      return alert('New password must be at least 6 characters');
    }
    try {
      await api('/auth/change-password', { method: 'POST', body: JSON.stringify({ currentPassword: passwordData.current, newPassword: passwordData.new }) });
      alert('Password changed successfully!');
      setShowChangePassword(false);
      setPasswordData({ current: '', new: '', confirm: '' });
    } catch (e) { alert(e.message); }
  };

  // Notes
  const handleAddNote = async () => {
    if (!newNote.trim() || !showNotesModal) return;
    try {
      await api('/assets/' + showNotesModal.id + '/notes', { method: 'POST', body: JSON.stringify({ text: newNote }) });
      setNewNote('');
      loadAllData();
      const updated = (await api('/assets')).find(a => a.id === showNotesModal.id);
      if (updated) setShowNotesModal({ ...showNotesModal, notes: updated.notes || [] });
    } catch (e) { alert(e.message); }
  };

  const handleDeleteNote = async (noteId) => {
    try {
      await api('/assets/' + showNotesModal.id + '/notes/' + noteId, { method: 'DELETE' });
      loadAllData();
      const updated = (await api('/assets')).find(a => a.id === showNotesModal.id);
      if (updated) setShowNotesModal({ ...showNotesModal, notes: updated.notes || [] });
    } catch (e) { alert(e.message); }
  };

  // Photos
  const handlePhotoUpload = async (e, assetId) => {
    const files = Array.from(e.target.files);
    if (!files.length) return;
    
    const currentPhotos = editingAsset?.photos?.length || 0;
    const maxAllowed = 5 - currentPhotos;
    const filesToUpload = files.slice(0, maxAllowed);
    
    if (files.length > maxAllowed) {
      alert(`Only uploading ${maxAllowed} photo(s). Maximum 5 photos per asset.`);
    }
    
    setIsUploadingPhotos(true);
    
    // Compress image function
    const compressImage = (file, maxWidth = 800, quality = 0.7) => {
      return new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = (ev) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            resolve(canvas.toDataURL('image/jpeg', quality));
          };
          img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
      });
    };
    
    try {
      // Compress and upload all photos in parallel
      await Promise.all(filesToUpload.map(async (file) => {
        const compressedUrl = await compressImage(file);
        await api('/assets/' + assetId + '/photos', { method: 'POST', body: JSON.stringify({ url: compressedUrl, name: file.name }) });
      }));
      
      await loadAllData();
      if (editingAsset) {
        const updated = (await api('/assets')).find(a => a.id === assetId);
        if (updated) setEditingAsset({ ...editingAsset, photos: updated.photos || [] });
      }
    } catch (err) {
      alert('Photo upload failed. Please try again.');
    }
    
    setIsUploadingPhotos(false);
    e.target.value = ''; // Reset input
  };

  // Selection
  const toggleSelectAsset = (id) => setSelectedAssets(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
  const selectAllFiltered = () => setSelectedAssets(selectedAssets.length === filteredAssets.length ? [] : filteredAssets.map(a => a.id));

  const totals = calculateTotals();


  const { theme, toggleTheme } = useTheme();

  return (
    <div style={{ minHeight: '100vh', background: 'var(--gradient-primary)' }}>
      {/* Header */}
      <header style={{ padding: '16px 24px', borderBottom: '1px solid var(--border-color)', display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: 12 }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
          <svg viewBox="0 0 400 400" width="56" height="56">
            <defs>
              <linearGradient id="goldTop" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style={{stopColor:'#ffe566'}}/>
                <stop offset="50%" style={{stopColor:'#ffd700'}}/>
                <stop offset="100%" style={{stopColor:'#e6b800'}}/>
              </linearGradient>
              <linearGradient id="goldSide" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" style={{stopColor:'#d4a000'}}/>
                <stop offset="50%" style={{stopColor:'#b8960b'}}/>
                <stop offset="100%" style={{stopColor:'#8b7000'}}/>
              </linearGradient>
              <linearGradient id="emblemGold" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style={{stopColor:'#ffd700'}}/>
                <stop offset="25%" style={{stopColor:'#ffec80'}}/>
                <stop offset="50%" style={{stopColor:'#f4d03f'}}/>
                <stop offset="75%" style={{stopColor:'#d4a000'}}/>
                <stop offset="100%" style={{stopColor:'#b8860b'}}/>
              </linearGradient>
              <linearGradient id="emblemEdge" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style={{stopColor:'#ffec80'}}/>
                <stop offset="50%" style={{stopColor:'#d4a000'}}/>
                <stop offset="100%" style={{stopColor:'#8b6914'}}/>
              </linearGradient>
              <linearGradient id="coinFaceBg" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" style={{stopColor:'#2a2a35'}}/>
                <stop offset="50%" style={{stopColor:'#1a1a22'}}/>
                <stop offset="100%" style={{stopColor:'#12121a'}}/>
              </linearGradient>
              <linearGradient id="innerRingGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style={{stopColor:'#ffd700'}}/>
                <stop offset="100%" style={{stopColor:'#b8860b'}}/>
              </linearGradient>
            </defs>
            <circle cx="200" cy="200" r="150" fill="url(#emblemGold)"/>
            <circle cx="200" cy="200" r="150" fill="none" stroke="url(#emblemEdge)" strokeWidth="8"/>
            <circle cx="200" cy="200" r="130" fill="url(#coinFaceBg)"/>
            <circle cx="200" cy="200" r="130" fill="none" stroke="url(#innerRingGrad)" strokeWidth="3"/>
            <g transform="translate(200, 210)">
              <g transform="translate(-60, 0)">
                {[0,1,2,3,4].map(i => (<g key={i}><ellipse cx="0" cy={24-i*8} rx="20" ry="8" fill="url(#goldSide)"/><ellipse cx="0" cy={20-i*8} rx="20" ry="8" fill="url(#goldTop)"/></g>))}
              </g>
              <g transform="translate(-20, -8)">
                {[0,1,2,3,4,5,6].map(i => (<g key={i}><ellipse cx="0" cy={24-i*8} rx="20" ry="8" fill="url(#goldSide)"/><ellipse cx="0" cy={20-i*8} rx="20" ry="8" fill="url(#goldTop)"/></g>))}
              </g>
              <g transform="translate(20, -16)">
                {[0,1,2,3,4,5,6,7,8].map(i => (<g key={i}><ellipse cx="0" cy={24-i*8} rx="20" ry="8" fill="url(#goldSide)"/><ellipse cx="0" cy={20-i*8} rx="20" ry="8" fill="url(#goldTop)"/></g>))}
              </g>
              <g transform="translate(60, -24)">
                {[0,1,2,3,4,5,6,7,8,9,10].map(i => (<g key={i}><ellipse cx="0" cy={24-i*8} rx="20" ry="8" fill="url(#goldSide)"/><ellipse cx="0" cy={20-i*8} rx="20" ry="8" fill="url(#goldTop)"/></g>))}
              </g>
            </g>
          </svg>
          <div>
            <h1 style={{ fontSize: 22, fontWeight: 700, margin: 0, background: 'linear-gradient(135deg, #ffd700, #d4a000)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' }}>{companyName || 'KASSETS'}</h1>
            <p style={{ margin: 0, fontSize: 11, color: 'var(--text-muted)' }}>Asset Management</p>
          </div>
        </div>
        <div style={{ display: 'flex', gap: 8, alignItems: 'center', flexWrap: 'wrap' }} className="header-buttons">
          <span style={{ color: 'var(--text-muted)', fontSize: 13 }} className="hide-mobile">üë§ {user.displayName || user.username}</span>
          <span className="category-badge">{user.role}</span>
          <button className="theme-toggle" onClick={toggleTheme} title={theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode'}>
            {theme === 'dark' ? '‚òÄÔ∏è' : 'üåô'}
          </button>
          {isAdmin && <button className="btn-secondary" style={{ padding: '8px 12px', fontSize: 12 }} onClick={() => setShowUserMgmt(true)}>Users</button>}
          <button className="btn-secondary" style={{ padding: '8px 12px', fontSize: 12 }} onClick={() => setShowSettings(true)}>‚öôÔ∏è</button>
          {canEdit && <button className="btn-secondary hide-mobile" style={{ padding: '8px 12px', fontSize: 12 }} onClick={() => setShowManageCategories(true)}>Categories</button>}
          {canEdit && <button className="btn-secondary hide-mobile" style={{ padding: '8px 12px', fontSize: 12 }} onClick={() => setShowAddLocation(true)}>+ Location</button>}
          {canEdit && <button className="btn-primary" style={{ padding: '8px 16px', fontSize: 12 }} onClick={() => setShowAddAsset(true)}>+ Asset</button>}
          <button className="btn-danger" style={{ padding: '8px 12px', fontSize: 12 }} onClick={onLogout}>Logout</button>
        </div>
      </header>

      {/* Tabs */}
      <nav style={{ padding: '0 24px', borderBottom: '1px solid var(--border-color)', display: 'flex', gap: 4, overflowX: 'auto' }}>
        {(isAdmin ? ['dashboard', 'assets', 'locations', 'balance-sheet'] : ['dashboard', 'assets', 'locations']).map(tab => (
          <button key={tab} className={`tab-btn ${activeTab === tab ? 'active' : ''}`} onClick={() => setActiveTab(tab)}>
            {tab.charAt(0).toUpperCase() + tab.slice(1).replace('-', ' ')}
          </button>
        ))}
      </nav>

      {/* Content */}
      <main style={{ padding: 24 }}>
        {/* Dashboard Tab */}
        {activeTab === 'dashboard' && (
          <div>
            {/* Stats Cards */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: 16, marginBottom: 32 }} className="stat-grid">
              <div className="stat-card">
                <p style={{ color: 'var(--text-secondary)', fontSize: 13, marginBottom: 8 }}>Total Assets</p>
                <p style={{ fontSize: 28, fontWeight: 700, fontFamily: "'JetBrains Mono', monospace", color: 'var(--text-primary)' }}>{totals.totalAssets}</p>
                <p style={{ color: 'var(--text-muted)', fontSize: 12, marginTop: 8 }}>{locations.length} locations ‚Ä¢ {categories.filter(c => assets.some(a => a.category === c)).length} categories</p>
              </div>
              {isAdmin && (
                <>
                  <div className="stat-card" style={{ borderLeft: '4px solid var(--accent-green)' }}>
                    <p style={{ color: 'var(--text-secondary)', fontSize: 13, marginBottom: 8 }}>Current Value</p>
                    <p style={{ fontSize: 24, fontWeight: 700, fontFamily: "'JetBrains Mono', monospace", color: 'var(--accent-green)' }}>{formatCurrency(totals.totalCurrentValue)}</p>
                  </div>
                  <div className="stat-card">
                    <p style={{ color: 'var(--text-secondary)', fontSize: 13, marginBottom: 8 }}>Purchase Cost</p>
                    <p style={{ fontSize: 24, fontWeight: 700, fontFamily: "'JetBrains Mono', monospace", color: 'var(--text-primary)' }}>{formatCurrency(totals.totalPurchaseCost)}</p>
                  </div>
                  <div className="stat-card" style={{ borderLeft: `4px solid ${totals.totalPurchaseCost - totals.totalCurrentValue > 0 ? 'var(--accent-red)' : 'var(--accent-green)'}` }}>
                    <p style={{ color: 'var(--text-secondary)', fontSize: 13, marginBottom: 8 }}>Depreciation</p>
                    <p style={{ fontSize: 24, fontWeight: 700, fontFamily: "'JetBrains Mono', monospace", color: totals.totalPurchaseCost - totals.totalCurrentValue > 0 ? 'var(--accent-red)' : 'var(--accent-green)' }}>
                      {totals.totalPurchaseCost - totals.totalCurrentValue > 0 ? '-' : '+'}{formatCurrency(Math.abs(totals.totalPurchaseCost - totals.totalCurrentValue))}
                    </p>
                  </div>
                </>
              )}
            </div>

            {/* Charts Section */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(320px, 1fr))', gap: 20, marginBottom: 32 }}>
              {/* Asset Count by Category Chart */}
              <BarChart
                title="Assets by Category"
                colorScheme="mixed"
                data={categories.map(cat => {
                  const count = assets.filter(a => a.category === cat).reduce((s, a) => s + a.quantity, 0);
                  return { label: cat, value: count, displayValue: count };
                }).filter(d => d.value > 0).sort((a, b) => b.value - a.value)}
              />

              {/* Asset Count by Location Chart */}
              <BarChart
                title="Assets by Location"
                colorScheme="green"
                data={locations.map(loc => {
                  const count = assets.filter(a => a.locationId === loc.id).reduce((s, a) => s + a.quantity, 0);
                  return { label: loc.name, value: count, displayValue: count };
                }).sort((a, b) => b.value - a.value)}
              />
            </div>

            {/* Donut Charts for Admin */}
            {isAdmin && (
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: 20, marginBottom: 32 }}>
                <DonutChart
                  title="Value Distribution by Category"
                  data={categories.map(cat => {
                    const value = assets.filter(a => a.category === cat).reduce((s, a) => s + (a.currentValue || 0) * (a.quantity || 1), 0);
                    return { label: cat, value, displayValue: formatCurrency(value) };
                  }).filter(d => d.value > 0).sort((a, b) => b.value - a.value).slice(0, 6)}
                />

                <DonutChart
                  title="Value Distribution by Location"
                  data={locations.map(loc => {
                    const value = assets.filter(a => a.locationId === loc.id).reduce((s, a) => s + (a.currentValue || 0) * (a.quantity || 1), 0);
                    return { label: loc.name, value, displayValue: formatCurrency(value) };
                  }).filter(d => d.value > 0).sort((a, b) => b.value - a.value)}
                />
              </div>
            )}

            {/* Detailed Lists */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: 20 }}>
              <div className="glass-card" style={{ padding: 24 }}>
                <h3 style={{ marginBottom: 16, color: 'var(--text-primary)' }}>Category Summary</h3>
                {categories.map(cat => {
                  const catAssets = assets.filter(a => a.category === cat);
                  const catValue = catAssets.reduce((s, a) => s + (a.currentValue || 0) * (a.quantity || 1), 0);
                  const catCount = catAssets.reduce((s, a) => s + (a.quantity || 1), 0);
                  if (catAssets.length === 0) return null;
                  return (
                    <div key={cat} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '10px 0', borderBottom: '1px solid var(--border-color)' }}>
                      <div>
                        <span style={{ color: 'var(--text-primary)' }}>{cat}</span>
                        <span style={{ color: 'var(--text-muted)', fontSize: 12, marginLeft: 8 }}>{catCount} items</span>
                      </div>
                      {isAdmin && <span style={{ fontFamily: "'JetBrains Mono', monospace", color: 'var(--accent-green)', fontSize: 14 }}>{formatCurrency(catValue)}</span>}
                    </div>
                  );
                })}
              </div>
              <div className="glass-card" style={{ padding: 24 }}>
                <h3 style={{ marginBottom: 16, color: 'var(--text-primary)' }}>Location Summary</h3>
                {locations.map(loc => {
                  const locAssets = assets.filter(a => a.locationId === loc.id);
                  const locValue = locAssets.reduce((s, a) => s + (a.currentValue || 0) * (a.quantity || 1), 0);
                  const locCount = locAssets.reduce((s, a) => s + (a.quantity || 1), 0);
                  return (
                    <div key={loc.id} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '10px 0', borderBottom: '1px solid var(--border-color)' }}>
                      <div>
                        <span style={{ color: 'var(--text-primary)' }}>{loc.name}</span>
                        <span style={{ color: 'var(--text-muted)', fontSize: 12, marginLeft: 8 }}>{locCount} items</span>
                      </div>
                      {isAdmin && <span style={{ fontFamily: "'JetBrains Mono', monospace", color: 'var(--accent-green)', fontSize: 14 }}>{formatCurrency(locValue)}</span>}
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        )}

        {/* Assets Tab */}
        {activeTab === 'assets' && (
          <div>
            <div style={{ display: 'flex', gap: 12, marginBottom: 16, flexWrap: 'wrap', alignItems: 'center' }}>
              <input type="text" className="input-field" placeholder="Search assets..." style={{ maxWidth: 250 }} value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
              <select className="input-field" style={{ maxWidth: 180 }} value={filterLocation} onChange={e => { setFilterLocation(e.target.value); setSelectedAssets([]); }}>
                <option value="all">All Locations</option>
                {locations.map(l => <option key={l.id} value={l.id}>{l.name}</option>)}
              </select>
              <select className="input-field" style={{ maxWidth: 180 }} value={filterCategory} onChange={e => { setFilterCategory(e.target.value); setSelectedAssets([]); }}>
                <option value="all">All Categories</option>
                {categories.map(c => <option key={c} value={c}>{c}</option>)}
              </select>
              {canEdit && filteredAssets.length > 0 && (
                <button className="btn-secondary" style={{ padding: '10px 16px' }} onClick={selectAllFiltered}>
                  {selectedAssets.length === filteredAssets.length ? '‚òë Deselect All' : '‚òê Select All'}
                </button>
              )}
            </div>
            
            {canEdit && selectedAssets.length > 0 && (
              <div style={{ display: 'flex', gap: 12, padding: 16, marginBottom: 16, background: 'linear-gradient(135deg, rgba(59,130,246,0.2), rgba(30,41,59,0.9))', borderRadius: 12, alignItems: 'center', flexWrap: 'wrap' }}>
                <span style={{ fontWeight: 600 }}>{selectedAssets.length} selected</span>
                <button className="btn-primary" style={{ padding: '8px 16px' }} onClick={() => setShowBulkTransfer(true)}>üìç Move</button>
                <button className="btn-primary" style={{ padding: '8px 16px', background: 'linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%)' }} onClick={() => setShowBulkCategory(true)}>üè∑Ô∏è Category</button>
                <button className="btn-danger" style={{ padding: '8px 16px' }} onClick={() => setShowBulkDelete(true)}>üóëÔ∏è Delete</button>
                <button className="btn-secondary" style={{ padding: '8px 16px' }} onClick={() => setSelectedAssets([])}>Clear</button>
              </div>
            )}
            
            <div style={{ maxHeight: 'calc(100vh - 320px)', overflowY: 'auto' }}>
              {filteredAssets.length === 0 ? (
                <div className="glass-card" style={{ padding: 40, textAlign: 'center' }}><p style={{ color: '#64748b' }}>No assets found</p></div>
              ) : filteredAssets.map(asset => (
                <div key={asset.id} className={`asset-row ${selectedAssets.includes(asset.id) ? 'selected' : ''}`}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: 12 }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: 12, flex: 1, minWidth: 200 }}>
                      {canEdit && (
                        <div onClick={() => toggleSelectAsset(asset.id)} style={{ width: 22, height: 22, borderRadius: 6, border: selectedAssets.includes(asset.id) ? '2px solid #3b82f6' : '2px solid #475569', background: selectedAssets.includes(asset.id) ? '#3b82f6' : 'transparent', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0 }}>
                          {selectedAssets.includes(asset.id) && <span style={{ color: 'white', fontSize: 12 }}>‚úì</span>}
                        </div>
                      )}
                      {/* Photo thumbnail preview */}
                      {asset.photos?.length > 0 ? (
                        <img 
                          src={asset.photos[0].url} 
                          onClick={() => setShowPhotoViewer(asset)}
                          style={{ width: 50, height: 50, objectFit: 'cover', borderRadius: 8, cursor: 'pointer', flexShrink: 0, border: '2px solid rgba(148,163,184,0.2)' }} 
                        />
                      ) : (
                        <div style={{ width: 50, height: 50, borderRadius: 8, background: 'rgba(148,163,184,0.1)', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0, border: '2px solid rgba(148,163,184,0.1)' }}>
                          <span style={{ fontSize: 20, opacity: 0.3 }}>üì∑</span>
                        </div>
                      )}
                      <div>
                        <h4 style={{ margin: 0, fontSize: 15 }}>{asset.name}</h4>
                        <p style={{ margin: '4px 0 0', fontSize: 12, color: '#64748b' }}>{asset.partNumber && `P/N: ${asset.partNumber} ‚Ä¢ `}{asset.serialNumber && `SN: ${asset.serialNumber} ‚Ä¢ `}Qty: {asset.quantity}{asset.description && ` ‚Ä¢ ${asset.description}`}</p>
                      </div>
                    </div>
                    <div style={{ display: 'flex', gap: 6, alignItems: 'center', flexWrap: 'wrap' }}>
                      <span className="category-badge">{asset.category}</span>
                      <span className="location-badge">{getLocationName(asset.locationId)}</span>
                      {isAdmin && <span style={{ fontFamily: "'JetBrains Mono', monospace", color: '#34d399', minWidth: 80, textAlign: 'right', fontSize: 13 }}>{formatCurrency(asset.currentValue * asset.quantity)}</span>}
                      {asset.photos?.length > 1 && <button className="btn-secondary" style={{ padding: '5px 10px', fontSize: 11 }} onClick={() => setShowPhotoViewer(asset)}>+{asset.photos.length - 1} more</button>}
                      <button className="btn-secondary" style={{ padding: '5px 10px', fontSize: 11, background: asset.notes?.length ? 'rgba(251,191,36,0.2)' : undefined }} onClick={() => setShowNotesModal(asset)}>üìù {asset.notes?.length || ''}</button>
                      {canEdit && <button className="btn-secondary" style={{ padding: '5px 10px', fontSize: 11 }} onClick={() => handleDuplicateAsset(asset)}>üìã Copy</button>}
                      {canEdit && <button className="btn-secondary" style={{ padding: '5px 10px', fontSize: 11 }} onClick={() => setEditingAsset({...asset})}>Edit</button>}
                      {canEdit && <button className="btn-danger" style={{ padding: '5px 10px', fontSize: 11 }} onClick={() => handleDeleteAsset(asset.id)}>Delete</button>}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Locations Tab */}
        {activeTab === 'locations' && (
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: 20 }}>
            {locations.map(loc => {
              const locAssets = assets.filter(a => a.locationId === loc.id);
              const locValue = locAssets.reduce((s, a) => s + (a.currentValue || 0) * (a.quantity || 1), 0);
              return (
                <div key={loc.id} className="glass-card" style={{ padding: 24 }}>
                  <h3 style={{ margin: '0 0 8px' }}>{loc.name}</h3>
                  <p style={{ color: '#64748b', fontSize: 13, margin: '0 0 16px' }}>{loc.address || 'No address'}</p>
                  <div style={{ display: 'grid', gridTemplateColumns: isAdmin ? '1fr 1fr' : '1fr', gap: 12, marginBottom: 16 }}>
                    <div style={{ background: 'rgba(15,23,42,0.5)', borderRadius: 10, padding: 12 }}>
                      <p style={{ color: '#64748b', fontSize: 11, margin: 0 }}>Assets</p>
                      <p style={{ fontSize: 22, fontWeight: 700, margin: '4px 0 0' }}>{locAssets.length}</p>
                    </div>
                    {isAdmin && (
                      <div style={{ background: 'rgba(15,23,42,0.5)', borderRadius: 10, padding: 12 }}>
                        <p style={{ color: '#64748b', fontSize: 11, margin: 0 }}>Value</p>
                        <p style={{ fontSize: 16, fontWeight: 700, margin: '4px 0 0', color: '#34d399', fontFamily: "'JetBrains Mono', monospace" }}>{formatCurrency(locValue)}</p>
                      </div>
                    )}
                  </div>
                  {canEdit && (
                    <div style={{ display: 'flex', gap: 8 }}>
                      <button className="btn-secondary" style={{ flex: 1, padding: '10px 16px' }} onClick={() => setEditingLocation({...loc})}>Edit</button>
                      <button className="btn-danger" style={{ flex: 1, padding: '10px 16px' }} onClick={() => handleDeleteLocation(loc.id)}>Delete</button>
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        )}

        {/* Balance Sheet Tab */}
        {activeTab === 'balance-sheet' && (
          <div className="glass-card" style={{ padding: 32 }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 24, flexWrap: 'wrap', gap: 12 }}>
              <div>
                <h2 style={{ margin: 0 }}>{companyName || 'Kassets'} - Balance Sheet</h2>
                <p style={{ color: '#64748b', marginTop: 4 }}>{new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
              </div>
              <button className="btn-gold" onClick={() => {
                // Generate professional PDF balance sheet
                const categoryStats = categories.map(cat => {
                  const catAssets = assets.filter(a => a.category === cat);
                  if (catAssets.length === 0) return null;
                  const count = catAssets.reduce((s, a) => s + a.quantity, 0);
                  const cost = catAssets.reduce((s, a) => s + a.purchaseCost * a.quantity, 0);
                  const value = catAssets.reduce((s, a) => s + a.currentValue * a.quantity, 0);
                  return { name: cat, count, cost, value, depreciation: cost - value };
                }).filter(Boolean);
                
                const locationStats = locations.map(loc => {
                  const locAssets = assets.filter(a => a.locationId === loc.id);
                  const count = locAssets.reduce((s, a) => s + a.quantity, 0);
                  const cost = locAssets.reduce((s, a) => s + a.purchaseCost * a.quantity, 0);
                  const value = locAssets.reduce((s, a) => s + a.currentValue * a.quantity, 0);
                  const pct = totals.totalCurrentValue > 0 ? ((value / totals.totalCurrentValue) * 100).toFixed(1) : '0.0';
                  return { name: loc.name, count, cost, value, pct };
                }).sort((a, b) => a.name.localeCompare(b.name));
                
                const sortedAssets = [...assets].sort((a, b) => a.name.localeCompare(b.name));
                
                const html = `<!DOCTYPE html><html><head><title>Kassets Balance Sheet</title><style>
                  *{box-sizing:border-box;margin:0;padding:0}
                  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;padding:40px;color:#1a1a2e;background:white}
                  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;padding-bottom:20px;border-bottom:3px solid #ffd700}
                  .header-left{display:flex;align-items:center;gap:16px}
                  .logo-text{font-size:28px;font-weight:800;color:#1a1a2e}
                  .date{color:#666;font-size:14px}
                  h1{font-size:24px;margin-bottom:5px}
                  h2{font-size:18px;margin:25px 0 15px 0;color:#1a1a2e;border-bottom:2px solid #ffd700;padding-bottom:8px}
                  .summary-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:30px}
                  .summary-box{background:#f8f9fa;padding:20px;border-radius:8px;border-left:4px solid #ffd700}
                  .summary-label{font-size:12px;color:#666;text-transform:uppercase}
                  .summary-value{font-size:24px;font-weight:700;margin-top:5px}
                  .summary-value.green{color:#22c55e}
                  .summary-value.red{color:#ef4444}
                  table{width:100%;border-collapse:collapse;margin-bottom:30px}
                  th{background:#1a1a2e;color:white;padding:12px;text-align:left;font-size:12px;text-transform:uppercase}
                  td{padding:12px;border-bottom:1px solid #eee;font-size:14px}
                  tr:hover{background:#f8f9fa}
                  .text-right{text-align:right}
                  .font-mono{font-family:'Monaco','Consolas',monospace}
                  .total-row{font-weight:700;background:#f0f0f0}
                  .footer{margin-top:40px;padding-top:20px;border-top:1px solid #eee;font-size:12px;color:#666;text-align:center}
                </style></head><body>
                <div class="header">
                  <div class="header-left">
                    <svg viewBox="0 0 400 400" width="56" height="56">
                      <defs>
                        <linearGradient id="pdfGoldTop" x1="0%" y1="0%" x2="100%" y2="100%">
                          <stop offset="0%" style="stop-color:#ffe566"/>
                          <stop offset="50%" style="stop-color:#ffd700"/>
                          <stop offset="100%" style="stop-color:#e6b800"/>
                        </linearGradient>
                        <linearGradient id="pdfGoldSide" x1="0%" y1="0%" x2="0%" y2="100%">
                          <stop offset="0%" style="stop-color:#d4a000"/>
                          <stop offset="50%" style="stop-color:#b8960b"/>
                          <stop offset="100%" style="stop-color:#8b7000"/>
                        </linearGradient>
                        <linearGradient id="pdfEmblemGold" x1="0%" y1="0%" x2="100%" y2="100%">
                          <stop offset="0%" style="stop-color:#ffd700"/>
                          <stop offset="25%" style="stop-color:#ffec80"/>
                          <stop offset="50%" style="stop-color:#f4d03f"/>
                          <stop offset="75%" style="stop-color:#d4a000"/>
                          <stop offset="100%" style="stop-color:#b8860b"/>
                        </linearGradient>
                        <linearGradient id="pdfEmblemEdge" x1="0%" y1="0%" x2="100%" y2="100%">
                          <stop offset="0%" style="stop-color:#ffec80"/>
                          <stop offset="50%" style="stop-color:#d4a000"/>
                          <stop offset="100%" style="stop-color:#8b6914"/>
                        </linearGradient>
                        <linearGradient id="pdfCoinFaceBg" x1="0%" y1="0%" x2="0%" y2="100%">
                          <stop offset="0%" style="stop-color:#2a2a35"/>
                          <stop offset="50%" style="stop-color:#1a1a22"/>
                          <stop offset="100%" style="stop-color:#12121a"/>
                        </linearGradient>
                        <linearGradient id="pdfInnerRingGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                          <stop offset="0%" style="stop-color:#ffd700"/>
                          <stop offset="100%" style="stop-color:#b8860b"/>
                        </linearGradient>
                      </defs>
                      <circle cx="200" cy="200" r="150" fill="url(#pdfEmblemGold)"/>
                      <circle cx="200" cy="200" r="150" fill="none" stroke="url(#pdfEmblemEdge)" stroke-width="8"/>
                      <circle cx="200" cy="200" r="130" fill="url(#pdfCoinFaceBg)"/>
                      <circle cx="200" cy="200" r="130" fill="none" stroke="url(#pdfInnerRingGrad)" stroke-width="3"/>
                      <g transform="translate(200, 210)">
                        <g transform="translate(-60, 0)">
                          <ellipse cx="0" cy="24" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="20" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                          <ellipse cx="0" cy="16" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="12" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                          <ellipse cx="0" cy="8" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="4" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                          <ellipse cx="0" cy="0" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="-4" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                          <ellipse cx="0" cy="-8" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="-12" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                        </g>
                        <g transform="translate(-20, -8)">
                          <ellipse cx="0" cy="24" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="20" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                          <ellipse cx="0" cy="16" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="12" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                          <ellipse cx="0" cy="8" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="4" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                          <ellipse cx="0" cy="0" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="-4" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                          <ellipse cx="0" cy="-8" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="-12" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                          <ellipse cx="0" cy="-16" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="-20" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                          <ellipse cx="0" cy="-24" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="-28" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                        </g>
                        <g transform="translate(20, -16)">
                          <ellipse cx="0" cy="24" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="20" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                          <ellipse cx="0" cy="16" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="12" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                          <ellipse cx="0" cy="8" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="4" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                          <ellipse cx="0" cy="0" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="-4" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                          <ellipse cx="0" cy="-8" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="-12" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                          <ellipse cx="0" cy="-16" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="-20" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                          <ellipse cx="0" cy="-24" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="-28" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                          <ellipse cx="0" cy="-32" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="-36" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                          <ellipse cx="0" cy="-40" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="-44" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                        </g>
                        <g transform="translate(60, -24)">
                          <ellipse cx="0" cy="24" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="20" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                          <ellipse cx="0" cy="16" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="12" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                          <ellipse cx="0" cy="8" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="4" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                          <ellipse cx="0" cy="0" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="-4" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                          <ellipse cx="0" cy="-8" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="-12" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                          <ellipse cx="0" cy="-16" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="-20" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                          <ellipse cx="0" cy="-24" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="-28" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                          <ellipse cx="0" cy="-32" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="-36" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                          <ellipse cx="0" cy="-40" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="-44" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                          <ellipse cx="0" cy="-48" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="-52" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                          <ellipse cx="0" cy="-56" rx="20" ry="8" fill="url(#pdfGoldSide)"/><ellipse cx="0" cy="-60" rx="20" ry="8" fill="url(#pdfGoldTop)"/>
                        </g>
                      </g>
                    </svg>
                    <div>
                      <div class="logo-text">${companyName || 'KASSETS'}</div>
                      <p style="color:#666;font-size:12px">Asset Management by Kassets</p>
                    </div>
                  </div>
                  <div class="date">Generated: ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
                </div>
                <h1>${companyName || 'Kassets'} - Asset Balance Sheet</h1>
                <div class="summary-grid">
                  <div class="summary-box"><div class="summary-label">Total Assets (at cost)</div><div class="summary-value">${formatCurrency(totals.totalPurchaseCost)}</div></div>
                  <div class="summary-box"><div class="summary-label">Accumulated Depreciation</div><div class="summary-value red">(${formatCurrency(totals.totalPurchaseCost - totals.totalCurrentValue)})</div></div>
                  <div class="summary-box"><div class="summary-label">Net Book Value</div><div class="summary-value green">${formatCurrency(totals.totalCurrentValue)}</div></div>
                </div>
                <h2>Assets by Category</h2>
                <table><thead><tr><th>Category</th><th class="text-right">Count</th><th class="text-right">Purchase Cost</th><th class="text-right">Current Value</th><th class="text-right">Depreciation</th></tr></thead><tbody>
                ${categoryStats.map(c => `<tr><td>${c.name}</td><td class="text-right font-mono">${c.count}</td><td class="text-right font-mono">${formatCurrency(c.cost)}</td><td class="text-right font-mono" style="color:#22c55e">${formatCurrency(c.value)}</td><td class="text-right font-mono" style="color:#ef4444">(${formatCurrency(c.depreciation)})</td></tr>`).join('')}
                <tr class="total-row"><td>TOTAL</td><td class="text-right font-mono">${totals.totalAssets}</td><td class="text-right font-mono">${formatCurrency(totals.totalPurchaseCost)}</td><td class="text-right font-mono" style="color:#22c55e">${formatCurrency(totals.totalCurrentValue)}</td><td class="text-right font-mono" style="color:#ef4444">(${formatCurrency(totals.totalPurchaseCost - totals.totalCurrentValue)})</td></tr>
                </tbody></table>
                <h2>Assets by Location</h2>
                <table><thead><tr><th>Location</th><th class="text-right">Asset Count</th><th class="text-right">Purchase Cost</th><th class="text-right">Current Value</th><th class="text-right">% of Total</th></tr></thead><tbody>
                ${locationStats.map(l => `<tr><td>${l.name}</td><td class="text-right font-mono">${l.count}</td><td class="text-right font-mono">${formatCurrency(l.cost)}</td><td class="text-right font-mono" style="color:#22c55e">${formatCurrency(l.value)}</td><td class="text-right font-mono">${l.pct}%</td></tr>`).join('')}
                </tbody></table>
                <h2>Detailed Asset Schedule</h2>
                <table><thead><tr><th>Asset Name</th><th>Serial #</th><th>Location</th><th class="text-right">Qty</th><th>Purchase Date</th><th class="text-right">Unit Cost</th><th class="text-right">Total Value</th></tr></thead><tbody>
                ${sortedAssets.map(a => `<tr><td>${a.name}</td><td class="font-mono" style="color:#666;font-size:12px">${a.serialNumber || '-'}</td><td>${getLocationName(a.locationId)}</td><td class="text-right">${a.quantity}</td><td>${a.purchaseDate ? new Date(a.purchaseDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : '-'}</td><td class="text-right font-mono">${formatCurrency(a.purchaseCost)}</td><td class="text-right font-mono" style="color:#22c55e">${formatCurrency(a.currentValue * a.quantity)}</td></tr>`).join('')}
                </tbody></table>
                <div class="footer"><p>Generated by Kassets Asset Management System</p></div>
                </body></html>`;
                
                const win = window.open('', '_blank');
                win.document.write(html);
                win.document.close();
                win.print();
              }}>üìÑ Generate PDF Report</button>
            </div>
            
            {/* Preview on screen */}
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))', gap: 16, marginBottom: 32 }}>
              <div style={{ background: 'rgba(15,23,42,0.5)', padding: 16, borderRadius: 12, borderLeft: '4px solid #ffd700' }}>
                <p style={{ color: '#64748b', fontSize: 11, margin: 0, textTransform: 'uppercase' }}>Total Assets (at cost)</p>
                <p style={{ fontSize: 20, fontWeight: 700, margin: '8px 0 0', fontFamily: "'JetBrains Mono', monospace" }}>{formatCurrency(totals.totalPurchaseCost)}</p>
              </div>
              <div style={{ background: 'rgba(15,23,42,0.5)', padding: 16, borderRadius: 12, borderLeft: '4px solid #ef4444' }}>
                <p style={{ color: '#64748b', fontSize: 11, margin: 0, textTransform: 'uppercase' }}>Accumulated Depreciation</p>
                <p style={{ fontSize: 20, fontWeight: 700, margin: '8px 0 0', fontFamily: "'JetBrains Mono', monospace", color: '#f87171' }}>({formatCurrency(totals.totalPurchaseCost - totals.totalCurrentValue)})</p>
              </div>
              <div style={{ background: 'rgba(15,23,42,0.5)', padding: 16, borderRadius: 12, borderLeft: '4px solid #22c55e' }}>
                <p style={{ color: '#64748b', fontSize: 11, margin: 0, textTransform: 'uppercase' }}>Net Book Value</p>
                <p style={{ fontSize: 20, fontWeight: 700, margin: '8px 0 0', fontFamily: "'JetBrains Mono', monospace", color: '#34d399' }}>{formatCurrency(totals.totalCurrentValue)}</p>
              </div>
            </div>
            
            {/* Assets by Category */}
            <h3 style={{ marginBottom: 16, borderBottom: '2px solid #ffd700', paddingBottom: 8 }}>Assets by Category</h3>
            <div style={{ overflowX: 'auto', marginBottom: 32 }}>
              <table style={{ width: '100%', borderCollapse: 'collapse', minWidth: 500 }}>
                <thead>
                  <tr style={{ background: 'rgba(15,23,42,0.8)' }}>
                    <th style={{ textAlign: 'left', padding: 12, color: '#94a3b8', fontSize: 11 }}>CATEGORY</th>
                    <th style={{ textAlign: 'right', padding: 12, color: '#94a3b8', fontSize: 11 }}>COUNT</th>
                    <th style={{ textAlign: 'right', padding: 12, color: '#94a3b8', fontSize: 11 }}>PURCHASE COST</th>
                    <th style={{ textAlign: 'right', padding: 12, color: '#94a3b8', fontSize: 11 }}>CURRENT VALUE</th>
                    <th style={{ textAlign: 'right', padding: 12, color: '#94a3b8', fontSize: 11 }}>DEPRECIATION</th>
                  </tr>
                </thead>
                <tbody>
                  {categories.map(cat => {
                    const catAssets = assets.filter(a => a.category === cat);
                    if (catAssets.length === 0) return null;
                    const count = catAssets.reduce((s, a) => s + a.quantity, 0);
                    const cost = catAssets.reduce((s, a) => s + a.purchaseCost * a.quantity, 0);
                    const value = catAssets.reduce((s, a) => s + a.currentValue * a.quantity, 0);
                    return (
                      <tr key={cat} style={{ borderBottom: '1px solid rgba(148,163,184,0.1)' }}>
                        <td style={{ padding: 12 }}>{cat}</td>
                        <td style={{ padding: 12, textAlign: 'right', fontFamily: "'JetBrains Mono', monospace" }}>{count}</td>
                        <td style={{ padding: 12, textAlign: 'right', fontFamily: "'JetBrains Mono', monospace" }}>{formatCurrency(cost)}</td>
                        <td style={{ padding: 12, textAlign: 'right', fontFamily: "'JetBrains Mono', monospace", color: '#34d399' }}>{formatCurrency(value)}</td>
                        <td style={{ padding: 12, textAlign: 'right', fontFamily: "'JetBrains Mono', monospace", color: '#f87171' }}>({formatCurrency(cost - value)})</td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
            
            {/* Assets by Location */}
            <h3 style={{ marginBottom: 16, borderBottom: '2px solid #ffd700', paddingBottom: 8 }}>Assets by Location</h3>
            <div style={{ overflowX: 'auto', marginBottom: 32 }}>
              <table style={{ width: '100%', borderCollapse: 'collapse', minWidth: 500 }}>
                <thead>
                  <tr style={{ background: 'rgba(15,23,42,0.8)' }}>
                    <th style={{ textAlign: 'left', padding: 12, color: '#94a3b8', fontSize: 11 }}>LOCATION</th>
                    <th style={{ textAlign: 'right', padding: 12, color: '#94a3b8', fontSize: 11 }}>ASSET COUNT</th>
                    <th style={{ textAlign: 'right', padding: 12, color: '#94a3b8', fontSize: 11 }}>PURCHASE COST</th>
                    <th style={{ textAlign: 'right', padding: 12, color: '#94a3b8', fontSize: 11 }}>CURRENT VALUE</th>
                    <th style={{ textAlign: 'right', padding: 12, color: '#94a3b8', fontSize: 11 }}>% OF TOTAL</th>
                  </tr>
                </thead>
                <tbody>
                  {[...locations].sort((a, b) => a.name.localeCompare(b.name)).map(loc => {
                    const locAssets = assets.filter(a => a.locationId === loc.id);
                    const count = locAssets.reduce((s, a) => s + a.quantity, 0);
                    const cost = locAssets.reduce((s, a) => s + a.purchaseCost * a.quantity, 0);
                    const value = locAssets.reduce((s, a) => s + a.currentValue * a.quantity, 0);
                    const pct = totals.totalCurrentValue > 0 ? ((value / totals.totalCurrentValue) * 100).toFixed(1) : '0.0';
                    return (
                      <tr key={loc.id} style={{ borderBottom: '1px solid rgba(148,163,184,0.1)' }}>
                        <td style={{ padding: 12 }}>{loc.name}</td>
                        <td style={{ padding: 12, textAlign: 'right', fontFamily: "'JetBrains Mono', monospace" }}>{count}</td>
                        <td style={{ padding: 12, textAlign: 'right', fontFamily: "'JetBrains Mono', monospace" }}>{formatCurrency(cost)}</td>
                        <td style={{ padding: 12, textAlign: 'right', fontFamily: "'JetBrains Mono', monospace", color: '#34d399' }}>{formatCurrency(value)}</td>
                        <td style={{ padding: 12, textAlign: 'right', fontFamily: "'JetBrains Mono', monospace" }}>{pct}%</td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
            
            {/* Detailed Asset Schedule */}
            <h3 style={{ marginBottom: 16, borderBottom: '2px solid #ffd700', paddingBottom: 8 }}>Detailed Asset Schedule</h3>
            <div style={{ overflowX: 'auto' }}>
              <table style={{ width: '100%', borderCollapse: 'collapse', minWidth: 700 }}>
                <thead>
                  <tr style={{ background: 'rgba(15,23,42,0.8)' }}>
                    <th style={{ textAlign: 'left', padding: 12, color: '#94a3b8', fontSize: 11 }}>ASSET NAME</th>
                    <th style={{ textAlign: 'left', padding: 12, color: '#94a3b8', fontSize: 11 }}>SERIAL #</th>
                    <th style={{ textAlign: 'left', padding: 12, color: '#94a3b8', fontSize: 11 }}>LOCATION</th>
                    <th style={{ textAlign: 'right', padding: 12, color: '#94a3b8', fontSize: 11 }}>QTY</th>
                    <th style={{ textAlign: 'left', padding: 12, color: '#94a3b8', fontSize: 11 }}>PURCHASE DATE</th>
                    <th style={{ textAlign: 'right', padding: 12, color: '#94a3b8', fontSize: 11 }}>UNIT COST</th>
                    <th style={{ textAlign: 'right', padding: 12, color: '#94a3b8', fontSize: 11 }}>TOTAL VALUE</th>
                  </tr>
                </thead>
                <tbody>
                  {[...assets].sort((a, b) => a.name.localeCompare(b.name)).map(a => (
                    <tr key={a.id} style={{ borderBottom: '1px solid rgba(148,163,184,0.1)' }}>
                      <td style={{ padding: 12 }}>{a.name}</td>
                      <td style={{ padding: 12, color: '#64748b', fontSize: 12, fontFamily: "'JetBrains Mono', monospace" }}>{a.serialNumber || '-'}</td>
                      <td style={{ padding: 12 }}>{getLocationName(a.locationId)}</td>
                      <td style={{ padding: 12, textAlign: 'right' }}>{a.quantity}</td>
                      <td style={{ padding: 12 }}>{a.purchaseDate ? new Date(a.purchaseDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : '-'}</td>
                      <td style={{ padding: 12, textAlign: 'right', fontFamily: "'JetBrains Mono', monospace" }}>{formatCurrency(a.purchaseCost)}</td>
                      <td style={{ padding: 12, textAlign: 'right', fontFamily: "'JetBrains Mono', monospace", color: '#34d399' }}>{formatCurrency(a.currentValue * a.quantity)}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            
            <div style={{ marginTop: 32, paddingTop: 20, borderTop: '1px solid rgba(148,163,184,0.2)', textAlign: 'center', color: '#64748b', fontSize: 12 }}>
              Generated by Kassets Asset Management System
            </div>
          </div>
        )}
      </main>

      {/* MODALS */}
      
      {/* User Management */}
      {showUserMgmt && <UserManagement currentUser={user} onClose={() => setShowUserMgmt(false)} />}
      
      {/* Settings Modal */}
      {showSettings && (
        <div className="modal-overlay" onClick={() => setShowSettings(false)}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <h2 style={{ marginBottom: 20 }}>‚öôÔ∏è Settings</h2>
            
            <div style={{ marginBottom: 24 }}>
              <label style={{ display: 'block', marginBottom: 8, color: '#94a3b8' }}>Company Name</label>
              <input className="input-field" value={companyName} onChange={e => setCompanyName(e.target.value)} placeholder="Enter company name" />
            </div>
            
            <div style={{ borderTop: '1px solid rgba(148,163,184,0.2)', paddingTop: 20, marginBottom: 20 }}>
              <h3 style={{ fontSize: 16, marginBottom: 12, color: '#94a3b8' }}>üîê Account</h3>
              <p style={{ fontSize: 13, color: '#64748b', marginBottom: 12 }}>Logged in as: <strong style={{ color: '#e2e8f0' }}>{user.displayName || user.username}</strong></p>
              <button className="btn-secondary" style={{ width: '100%' }} onClick={() => { setShowSettings(false); setShowChangePassword(true); }}>
                Change Password
              </button>
            </div>
            
            <div style={{ display: 'flex', gap: 12, justifyContent: 'flex-end' }}>
              <button className="btn-secondary" onClick={() => setShowSettings(false)}>Cancel</button>
              <button className="btn-primary" onClick={handleSaveSettings}>Save</button>
            </div>
          </div>
        </div>
      )}
      
      {/* Change Password Modal */}
      {showChangePassword && (
        <div className="modal-overlay" onClick={() => { setShowChangePassword(false); setPasswordData({ current: '', new: '', confirm: '' }); }}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <h2 style={{ marginBottom: 20 }}>üîê Change Password</h2>
            
            <div style={{ marginBottom: 16 }}>
              <label style={{ display: 'block', marginBottom: 8, color: '#94a3b8', fontSize: 14 }}>Current Password</label>
              <input type="password" className="input-field" value={passwordData.current} onChange={e => setPasswordData({...passwordData, current: e.target.value})} placeholder="Enter current password" />
            </div>
            
            <div style={{ marginBottom: 16 }}>
              <label style={{ display: 'block', marginBottom: 8, color: '#94a3b8', fontSize: 14 }}>New Password</label>
              <input type="password" className="input-field" value={passwordData.new} onChange={e => setPasswordData({...passwordData, new: e.target.value})} placeholder="Enter new password (min 6 characters)" />
            </div>
            
            <div style={{ marginBottom: 24 }}>
              <label style={{ display: 'block', marginBottom: 8, color: '#94a3b8', fontSize: 14 }}>Confirm New Password</label>
              <input type="password" className="input-field" value={passwordData.confirm} onChange={e => setPasswordData({...passwordData, confirm: e.target.value})} placeholder="Confirm new password" />
            </div>
            
            <div style={{ display: 'flex', gap: 12, justifyContent: 'flex-end' }}>
              <button className="btn-secondary" onClick={() => { setShowChangePassword(false); setPasswordData({ current: '', new: '', confirm: '' }); }}>Cancel</button>
              <button className="btn-primary" onClick={handleChangePassword}>Change Password</button>
            </div>
          </div>
        </div>
      )}
      
      {/* Categories Modal */}
      {showManageCategories && (
        <div className="modal-overlay" onClick={() => setShowManageCategories(false)}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <h2 style={{ marginBottom: 20 }}>Manage Categories</h2>
            <div style={{ display: 'flex', gap: 12, marginBottom: 20 }}>
              <input className="input-field" placeholder="New category name" value={newCategory} onChange={e => setNewCategory(e.target.value)} onKeyPress={e => e.key === 'Enter' && handleAddCategory()} />
              <button className="btn-primary" onClick={handleAddCategory}>Add</button>
            </div>
            <div style={{ maxHeight: 300, overflowY: 'auto' }}>
              {categories.map(cat => (
                <div key={cat} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: 12, background: 'rgba(15,23,42,0.5)', borderRadius: 8, marginBottom: 8 }}>
                  {editingCategory === cat ? (
                    <div style={{ display: 'flex', gap: 8, flex: 1, marginRight: 12 }}>
                      <input 
                        className="input-field" 
                        value={editingCategoryName} 
                        onChange={e => setEditingCategoryName(e.target.value)} 
                        onKeyPress={e => e.key === 'Enter' && handleRenameCategory()}
                        autoFocus
                        style={{ flex: 1 }}
                      />
                      <button className="btn-primary" style={{ padding: '6px 12px', fontSize: 12 }} onClick={handleRenameCategory}>Save</button>
                      <button className="btn-secondary" style={{ padding: '6px 12px', fontSize: 12 }} onClick={() => setEditingCategory(null)}>Cancel</button>
                    </div>
                  ) : (
                    <>
                      <span>{cat} <span style={{ color: '#64748b', fontSize: 12 }}>({assets.filter(a => a.category === cat).length} assets)</span></span>
                      <div style={{ display: 'flex', gap: 8 }}>
                        <button className="btn-secondary" style={{ padding: '4px 10px', fontSize: 12 }} onClick={() => { setEditingCategory(cat); setEditingCategoryName(cat); }}>Edit</button>
                        <button className="btn-danger" style={{ padding: '4px 10px', fontSize: 12 }} onClick={() => handleDeleteCategory(cat)}>Delete</button>
                      </div>
                    </>
                  )}
                </div>
              ))}
            </div>
            <div style={{ marginTop: 20, textAlign: 'right' }}><button className="btn-secondary" onClick={() => setShowManageCategories(false)}>Done</button></div>
          </div>
        </div>
      )}
      
      {/* Add Asset Modal */}
      {showAddAsset && (
        <div className="modal-overlay" onClick={() => setShowAddAsset(false)}>
          <div className="modal-content" onClick={e => e.stopPropagation()} style={{ maxWidth: 550 }}>
            <h2 style={{ marginBottom: 20 }}>Add New Asset</h2>
            <div style={{ display: 'grid', gap: 12 }}>
              <input className="input-field" placeholder="Asset Name *" value={newAsset.name} onChange={e => setNewAsset({...newAsset, name: e.target.value})} />
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12 }}>
                <select className="input-field" value={newAsset.category} onChange={e => setNewAsset({...newAsset, category: e.target.value})}>
                  <option value="">Select Category</option>
                  {categories.map(c => <option key={c} value={c}>{c}</option>)}
                </select>
                <select className="input-field" value={newAsset.locationId} onChange={e => setNewAsset({...newAsset, locationId: e.target.value})}>
                  <option value="">Select Location</option>
                  {locations.map(l => <option key={l.id} value={l.id}>{l.name}</option>)}
                </select>
              </div>
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12 }}>
                <input className="input-field" placeholder="P/N (Part Number)" value={newAsset.partNumber} onChange={e => setNewAsset({...newAsset, partNumber: e.target.value})} />
                <input className="input-field" placeholder="Serial Number" value={newAsset.serialNumber} onChange={e => setNewAsset({...newAsset, serialNumber: e.target.value})} />
              </div>
              <input className="input-field" placeholder="Description" value={newAsset.description} onChange={e => setNewAsset({...newAsset, description: e.target.value})} />
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12 }}>
                <div><label style={{ fontSize: 12, color: '#64748b' }}>Purchase Date</label><input type="date" className="input-field" value={newAsset.purchaseDate} onChange={e => setNewAsset({...newAsset, purchaseDate: e.target.value})} /></div>
                <div><label style={{ fontSize: 12, color: '#64748b' }}>Quantity</label><input type="number" className="input-field" min="1" value={newAsset.quantity} onChange={e => setNewAsset({...newAsset, quantity: parseInt(e.target.value) || 1})} /></div>
              </div>
              {isAdmin && (
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12 }}>
                  <div><label style={{ fontSize: 12, color: '#64748b' }}>Purchase Cost ($)</label><input type="number" className="input-field" step="0.01" min="0" value={newAsset.purchaseCost} onChange={e => setNewAsset({...newAsset, purchaseCost: parseFloat(e.target.value) || 0})} /></div>
                  <div><label style={{ fontSize: 12, color: '#64748b' }}>Current Value ($)</label><input type="number" className="input-field" step="0.01" min="0" value={newAsset.currentValue} onChange={e => setNewAsset({...newAsset, currentValue: parseFloat(e.target.value) || 0})} /></div>
                </div>
              )}
              <div style={{ marginTop: 8 }}>
                <label style={{ fontSize: 13, color: '#94a3b8', display: 'block', marginBottom: 8 }}>
                  Photos ({newAsset.photos?.length || 0}/5)
                  {isUploadingPhotos && <span style={{ marginLeft: 8, color: '#ffd700' }}>‚è≥ Uploading...</span>}
                </label>
                {(newAsset.photos?.length || 0) < 5 && (
                  <input type="file" accept="image/*" multiple disabled={isUploadingPhotos} onChange={async (e) => {
                    const files = Array.from(e.target.files);
                    const currentPhotos = newAsset.photos || [];
                    const available = 5 - currentPhotos.length;
                    if (files.length > available) {
                      alert(`Can only add ${available} more photo(s)`);
                    }
                    const toUpload = files.slice(0, available);
                    
                    setIsUploadingPhotos(true);
                    
                    // Compress image function
                    const compressImage = (file, maxWidth = 800, quality = 0.7) => {
                      return new Promise(resolve => {
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                          const img = new Image();
                          img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;
                            if (width > maxWidth) {
                              height = (height * maxWidth) / width;
                              width = maxWidth;
                            }
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', quality));
                          };
                          img.src = ev.target.result;
                        };
                        reader.readAsDataURL(file);
                      });
                    };
                    
                    try {
                      // Compress all photos in parallel
                      const newPhotos = await Promise.all(toUpload.map(async (file) => {
                        const url = await compressImage(file);
                        return { id: Date.now() + Math.random(), url, name: file.name };
                      }));
                      setNewAsset({...newAsset, photos: [...currentPhotos, ...newPhotos]});
                    } catch (err) {
                      alert('Failed to process photos. Please try again.');
                    }
                    
                    setIsUploadingPhotos(false);
                    e.target.value = '';
                  }} style={{ color: '#94a3b8', fontSize: 13 }} />
                )}
                {newAsset.photos?.length > 0 && (
                  <div style={{ display: 'flex', gap: 8, marginTop: 8, flexWrap: 'wrap' }}>
                    {newAsset.photos.map((p, idx) => (
                      <div key={idx} style={{ position: 'relative' }}>
                        <img src={p.url} style={{ width: 60, height: 60, objectFit: 'cover', borderRadius: 6 }} />
                        <button onClick={() => setNewAsset({...newAsset, photos: newAsset.photos.filter((_, i) => i !== idx)})} style={{ position: 'absolute', top: -6, right: -6, background: '#ef4444', border: 'none', borderRadius: '50%', width: 20, height: 20, color: 'white', fontSize: 12, cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>‚úï</button>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
            <div style={{ display: 'flex', gap: 12, marginTop: 20, justifyContent: 'flex-end' }}>
              <button className="btn-secondary" onClick={() => setShowAddAsset(false)} disabled={isAddingAsset}>Cancel</button>
              <button className="btn-primary" onClick={handleAddAsset} disabled={isAddingAsset || isUploadingPhotos}>
                {isAddingAsset ? '‚è≥ Adding...' : 'Add Asset'}
              </button>
            </div>
          </div>
        </div>
      )}
      
      {/* Edit Asset Modal */}
      {editingAsset && (
        <div className="modal-overlay" onClick={() => setEditingAsset(null)}>
          <div className="modal-content" onClick={e => e.stopPropagation()} style={{ maxWidth: 550 }}>
            <h2 style={{ marginBottom: 20 }}>Edit Asset</h2>
            <div style={{ display: 'grid', gap: 12 }}>
              <input className="input-field" placeholder="Name *" value={editingAsset.name} onChange={e => setEditingAsset({...editingAsset, name: e.target.value})} />
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12 }}>
                <select className="input-field" value={editingAsset.category} onChange={e => setEditingAsset({...editingAsset, category: e.target.value})}>
                  {categories.map(c => <option key={c} value={c}>{c}</option>)}
                </select>
                <select className="input-field" value={editingAsset.locationId || ''} onChange={e => setEditingAsset({...editingAsset, locationId: parseInt(e.target.value) || null})}>
                  <option value="">Select Location</option>
                  {locations.map(l => <option key={l.id} value={l.id}>{l.name}</option>)}
                </select>
              </div>
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12 }}>
                <input className="input-field" placeholder="P/N (Part Number)" value={editingAsset.partNumber || ''} onChange={e => setEditingAsset({...editingAsset, partNumber: e.target.value})} />
                <input className="input-field" placeholder="Serial Number" value={editingAsset.serialNumber || ''} onChange={e => setEditingAsset({...editingAsset, serialNumber: e.target.value})} />
              </div>
              <input className="input-field" placeholder="Description" value={editingAsset.description || ''} onChange={e => setEditingAsset({...editingAsset, description: e.target.value})} />
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12 }}>
                <input type="date" className="input-field" value={editingAsset.purchaseDate || ''} onChange={e => setEditingAsset({...editingAsset, purchaseDate: e.target.value})} />
                <input type="number" className="input-field" min="1" value={editingAsset.quantity} onChange={e => setEditingAsset({...editingAsset, quantity: parseInt(e.target.value) || 1})} />
              </div>
              {isAdmin && (
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12 }}>
                  <input type="number" className="input-field" step="0.01" placeholder="Cost" value={editingAsset.purchaseCost || ''} onChange={e => setEditingAsset({...editingAsset, purchaseCost: parseFloat(e.target.value) || 0})} />
                  <input type="number" className="input-field" step="0.01" placeholder="Value" value={editingAsset.currentValue || ''} onChange={e => setEditingAsset({...editingAsset, currentValue: parseFloat(e.target.value) || 0})} />
                </div>
              )}
              <div style={{ marginTop: 8 }}>
                <label style={{ fontSize: 13, color: '#94a3b8', display: 'block', marginBottom: 8 }}>
                  Photos ({editingAsset.photos?.length || 0}/5)
                  {isUploadingPhotos && <span style={{ marginLeft: 8, color: '#ffd700' }}>‚è≥ Uploading...</span>}
                </label>
                {(editingAsset.photos?.length || 0) < 5 && <input type="file" accept="image/*" multiple disabled={isUploadingPhotos} onChange={e => handlePhotoUpload(e, editingAsset.id)} style={{ color: '#94a3b8', fontSize: 13 }} />}
                {editingAsset.photos?.length > 0 && (
                  <div style={{ display: 'flex', gap: 8, marginTop: 8, flexWrap: 'wrap' }}>
                    {editingAsset.photos.map(p => (
                      <div key={p.id} style={{ position: 'relative' }}>
                        <img src={p.url} style={{ width: 60, height: 60, objectFit: 'cover', borderRadius: 6 }} />
                        <button 
                          onClick={() => handleDeletePhoto(editingAsset.id, p.id)} 
                          style={{ 
                            position: 'absolute', top: -6, right: -6, 
                            width: 20, height: 20, borderRadius: '50%', 
                            background: '#ef4444', border: 'none', 
                            color: 'white', fontSize: 12, cursor: 'pointer',
                            display: 'flex', alignItems: 'center', justifyContent: 'center'
                          }}
                        >‚úï</button>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
            <div style={{ display: 'flex', gap: 12, marginTop: 20, justifyContent: 'flex-end' }}>
              <button className="btn-secondary" onClick={() => setEditingAsset(null)}>Cancel</button>
              <button className="btn-primary" onClick={handleUpdateAsset}>Save</button>
            </div>
          </div>
        </div>
      )}
      
      {/* Add Location Modal */}
      {showAddLocation && (
        <div className="modal-overlay" onClick={() => setShowAddLocation(false)}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <h2 style={{ marginBottom: 20 }}>Add Location</h2>
            <input className="input-field" placeholder="Location Name *" value={newLocation.name} onChange={e => setNewLocation({...newLocation, name: e.target.value})} style={{ marginBottom: 12 }} />
            <input className="input-field" placeholder="Address" value={newLocation.address} onChange={e => setNewLocation({...newLocation, address: e.target.value})} style={{ marginBottom: 20 }} />
            <div style={{ display: 'flex', gap: 12, justifyContent: 'flex-end' }}>
              <button className="btn-secondary" onClick={() => setShowAddLocation(false)}>Cancel</button>
              <button className="btn-primary" onClick={handleAddLocation}>Add</button>
            </div>
          </div>
        </div>
      )}
      
      {/* Edit Location Modal */}
      {editingLocation && (
        <div className="modal-overlay" onClick={() => setEditingLocation(null)}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <h2 style={{ marginBottom: 20 }}>Edit Location</h2>
            <input className="input-field" placeholder="Name *" value={editingLocation.name} onChange={e => setEditingLocation({...editingLocation, name: e.target.value})} style={{ marginBottom: 12 }} />
            <input className="input-field" placeholder="Address" value={editingLocation.address || ''} onChange={e => setEditingLocation({...editingLocation, address: e.target.value})} style={{ marginBottom: 20 }} />
            <div style={{ display: 'flex', gap: 12, justifyContent: 'flex-end' }}>
              <button className="btn-secondary" onClick={() => setEditingLocation(null)}>Cancel</button>
              <button className="btn-primary" onClick={handleUpdateLocation}>Save</button>
            </div>
          </div>
        </div>
      )}
      
      {/* Bulk Transfer Modal */}
      {showBulkTransfer && (
        <div className="modal-overlay" onClick={() => { setShowBulkTransfer(false); setBulkTransferTo(''); }}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <h2 style={{ marginBottom: 20 }}>üìç Move {selectedAssets.length} Assets</h2>
            <div style={{ marginBottom: 16, maxHeight: 150, overflowY: 'auto', background: 'rgba(15,23,42,0.5)', borderRadius: 10, padding: 12 }}>
              {assets.filter(a => selectedAssets.includes(a.id)).map(a => (
                <div key={a.id} style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0', borderBottom: '1px solid rgba(148,163,184,0.1)', fontSize: 13 }}>
                  <span>{a.name}</span>
                  <span className="location-badge" style={{ fontSize: 10 }}>{getLocationName(a.locationId)}</span>
                </div>
              ))}
            </div>
            <select className="input-field" value={bulkTransferTo} onChange={e => setBulkTransferTo(e.target.value)} style={{ marginBottom: 20 }}>
              <option value="">Select destination</option>
              {locations.map(l => <option key={l.id} value={l.id}>{l.name}</option>)}
            </select>
            <div style={{ display: 'flex', gap: 12, justifyContent: 'flex-end' }}>
              <button className="btn-secondary" onClick={() => { setShowBulkTransfer(false); setBulkTransferTo(''); }}>Cancel</button>
              <button className="btn-primary" onClick={handleBulkTransfer} disabled={!bulkTransferTo}>Move Assets</button>
            </div>
          </div>
        </div>
      )}
      
      {/* Bulk Delete Modal */}
      {/* Bulk Category Modal */}
      {showBulkCategory && (
        <div className="modal-overlay" onClick={() => setShowBulkCategory(false)}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <h2 style={{ marginBottom: 16 }}>üè∑Ô∏è Change Category for {selectedAssets.length} Assets</h2>
            <p style={{ color: '#64748b', marginBottom: 16, fontSize: 13 }}>Select a new category for the selected assets:</p>
            <select className="input-field" value={bulkCategoryTo} onChange={e => setBulkCategoryTo(e.target.value)} style={{ marginBottom: 20 }}>
              <option value="">Select Category</option>
              {categories.map(c => <option key={c} value={c}>{c}</option>)}
            </select>
            <div style={{ display: 'flex', gap: 12, justifyContent: 'flex-end' }}>
              <button className="btn-secondary" onClick={() => setShowBulkCategory(false)}>Cancel</button>
              <button className="btn-primary" onClick={handleBulkCategory} disabled={!bulkCategoryTo}>Change Category</button>
            </div>
          </div>
        </div>
      )}

      {showBulkDelete && (
        <div className="modal-overlay" onClick={() => setShowBulkDelete(false)}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <h2 style={{ marginBottom: 16, color: '#f87171' }}>üóëÔ∏è Delete {selectedAssets.length} Assets?</h2>
            <div style={{ marginBottom: 16, maxHeight: 200, overflowY: 'auto', background: 'rgba(239,68,68,0.1)', borderRadius: 10, padding: 12, border: '1px solid rgba(239,68,68,0.2)' }}>
              {assets.filter(a => selectedAssets.includes(a.id)).map(a => (
                <div key={a.id} style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 0', borderBottom: '1px solid rgba(148,163,184,0.1)', fontSize: 13 }}>
                  <span>{a.name} ({a.quantity})</span>
                  <span style={{ fontFamily: "'JetBrains Mono', monospace", color: '#f87171' }}>{formatCurrency(a.currentValue * a.quantity)}</span>
                </div>
              ))}
            </div>
            <p style={{ color: '#f87171', fontSize: 13, marginBottom: 20 }}>‚ö†Ô∏è Total value: {formatCurrency(assets.filter(a => selectedAssets.includes(a.id)).reduce((s, a) => s + a.currentValue * a.quantity, 0))}</p>
            <div style={{ display: 'flex', gap: 12, justifyContent: 'flex-end' }}>
              <button className="btn-secondary" onClick={() => setShowBulkDelete(false)}>Cancel</button>
              <button className="btn-danger" onClick={handleBulkDelete}>Delete</button>
            </div>
          </div>
        </div>
      )}
      
      {/* Notes Modal */}
      {showNotesModal && (
        <div className="modal-overlay" onClick={() => { setShowNotesModal(null); setNewNote(''); }}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <h2 style={{ marginBottom: 8 }}>üìù Notes</h2>
            <p style={{ color: '#64748b', marginBottom: 20 }}>{showNotesModal.name}</p>
            {canEdit && (
              <div style={{ marginBottom: 20 }}>
                <textarea className="input-field" placeholder="Add a note..." value={newNote} onChange={e => setNewNote(e.target.value)} rows={3} style={{ resize: 'vertical' }} />
                <button className="btn-primary" style={{ marginTop: 8 }} onClick={handleAddNote} disabled={!newNote.trim()}>Add Note</button>
              </div>
            )}
            <div style={{ maxHeight: 300, overflowY: 'auto' }}>
              {(!showNotesModal.notes || showNotesModal.notes.length === 0) ? (
                <p style={{ color: '#64748b', textAlign: 'center', padding: 20 }}>No notes yet</p>
              ) : showNotesModal.notes.map(n => (
                <div key={n.id} style={{ background: 'rgba(15,23,42,0.5)', borderRadius: 10, padding: 12, marginBottom: 8, borderLeft: '3px solid #fbbf24' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 8 }}>
                    <span style={{ fontSize: 11, color: '#64748b' }}>{new Date(n.created_at).toLocaleString()}{n.created_by && ` ‚Ä¢ ${n.created_by}`}</span>
                    {canEdit && <button onClick={() => handleDeleteNote(n.id)} style={{ background: 'none', border: 'none', color: '#64748b', cursor: 'pointer' }}>‚úï</button>}
                  </div>
                  <p style={{ margin: 0, whiteSpace: 'pre-wrap' }}>{n.text}</p>
                </div>
              ))}
            </div>
            <div style={{ marginTop: 20, textAlign: 'right' }}><button className="btn-secondary" onClick={() => { setShowNotesModal(null); setNewNote(''); }}>Close</button></div>
          </div>
        </div>
      )}
      
      {/* Photo Viewer Modal */}
      {showPhotoViewer && (
        <div className="modal-overlay" onClick={() => setShowPhotoViewer(null)}>
          <div className="modal-content" onClick={e => e.stopPropagation()} style={{ maxWidth: 700 }}>
            <h2 style={{ marginBottom: 20 }}>üì∑ {showPhotoViewer.name}</h2>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(180px, 1fr))', gap: 16 }}>
              {showPhotoViewer.photos?.map(p => (
                <div key={p.id} style={{ borderRadius: 12, overflow: 'hidden', border: '1px solid rgba(148,163,184,0.2)', position: 'relative' }}>
                  <img src={p.url} style={{ width: '100%', height: 150, objectFit: 'cover', cursor: 'pointer' }} onClick={() => setFullscreenPhoto(p)} />
                  <div style={{ padding: 8, display: 'flex', justifyContent: 'space-between', alignItems: 'center', gap: 8 }}>
                    <span style={{ fontSize: 11, color: '#64748b', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', flex: 1 }}>{p.name}</span>
                    <a href={p.url} download={p.name} style={{ color: '#60a5fa', fontSize: 11, textDecoration: 'none' }}>‚¨á</a>
                    {canEdit && <button onClick={() => { handleDeletePhoto(showPhotoViewer.id, p.id); setShowPhotoViewer({...showPhotoViewer, photos: showPhotoViewer.photos.filter(x => x.id !== p.id)}); }} style={{ background: 'rgba(239,68,68,0.2)', border: 'none', color: '#f87171', fontSize: 11, padding: '2px 6px', borderRadius: 4, cursor: 'pointer' }}>üóë</button>}
                  </div>
                </div>
              ))}
            </div>
            <div style={{ marginTop: 20, textAlign: 'right' }}><button className="btn-secondary" onClick={() => setShowPhotoViewer(null)}>Close</button></div>
          </div>
        </div>
      )}
      
      {/* Fullscreen Photo */}
      {fullscreenPhoto && (
        <div className="modal-overlay" style={{ background: 'rgba(0,0,0,0.95)', zIndex: 2000 }} onClick={() => setFullscreenPhoto(null)}>
          <div onClick={e => e.stopPropagation()} style={{ maxWidth: '95vw', maxHeight: '95vh', display: 'flex', flexDirection: 'column', alignItems: 'center', position: 'relative' }}>
            <button onClick={() => setFullscreenPhoto(null)} style={{ position: 'absolute', top: 20, right: 20, background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '50%', width: 40, height: 40, color: 'white', fontSize: 20, cursor: 'pointer', zIndex: 10 }}>‚úï</button>
            
            {/* Navigation arrows */}
            {showPhotoViewer && showPhotoViewer.photos?.length > 1 && (
              <>
                <button 
                  onClick={() => {
                    const idx = showPhotoViewer.photos.findIndex(p => p.id === fullscreenPhoto.id);
                    const prevIdx = idx === 0 ? showPhotoViewer.photos.length - 1 : idx - 1;
                    setFullscreenPhoto(showPhotoViewer.photos[prevIdx]);
                  }}
                  style={{ position: 'absolute', left: 20, top: '50%', transform: 'translateY(-50%)', background: 'linear-gradient(135deg, #ffd700, #d4a000)', border: 'none', borderRadius: '50%', width: 60, height: 60, color: '#1a1a2e', fontSize: 28, fontWeight: 'bold', cursor: 'pointer', zIndex: 10, boxShadow: '0 4px 20px rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center' }}
                >‚óÄ</button>
                <button 
                  onClick={() => {
                    const idx = showPhotoViewer.photos.findIndex(p => p.id === fullscreenPhoto.id);
                    const nextIdx = idx === showPhotoViewer.photos.length - 1 ? 0 : idx + 1;
                    setFullscreenPhoto(showPhotoViewer.photos[nextIdx]);
                  }}
                  style={{ position: 'absolute', right: 20, top: '50%', transform: 'translateY(-50%)', background: 'linear-gradient(135deg, #ffd700, #d4a000)', border: 'none', borderRadius: '50%', width: 60, height: 60, color: '#1a1a2e', fontSize: 28, fontWeight: 'bold', cursor: 'pointer', zIndex: 10, boxShadow: '0 4px 20px rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center' }}
                >‚ñ∂</button>
              </>
            )}
            
            <img src={fullscreenPhoto.url} style={{ maxWidth: '100%', maxHeight: 'calc(95vh - 120px)', objectFit: 'contain', borderRadius: 8 }} />
            
            <div style={{ marginTop: 16, display: 'flex', alignItems: 'center', gap: 16, background: 'rgba(30,41,59,0.9)', padding: '12px 20px', borderRadius: 10 }}>
              {showPhotoViewer && showPhotoViewer.photos?.length > 1 && (
                <span style={{ color: '#64748b', fontSize: 13 }}>
                  {showPhotoViewer.photos.findIndex(p => p.id === fullscreenPhoto.id) + 1} / {showPhotoViewer.photos.length}
                </span>
              )}
              <span>{fullscreenPhoto.name}</span>
              <a href={fullscreenPhoto.url} download={fullscreenPhoto.name} className="btn-primary" style={{ textDecoration: 'none', padding: '8px 16px' }}>‚¨á Download</a>
            </div>
            
            {/* Thumbnail strip */}
            {showPhotoViewer && showPhotoViewer.photos?.length > 1 && (
              <div style={{ display: 'flex', gap: 8, marginTop: 12, padding: '8px 12px', background: 'rgba(30,41,59,0.7)', borderRadius: 10 }}>
                {showPhotoViewer.photos.map((p, i) => (
                  <img 
                    key={p.id} 
                    src={p.url} 
                    onClick={() => setFullscreenPhoto(p)}
                    style={{ 
                      width: 50, height: 50, objectFit: 'cover', borderRadius: 6, cursor: 'pointer',
                      border: p.id === fullscreenPhoto.id ? '2px solid #ffd700' : '2px solid transparent',
                      opacity: p.id === fullscreenPhoto.id ? 1 : 0.6
                    }} 
                  />
                ))}
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  );
};

// Theme Context
const ThemeContext = React.createContext();

const useTheme = () => React.useContext(ThemeContext);

// Simple Bar Chart Component
const BarChart = ({ data, title, showValues = true, colorScheme = 'blue' }) => {
  const maxValue = Math.max(...data.map(d => d.value), 1);
  const colors = {
    blue: ['#3b82f6', '#60a5fa', '#93c5fd', '#2563eb', '#1d4ed8', '#1e40af', '#3b82f6', '#60a5fa'],
    green: ['#22c55e', '#4ade80', '#86efac', '#16a34a', '#15803d', '#166534', '#22c55e', '#4ade80'],
    mixed: ['#3b82f6', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899', '#84cc16']
  };
  const colorPalette = colors[colorScheme] || colors.mixed;

  return (
    <div className="chart-container">
      {title && <h4 style={{ marginBottom: 16, color: 'var(--text-primary)' }}>{title}</h4>}
      <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
        {data.map((item, idx) => (
          <div key={idx} style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
            <span style={{ width: 100, fontSize: 12, color: 'var(--text-secondary)', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{item.label}</span>
            <div style={{ flex: 1, background: 'var(--bg-tertiary)', borderRadius: 6, height: 24, overflow: 'hidden' }}>
              <div
                className="chart-bar"
                style={{
                  width: `${(item.value / maxValue) * 100}%`,
                  background: colorPalette[idx % colorPalette.length],
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'flex-end',
                  paddingRight: 8
                }}
              >
                {showValues && item.value > maxValue * 0.15 && (
                  <span style={{ fontSize: 11, color: 'white', fontWeight: 600 }}>{item.displayValue || item.value}</span>
                )}
              </div>
            </div>
            {showValues && item.value <= maxValue * 0.15 && (
              <span style={{ fontSize: 11, color: 'var(--text-muted)', minWidth: 50 }}>{item.displayValue || item.value}</span>
            )}
          </div>
        ))}
      </div>
    </div>
  );
};

// Donut Chart Component
const DonutChart = ({ data, title, size = 160 }) => {
  const total = data.reduce((sum, d) => sum + d.value, 0) || 1;
  const colors = ['#3b82f6', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899', '#84cc16'];
  let cumulativePercent = 0;

  const getCoordinatesForPercent = (percent) => {
    const x = Math.cos(2 * Math.PI * percent);
    const y = Math.sin(2 * Math.PI * percent);
    return [x, y];
  };

  return (
    <div className="chart-container" style={{ textAlign: 'center' }}>
      {title && <h4 style={{ marginBottom: 16, color: 'var(--text-primary)' }}>{title}</h4>}
      <svg width={size} height={size} viewBox="-1 -1 2 2" style={{ transform: 'rotate(-90deg)', margin: '0 auto', display: 'block' }}>
        {data.map((item, idx) => {
          if (item.value === 0) return null;
          const [startX, startY] = getCoordinatesForPercent(cumulativePercent);
          const percent = item.value / total;
          cumulativePercent += percent;
          const [endX, endY] = getCoordinatesForPercent(cumulativePercent);
          const largeArcFlag = percent > 0.5 ? 1 : 0;
          const pathData = `M ${startX} ${startY} A 1 1 0 ${largeArcFlag} 1 ${endX} ${endY} L 0 0`;
          return (
            <path key={idx} d={pathData} fill={colors[idx % colors.length]} style={{ opacity: 0.9 }}>
              <title>{item.label}: {item.displayValue || item.value}</title>
            </path>
          );
        })}
        <circle cx="0" cy="0" r="0.6" fill="var(--bg-card-solid)" />
      </svg>
      <div className="chart-legend" style={{ justifyContent: 'center' }}>
        {data.filter(d => d.value > 0).map((item, idx) => (
          <div key={idx} className="chart-legend-item">
            <div className="chart-legend-dot" style={{ background: colors[idx % colors.length] }} />
            <span>{item.label}</span>
          </div>
        ))}
      </div>
    </div>
  );
};

// Main App with Auth
const App = () => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [theme, setTheme] = useState(() => localStorage.getItem('kassets_theme') || 'dark');

  useEffect(() => {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('kassets_theme', theme);
  }, [theme]);

  useEffect(() => {
    const token = localStorage.getItem('kassets_token');
    const savedUser = localStorage.getItem('kassets_user');
    if (token && savedUser) {
      api('/auth/me').then(u => setUser(u)).catch(() => { localStorage.clear(); }).finally(() => setLoading(false));
    } else {
      setLoading(false);
    }
  }, []);

  const handleLogout = () => { localStorage.removeItem('kassets_token'); localStorage.removeItem('kassets_user'); setUser(null); };
  const toggleTheme = () => setTheme(t => t === 'dark' ? 'light' : 'dark');

  if (loading) return <div style={{ minHeight: '100vh', background: 'var(--bg-secondary)', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'var(--text-muted)' }}>Loading...</div>;
  if (!user) return <LoginPage onLogin={setUser} theme={theme} toggleTheme={toggleTheme} />;
  return (
    <ThemeContext.Provider value={{ theme, toggleTheme }}>
      <AssetManager user={user} onLogout={handleLogout} />
    </ThemeContext.Provider>
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
