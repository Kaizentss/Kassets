<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kassets 2.0 - Multi-Company Asset Management</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #09090b; --bg-secondary: #0f172a; --bg-tertiary: #1e293b;
      --bg-card: rgba(30,41,59,0.7); --bg-card-solid: #1e293b; --bg-input: rgba(15,23,42,0.8);
      --border-color: rgba(148,163,184,0.1); --border-color-hover: rgba(59,130,246,0.3);
      --text-primary: #e2e8f0; --text-secondary: #94a3b8; --text-muted: #64748b;
      --accent-blue: #3b82f6; --accent-green: #34d399; --accent-red: #f87171; --accent-gold: #ffd700;
      --shadow-color: rgba(0,0,0,0.3); --modal-bg: rgba(0,0,0,0.8);
      --gradient-primary: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      --gradient-modal: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    }
    [data-theme="light"] {
      --bg-primary: #f8fafc; --bg-secondary: #f1f5f9; --bg-tertiary: #e2e8f0;
      --bg-card: rgba(255,255,255,0.9); --bg-card-solid: #ffffff; --bg-input: rgba(241,245,249,0.9);
      --border-color: rgba(100,116,139,0.2); --border-color-hover: rgba(59,130,246,0.4);
      --text-primary: #1e293b; --text-secondary: #475569; --text-muted: #64748b;
      --accent-blue: #2563eb; --accent-green: #059669; --accent-red: #dc2626; --accent-gold: #d97706;
      --shadow-color: rgba(0,0,0,0.1); --modal-bg: rgba(0,0,0,0.5);
      --gradient-primary: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f8fafc 100%);
      --gradient-modal: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-primary); color: var(--text-primary); overflow-x: hidden; transition: background 0.3s ease, color 0.3s ease; }
    .glass-card { background: var(--bg-card); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border-color); border-radius: 16px; box-shadow: 0 8px 32px var(--shadow-color); transition: all 0.3s ease; }
    .stat-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px; transition: all 0.3s ease; }
    .stat-card:hover { transform: translateY(-2px); border-color: var(--border-color-hover); }
    .btn-primary { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; padding: 12px 24px; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-family: inherit; font-size: 14px; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59,130,246,0.4); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-secondary { background: var(--bg-card); color: var(--text-secondary); border: 1px solid var(--border-color); padding: 12px 24px; border-radius: 10px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; font-family: inherit; font-size: 14px; }
    .btn-secondary:hover { background: var(--bg-tertiary); color: var(--text-primary); }
    .btn-danger { background: rgba(239,68,68,0.2); color: #f87171; border: 1px solid rgba(239,68,68,0.3); padding: 10px 20px; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; font-family: inherit; }
    .btn-danger:hover { background: rgba(239,68,68,0.3); }
    .btn-gold { background: linear-gradient(135deg, #ffd700, #d4a000); color: #0f172a; border: none; padding: 12px 24px; border-radius: 10px; font-weight: 600; cursor: pointer; font-family: inherit; }
    .btn-gold:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(255,215,0,0.4); }
    .btn-purple { background: linear-gradient(135deg, #8b5cf6, #6d28d9); color: white; border: none; padding: 12px 24px; border-radius: 10px; font-weight: 600; cursor: pointer; font-family: inherit; font-size: 14px; }
    .btn-purple:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(139,92,246,0.4); }
    .input-field { width: 100%; padding: 12px 16px; background: var(--bg-input); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-primary); font-size: 15px; transition: all 0.3s ease; font-family: inherit; outline: none; }
    .input-field:focus { border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
    .input-field::placeholder { color: var(--text-muted); }
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--modal-bg); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
    .modal-content { background: var(--gradient-modal); border: 1px solid var(--border-color); border-radius: 20px; padding: 32px; max-width: 500px; width: 100%; max-height: 85vh; overflow-y: auto; }
    .tab-btn { padding: 12px 20px; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s; border-bottom: 2px solid transparent; font-family: inherit; }
    .tab-btn:hover { color: var(--text-secondary); }
    .tab-btn.active { color: var(--accent-blue); border-bottom-color: var(--accent-blue); }
    .category-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; background: rgba(59,130,246,0.2); color: #60a5fa; }
    .location-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; background: rgba(34,197,94,0.2); color: #4ade80; }
    .role-super { background: rgba(255,215,0,0.2); color: #ffd700; }
    .role-master { background: rgba(168,85,247,0.2); color: #c084fc; }
    .role-admin { background: rgba(239,68,68,0.2); color: #f87171; }
    .role-editor { background: rgba(59,130,246,0.2); color: #60a5fa; }
    .role-viewer { background: rgba(34,197,94,0.2); color: #4ade80; }
    .asset-row { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px 20px; margin-bottom: 12px; transition: all 0.3s; }
    .asset-row:hover { background: var(--bg-tertiary); border-color: var(--border-color-hover); }
    .asset-row.selected { background: rgba(59,130,246,0.15); border-color: rgba(59,130,246,0.4); }
    .company-card { background: rgba(30,41,59,0.5); border: 1px solid rgba(148,163,184,0.1); border-radius: 16px; padding: 24px; transition: all 0.3s; }
    .company-card:hover { border-color: rgba(139,92,246,0.4); transform: translateY(-2px); }
    .company-card.inactive { opacity: 0.5; }
    .chart-container { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 20px; }
    .chart-bar { height: 24px; border-radius: 6px; transition: all 0.3s ease; min-width: 4px; }
    .chart-bar:hover { opacity: 0.8; transform: scaleY(1.05); }
    .theme-toggle { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; font-size: 18px; }
    .theme-toggle:hover { background: var(--bg-tertiary); transform: rotate(15deg); }
    @media (max-width: 768px) { .hide-mobile { display: none !important; } .modal-content { padding: 20px; margin: 10px; max-height: 90vh; } header { padding: 12px 16px !important; } main { padding: 16px !important; } }
    @media (max-width: 480px) { .stat-grid { grid-template-columns: 1fr !important; } }
    @media print {
      * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
      body { background: white !important; color: black !important; font-size: 12pt; }
      header, nav, .btn-primary, .btn-secondary, .btn-danger, .modal-overlay { display: none !important; }
      main { padding: 0 !important; }
      .glass-card { background: white !important; border: 1px solid #ccc !important; box-shadow: none !important; backdrop-filter: none !important; padding: 20px !important; }
      .stat-card, [style*="rgba(15,23,42"] { background: #f5f5f5 !important; border: 1px solid #ddd !important; }
      table { width: 100% !important; border-collapse: collapse !important; }
      th, td { border: 1px solid #ccc !important; padding: 8px !important; color: black !important; }
      th { background: #f0f0f0 !important; }
      tr:last-child { background: #e0e0e0 !important; font-weight: bold !important; }
      @page { margin: 0.5in; size: landscape; }
    }
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect } = React;

// ==================== HELPERS ====================
const api = async (endpoint, options = {}) => {
  const token = localStorage.getItem('kassets_token');
  const res = await fetch('/api' + endpoint, {
    ...options,
    headers: { 'Content-Type': 'application/json', ...(token && { Authorization: 'Bearer ' + token }), ...options.headers }
  });
  const data = await res.json();
  if (!res.ok) throw new Error(data.error || 'Error');
  return data;
};

const roleColors = { super_admin: 'role-super', master_admin: 'role-master', admin: 'role-admin', editor: 'role-editor', viewer: 'role-viewer' };
const roleLabels = { super_admin: 'SUPER ADMIN', master_admin: 'MASTER ADMIN', admin: 'ADMIN', editor: 'EDITOR', viewer: 'VIEWER' };
const formatCurrency = (amt) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amt || 0);

const CoinLogo = ({ size = 56 }) => (
  <svg viewBox="0 0 400 400" width={size} height={size}>
    <defs>
      <linearGradient id="gt" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style={{stopColor:'#ffe566'}}/><stop offset="50%" style={{stopColor:'#ffd700'}}/><stop offset="100%" style={{stopColor:'#e6b800'}}/></linearGradient>
      <linearGradient id="gs" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style={{stopColor:'#d4a000'}}/><stop offset="50%" style={{stopColor:'#b8960b'}}/><stop offset="100%" style={{stopColor:'#8b7000'}}/></linearGradient>
      <linearGradient id="eg" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style={{stopColor:'#ffd700'}}/><stop offset="25%" style={{stopColor:'#ffec80'}}/><stop offset="50%" style={{stopColor:'#f4d03f'}}/><stop offset="75%" style={{stopColor:'#d4a000'}}/><stop offset="100%" style={{stopColor:'#b8860b'}}/></linearGradient>
      <linearGradient id="ee" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style={{stopColor:'#ffec80'}}/><stop offset="50%" style={{stopColor:'#d4a000'}}/><stop offset="100%" style={{stopColor:'#8b6914'}}/></linearGradient>
      <linearGradient id="cf" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style={{stopColor:'#2a2a35'}}/><stop offset="50%" style={{stopColor:'#1a1a22'}}/><stop offset="100%" style={{stopColor:'#12121a'}}/></linearGradient>
      <linearGradient id="ir" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style={{stopColor:'#ffd700'}}/><stop offset="100%" style={{stopColor:'#b8860b'}}/></linearGradient>
    </defs>
    <circle cx="200" cy="200" r="150" fill="url(#eg)"/><circle cx="200" cy="200" r="150" fill="none" stroke="url(#ee)" strokeWidth="8"/>
    <circle cx="200" cy="200" r="130" fill="url(#cf)"/><circle cx="200" cy="200" r="130" fill="none" stroke="url(#ir)" strokeWidth="3"/>
    <g transform="translate(200, 210)">
      <g transform="translate(-60, 0)">{[0,1,2,3,4].map(i => <g key={i}><ellipse cx="0" cy={24-i*8} rx="20" ry="8" fill="url(#gs)"/><ellipse cx="0" cy={20-i*8} rx="20" ry="8" fill="url(#gt)"/></g>)}</g>
      <g transform="translate(-20, -8)">{[0,1,2,3,4,5,6].map(i => <g key={i}><ellipse cx="0" cy={24-i*8} rx="20" ry="8" fill="url(#gs)"/><ellipse cx="0" cy={20-i*8} rx="20" ry="8" fill="url(#gt)"/></g>)}</g>
      <g transform="translate(20, -16)">{[0,1,2,3,4,5,6,7,8].map(i => <g key={i}><ellipse cx="0" cy={24-i*8} rx="20" ry="8" fill="url(#gs)"/><ellipse cx="0" cy={20-i*8} rx="20" ry="8" fill="url(#gt)"/></g>)}</g>
      <g transform="translate(60, -24)">{[0,1,2,3,4,5,6,7,8,9,10].map(i => <g key={i}><ellipse cx="0" cy={24-i*8} rx="20" ry="8" fill="url(#gs)"/><ellipse cx="0" cy={20-i*8} rx="20" ry="8" fill="url(#gt)"/></g>)}</g>
    </g>
  </svg>
);

// ==================== LOGIN ====================
const LoginPage = ({ onLogin, theme, toggleTheme }) => {
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const playCoinSound = () => {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      for (let i = 0; i < 10; i++) {
        const d = i * 0.06 + Math.random() * 0.04;
        const o = ctx.createOscillator(), o2 = ctx.createOscillator(), g = ctx.createGain();
        const f = 1800 + Math.random() * 2500;
        o.frequency.setValueAtTime(f, ctx.currentTime + d); o.frequency.exponentialRampToValueAtTime(500, ctx.currentTime + d + 0.12); o.type = 'sine';
        o2.frequency.setValueAtTime(f * 1.5, ctx.currentTime + d); o2.frequency.exponentialRampToValueAtTime(400, ctx.currentTime + d + 0.1); o2.type = 'triangle';
        g.gain.setValueAtTime(0.2, ctx.currentTime + d); g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + d + 0.2);
        o.connect(g); o2.connect(g); g.connect(ctx.destination);
        o.start(ctx.currentTime + d); o2.start(ctx.currentTime + d); o.stop(ctx.currentTime + d + 0.25); o2.stop(ctx.currentTime + d + 0.25);
      }
    } catch (e) {}
  };

  const handleSubmit = async (e) => {
    e.preventDefault(); setLoading(true); setError('');
    try {
      const data = await api('/auth/login', { method: 'POST', body: JSON.stringify({ username, password }) });
      localStorage.setItem('kassets_token', data.token);
      localStorage.setItem('kassets_user', JSON.stringify(data.user));
      playCoinSound(); onLogin(data.user);
    } catch (err) { setError(err.message); }
    setLoading(false);
  };

  return (
    <div style={{ minHeight: '100vh', background: 'var(--gradient-primary)', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: 20, position: 'relative' }}>
      <button className="theme-toggle" onClick={toggleTheme} style={{ position:'absolute', top:20, right:20 }}>{theme==='dark'?'‚òÄÔ∏è':'üåô'}</button>
      <div style={{ background: 'var(--bg-card)', backdropFilter: 'blur(20px)', border: '1px solid var(--border-color)', borderRadius: 24, padding: 48, width: '100%', maxWidth: 420 }}>
        <div style={{ textAlign: 'center', marginBottom: 32 }}>
          <CoinLogo size={80} />
          <h1 style={{ fontSize: 32, fontWeight: 700, background: 'linear-gradient(135deg, #ffd700, #d4a000)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent', margin: '16px 0 0' }}>KASSETS</h1>
          <p style={{ color: '#64748b', marginTop: 4, fontSize: 13 }}>Multi-Company Asset Management</p>
          <p style={{ color: '#8b5cf6', marginTop: 4, fontSize: 12, fontWeight: 600 }}>v2.0</p>
        </div>
        <form onSubmit={handleSubmit}>
          {error && <div style={{ background: 'rgba(239,68,68,0.1)', border: '1px solid rgba(239,68,68,0.3)', borderRadius: 12, padding: 12, marginBottom: 20, color: '#f87171' }}>{error}</div>}
          <div style={{ marginBottom: 20 }}>
            <label style={{ display: 'block', marginBottom: 8, color: '#94a3b8', fontSize: 14 }}>Username</label>
            <input type="text" className="input-field" value={username} onChange={e => setUsername(e.target.value)} placeholder="Enter username" required />
          </div>
          <div style={{ marginBottom: 28 }}>
            <label style={{ display: 'block', marginBottom: 8, color: '#94a3b8', fontSize: 14 }}>Password</label>
            <input type="password" className="input-field" value={password} onChange={e => setPassword(e.target.value)} placeholder="Enter password" required />
          </div>
          <button type="submit" className="btn-gold" style={{ width: '100%', padding: 16, fontSize: 16 }} disabled={loading}>{loading ? 'Signing in...' : 'Sign In'}</button>
        </form>
      </div>
    </div>
  );
};

// ==================== SUPER ADMIN DASHBOARD ====================
const SuperAdminDashboard = ({ user, onLogout }) => {
  const [companies, setCompanies] = useState([]);
  const [showAddCompany, setShowAddCompany] = useState(false);
  const [showAddMasterAdmin, setShowAddMasterAdmin] = useState(null);
  const [showEditCompany, setShowEditCompany] = useState(null);
  const [showViewCompany, setShowViewCompany] = useState(null);
  const [newCompany, setNewCompany] = useState({ name: '', address: '', phone: '', email: '' });
  const [newMA, setNewMA] = useState({ username: '', password: '', displayName: '', email: '' });
  const [showChangePw, setShowChangePw] = useState(false);
  const [pwData, setPwData] = useState({ current: '', new: '', confirm: '' });
  const [activeTab, setActiveTab] = useState('companies');
  const [allUsers, setAllUsers] = useState([]);
  const [overview, setOverview] = useState(null);
  const [showImportLegacy, setShowImportLegacy] = useState(false);
  const [importData, setImportData] = useState({ companyName: '', file: null, fileName: '', masterUsername: '', masterPassword: '', masterDisplayName: '' });
  const [importLoading, setImportLoading] = useState(false);
  const [importResult, setImportResult] = useState(null);

  useEffect(() => { loadCompanies(); }, []);
  const loadCompanies = async () => { try { setCompanies(await api('/companies')); } catch (e) { console.error(e); } };
  const loadAllUsers = async () => { try { setAllUsers(await api('/all-users')); } catch (e) { console.error(e); } };

  const handleAddCompany = async () => {
    if (!newCompany.name) return alert('Company name required');
    try { await api('/companies', { method: 'POST', body: JSON.stringify(newCompany) }); setShowAddCompany(false); setNewCompany({ name: '', address: '', phone: '', email: '' }); loadCompanies(); } catch (e) { alert(e.message); }
  };

  const handleUpdateCompany = async () => {
    try { await api('/companies/' + showEditCompany.id, { method: 'PUT', body: JSON.stringify(showEditCompany) }); setShowEditCompany(null); loadCompanies(); } catch (e) { alert(e.message); }
  };

  const handleDeleteCompany = async (id) => {
    if (!confirm('Delete this company and all its data?')) return;
    try { await api('/companies/' + id, { method: 'DELETE' }); loadCompanies(); } catch (e) { alert(e.message); }
  };

  const handleAddMA = async () => {
    if (!newMA.username || !newMA.password) return alert('Username and password required');
    try { await api('/companies/' + showAddMasterAdmin.id + '/master-admin', { method: 'POST', body: JSON.stringify(newMA) }); setShowAddMasterAdmin(null); setNewMA({ username: '', password: '', displayName: '', email: '' }); loadCompanies(); } catch (e) { alert(e.message); }
  };

  const handleViewCompany = async (c) => {
    try { const o = await api('/companies/' + c.id + '/overview'); setOverview(o); setShowViewCompany(c); } catch (e) { alert(e.message); }
  };

  const handleDeleteUser = async (userId, companyId) => {
    if (!confirm('Delete this user? This cannot be undone.')) return;
    try { await api('/companies/' + companyId + '/users/' + userId, { method: 'DELETE' }); if (showViewCompany) { handleViewCompany(showViewCompany); } loadCompanies(); if (activeTab === 'all-users') loadAllUsers(); } catch (e) { alert(e.message); }
  };

  const handleChangePw = async () => {
    if (!pwData.current || !pwData.new || !pwData.confirm) return alert('Fill all fields');
    if (pwData.new !== pwData.confirm) return alert('Passwords do not match');
    try { await api('/auth/change-password', { method: 'POST', body: JSON.stringify({ currentPassword: pwData.current, newPassword: pwData.new }) }); alert('Password changed!'); setShowChangePw(false); setPwData({ current: '', new: '', confirm: '' }); } catch (e) { alert(e.message); }
  };

  const handleImportFile = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (evt) => {
      try {
        const parsed = JSON.parse(evt.target.result);
        setImportData(prev => ({ ...prev, file: parsed, fileName: file.name }));
      } catch (err) {
        alert('Invalid JSON file. Please select a valid Kassets v1 data.json file.');
      }
    };
    reader.readAsText(file);
  };

  const handleImportLegacy = async () => {
    if (!importData.file) return alert('Please select a data.json file');
    if (!importData.companyName) return alert('Please enter a company name');
    setImportLoading(true);
    try {
      const payload = {
        legacyData: importData.file,
        companyName: importData.companyName
      };
      if (importData.masterUsername && importData.masterPassword) {
        payload.masterAdmin = {
          username: importData.masterUsername,
          password: importData.masterPassword,
          displayName: importData.masterDisplayName || importData.masterUsername
        };
      }
      const result = await api('/import-legacy', { method: 'POST', body: JSON.stringify(payload) });
      setImportResult(result);
      loadCompanies();
    } catch (e) {
      alert('Import failed: ' + e.message);
    }
    setImportLoading(false);
  };

  const totals = companies.reduce((a, c) => ({ co: a.co+1, assets: a.assets+(c.stats?.assetCount||0), users: a.users+(c.stats?.userCount||0), value: a.value+(c.stats?.totalValue||0) }), { co: 0, assets: 0, users: 0, value: 0 });
  const { theme, toggleTheme } = useTheme ? useTheme() : { theme: 'dark', toggleTheme: () => {} };

  return (
    <div style={{ minHeight: '100vh', background: 'var(--gradient-primary)' }}>
      <header style={{ padding: '16px 24px', borderBottom: '1px solid var(--border-color)', display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: 12 }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
          <CoinLogo size={48} />
          <div>
            <h1 style={{ fontSize: 20, fontWeight: 700, margin: 0, background: 'linear-gradient(135deg, #ffd700, #d4a000)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' }}>KASSETS PLATFORM</h1>
            <p style={{ margin: 0, fontSize: 11, color: '#8b5cf6', fontWeight: 600 }}>Super Admin Console</p>
          </div>
        </div>
        <div style={{ display: 'flex', gap: 8, alignItems: 'center', flexWrap: 'wrap' }}>
          <span style={{ color: '#ffd700', fontSize: 13 }}>üëë {user.displayName || user.username}</span>
          <span className={`category-badge ${roleColors[user.role]}`}>{roleLabels[user.role]}</span>
          <button className="theme-toggle" onClick={toggleTheme} title={theme==='dark'?'Light mode':'Dark mode'}>{theme==='dark'?'‚òÄÔ∏è':'üåô'}</button>
          <button className="btn-secondary" style={{ padding: '8px 12px', fontSize: 12 }} onClick={() => setShowChangePw(true)}>üîë</button>
          <button className="btn-danger" style={{ padding: '8px 12px', fontSize: 12 }} onClick={onLogout}>Logout</button>
        </div>
      </header>

      <nav style={{ padding: '0 24px', borderBottom: '1px solid rgba(148,163,184,0.1)', display: 'flex', gap: 4 }}>
        {['companies', 'all-users'].map(t => (
          <button key={t} className={`tab-btn ${activeTab===t?'active':''}`} onClick={() => { setActiveTab(t); if(t==='all-users') loadAllUsers(); }}>
            {t === 'companies' ? 'üè¢ Companies' : 'üë• All Users'}
          </button>
        ))}
      </nav>

      <main style={{ padding: 24 }}>
        {/* Platform Stats */}
        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: 16, marginBottom: 32 }}>
          <div className="stat-card" style={{ borderLeft: '4px solid #8b5cf6' }}><p style={{ color: '#94a3b8', fontSize: 13, marginBottom: 8 }}>Companies</p><p style={{ fontSize: 28, fontWeight: 700, fontFamily: "'JetBrains Mono', monospace" }}>{totals.co}</p></div>
          <div className="stat-card" style={{ borderLeft: '4px solid #3b82f6' }}><p style={{ color: '#94a3b8', fontSize: 13, marginBottom: 8 }}>Total Users</p><p style={{ fontSize: 28, fontWeight: 700, fontFamily: "'JetBrains Mono', monospace" }}>{totals.users}</p></div>
          <div className="stat-card" style={{ borderLeft: '4px solid #ffd700' }}><p style={{ color: '#94a3b8', fontSize: 13, marginBottom: 8 }}>Total Assets</p><p style={{ fontSize: 28, fontWeight: 700, fontFamily: "'JetBrains Mono', monospace" }}>{totals.assets}</p></div>
          <div className="stat-card" style={{ borderLeft: '4px solid #34d399' }}><p style={{ color: '#94a3b8', fontSize: 13, marginBottom: 8 }}>Platform Value</p><p style={{ fontSize: 22, fontWeight: 700, fontFamily: "'JetBrains Mono', monospace", color: '#34d399' }}>{formatCurrency(totals.value)}</p></div>
        </div>

        {activeTab === 'companies' && (
          <div>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20 }}>
              <h2 style={{ margin: 0 }}>üè¢ Companies</h2>
              <div style={{ display: 'flex', gap: 8 }}>
                <button className="btn-gold" onClick={() => { setShowImportLegacy(true); setImportResult(null); setImportData({ companyName: '', file: null, fileName: '', masterUsername: '', masterPassword: '', masterDisplayName: '' }); }}>üì• Import Legacy DB</button>
                <button className="btn-purple" onClick={() => setShowAddCompany(true)}>+ New Company</button>
              </div>
            </div>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(340px, 1fr))', gap: 20 }}>
              {companies.map(c => (
                <div key={c.id} className={`company-card ${!c.is_active?'inactive':''}`}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 16 }}>
                    <div>
                      <h3 style={{ margin: 0, fontSize: 18 }}>{c.name}</h3>
                      {c.address && <p style={{ margin: '4px 0 0', fontSize: 12, color: '#64748b' }}>{c.address}</p>}
                      {!c.is_active && <span style={{ color: '#f87171', fontSize: 12, fontWeight: 600 }}>INACTIVE</span>}
                    </div>
                    <span style={{ fontSize: 11, color: '#64748b' }}>ID: {c.id}</span>
                  </div>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 12, marginBottom: 16 }}>
                    {[{l:'Users',v:c.stats?.userCount||0},{l:'Assets',v:c.stats?.assetCount||0},{l:'Value',v:formatCurrency(c.stats?.totalValue||0),c:'#34d399'}].map((s,i) => (
                      <div key={i} style={{ background: 'rgba(15,23,42,0.5)', borderRadius: 10, padding: 10, textAlign: 'center' }}>
                        <p style={{ color: '#64748b', fontSize: 10, margin: 0 }}>{s.l}</p>
                        <p style={{ fontSize: s.c?13:18, fontWeight: 700, margin: '2px 0 0', fontFamily: "'JetBrains Mono', monospace", color: s.c }}>{s.v}</p>
                      </div>
                    ))}
                  </div>
                  <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap' }}>
                    <button className="btn-primary" style={{ padding: '8px 12px', fontSize: 12, flex: 1 }} onClick={() => handleViewCompany(c)}>üëÅ View</button>
                    <button className="btn-purple" style={{ padding: '8px 12px', fontSize: 12, flex: 1 }} onClick={() => setShowAddMasterAdmin(c)}>üë§+ Master</button>
                    <button className="btn-secondary" style={{ padding: '8px 12px', fontSize: 12 }} onClick={() => setShowEditCompany({...c})}>‚úèÔ∏è</button>
                    <button className="btn-danger" style={{ padding: '8px 12px', fontSize: 12 }} onClick={() => handleDeleteCompany(c.id)}>üóë</button>
                  </div>
                </div>
              ))}
              {companies.length === 0 && (
                <div className="glass-card" style={{ padding: 40, textAlign: 'center', gridColumn: '1/-1' }}>
                  <p style={{ color: '#64748b', fontSize: 16, marginBottom: 16 }}>No companies yet.</p>
                  <button className="btn-purple" onClick={() => setShowAddCompany(true)}>+ Create Company</button>
                </div>
              )}
            </div>
          </div>
        )}

        {activeTab === 'all-users' && (
          <div>
            <h2 style={{ margin: '0 0 20px' }}>üë• All Platform Users</h2>
            {allUsers.map(u => (
              <div key={u.id} className="asset-row" style={{ opacity: u.is_active ? 1 : 0.5 }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: 8 }}>
                  <div><strong>{u.display_name || u.username}</strong> <span style={{ color: '#64748b', fontSize: 13 }}>@{u.username}</span></div>
                  <div style={{ display: 'flex', gap: 8, alignItems: 'center' }}>
                    <span className={`category-badge ${roleColors[u.role]}`}>{roleLabels[u.role]}</span>
                    <span className="location-badge">{u.company_name || 'Platform'}</span>
                    {!u.is_active && <span style={{ color: '#f87171', fontSize: 12 }}>INACTIVE</span>}
                    {u.role !== 'super_admin' && u.company_id && <button className="btn-danger" style={{ padding: '4px 8px', fontSize: 11 }} onClick={() => handleDeleteUser(u.id, u.company_id)}>üóë</button>}
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </main>

      {/* Add Company Modal */}
      {showAddCompany && (
        <div className="modal-overlay" onClick={() => setShowAddCompany(false)}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <h2 style={{ marginBottom: 20 }}>üè¢ New Company</h2>
            <input className="input-field" placeholder="Company Name *" value={newCompany.name} onChange={e => setNewCompany({...newCompany, name: e.target.value})} style={{ marginBottom: 12 }} />
            <input className="input-field" placeholder="Address" value={newCompany.address} onChange={e => setNewCompany({...newCompany, address: e.target.value})} style={{ marginBottom: 12 }} />
            <input className="input-field" placeholder="Phone" value={newCompany.phone} onChange={e => setNewCompany({...newCompany, phone: e.target.value})} style={{ marginBottom: 12 }} />
            <input className="input-field" placeholder="Email" value={newCompany.email} onChange={e => setNewCompany({...newCompany, email: e.target.value})} style={{ marginBottom: 20 }} />
            <p style={{ fontSize: 12, color: '#64748b', marginBottom: 16 }}>Default categories and a main office location will be created automatically.</p>
            <div style={{ display: 'flex', gap: 12, justifyContent: 'flex-end' }}>
              <button className="btn-secondary" onClick={() => setShowAddCompany(false)}>Cancel</button>
              <button className="btn-purple" onClick={handleAddCompany}>Create Company</button>
            </div>
          </div>
        </div>
      )}

      {/* Edit Company Modal */}
      {showEditCompany && (
        <div className="modal-overlay" onClick={() => setShowEditCompany(null)}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <h2 style={{ marginBottom: 20 }}>‚úèÔ∏è Edit Company</h2>
            <input className="input-field" placeholder="Company Name" value={showEditCompany.name} onChange={e => setShowEditCompany({...showEditCompany, name: e.target.value})} style={{ marginBottom: 12 }} />
            <input className="input-field" placeholder="Address" value={showEditCompany.address||''} onChange={e => setShowEditCompany({...showEditCompany, address: e.target.value})} style={{ marginBottom: 12 }} />
            <input className="input-field" placeholder="Phone" value={showEditCompany.phone||''} onChange={e => setShowEditCompany({...showEditCompany, phone: e.target.value})} style={{ marginBottom: 12 }} />
            <input className="input-field" placeholder="Email" value={showEditCompany.email||''} onChange={e => setShowEditCompany({...showEditCompany, email: e.target.value})} style={{ marginBottom: 12 }} />
            <label style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 20, cursor: 'pointer', color: '#94a3b8' }}>
              <input type="checkbox" checked={showEditCompany.is_active} onChange={e => setShowEditCompany({...showEditCompany, is_active: e.target.checked?1:0})} /> Company Active
            </label>
            <div style={{ display: 'flex', gap: 12, justifyContent: 'flex-end' }}>
              <button className="btn-secondary" onClick={() => setShowEditCompany(null)}>Cancel</button>
              <button className="btn-primary" onClick={handleUpdateCompany}>Save</button>
            </div>
          </div>
        </div>
      )}

      {/* Add Master Admin */}
      {showAddMasterAdmin && (
        <div className="modal-overlay" onClick={() => setShowAddMasterAdmin(null)}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <h2 style={{ marginBottom: 8 }}>üë§ New Master Admin</h2>
            <p style={{ color: '#94a3b8', fontSize: 14, marginBottom: 20 }}>for <strong style={{ color: '#c084fc' }}>{showAddMasterAdmin.name}</strong></p>
            <input className="input-field" placeholder="Username *" value={newMA.username} onChange={e => setNewMA({...newMA, username: e.target.value})} style={{ marginBottom: 12 }} />
            <input className="input-field" type="password" placeholder="Password *" value={newMA.password} onChange={e => setNewMA({...newMA, password: e.target.value})} style={{ marginBottom: 12 }} />
            <input className="input-field" placeholder="Display Name" value={newMA.displayName} onChange={e => setNewMA({...newMA, displayName: e.target.value})} style={{ marginBottom: 12 }} />
            <input className="input-field" placeholder="Email" value={newMA.email} onChange={e => setNewMA({...newMA, email: e.target.value})} style={{ marginBottom: 20 }} />
            <div style={{ display: 'flex', gap: 12, justifyContent: 'flex-end' }}>
              <button className="btn-secondary" onClick={() => setShowAddMasterAdmin(null)}>Cancel</button>
              <button className="btn-purple" onClick={handleAddMA}>Create Master Admin</button>
            </div>
          </div>
        </div>
      )}

      {/* View Company Overview */}
      {showViewCompany && overview && (
        <div className="modal-overlay" onClick={() => { setShowViewCompany(null); setOverview(null); }}>
          <div className="modal-content" onClick={e => e.stopPropagation()} style={{ maxWidth: 700, maxHeight: '90vh' }}>
            <h2 style={{ marginBottom: 4 }}>üè¢ {showViewCompany.name}</h2>
            <p style={{ color: '#64748b', fontSize: 13, marginBottom: 20 }}>{showViewCompany.address || 'No address'}</p>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 12, marginBottom: 20 }}>
              {[{l:'Users',v:overview.stats.userCount},{l:'Assets',v:overview.stats.assetCount},{l:'Locations',v:overview.stats.locationCount},{l:'Value',v:formatCurrency(overview.stats.totalValue),c:'#34d399'}].map((s,i) => (
                <div key={i} style={{ background: 'rgba(15,23,42,0.5)', borderRadius: 10, padding: 12, textAlign: 'center' }}>
                  <p style={{ color: '#64748b', fontSize: 10, margin: 0 }}>{s.l}</p>
                  <p style={{ fontSize: s.c?14:20, fontWeight: 700, margin: '4px 0 0', color: s.c, fontFamily: "'JetBrains Mono', monospace" }}>{s.v}</p>
                </div>
              ))}
            </div>
            <h3 style={{ fontSize: 15, marginBottom: 12, color: '#94a3b8' }}>Users ({overview.users.length})</h3>
            <div style={{ marginBottom: 20, maxHeight: 200, overflowY: 'auto' }}>
              {overview.users.map(u => (
                <div key={u.id} style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid rgba(148,163,184,0.1)', alignItems: 'center' }}>
                  <span>{u.display_name || u.username} <span style={{ color: '#64748b', fontSize: 12 }}>@{u.username}</span></span>
                  <div style={{ display: 'flex', gap: 8, alignItems: 'center' }}>
                    <span className={`category-badge ${roleColors[u.role]}`} style={{ fontSize: 11 }}>{roleLabels[u.role]}</span>
                    <button className="btn-danger" style={{ padding: '4px 8px', fontSize: 11 }} onClick={() => handleDeleteUser(u.id, showViewCompany.id)}>üóë</button>
                  </div>
                </div>
              ))}
            </div>
            <h3 style={{ fontSize: 15, marginBottom: 12, color: '#94a3b8' }}>Assets ({overview.assets.length})</h3>
            <div style={{ maxHeight: 200, overflowY: 'auto' }}>
              {overview.assets.slice(0, 25).map(a => (
                <div key={a.id} style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid rgba(148,163,184,0.1)', fontSize: 13 }}>
                  <span>{a.name} <span style={{ color: '#64748b' }}>x{a.quantity}</span></span>
                  <span style={{ fontFamily: "'JetBrains Mono', monospace", color: '#34d399' }}>{formatCurrency(a.current_value * a.quantity)}</span>
                </div>
              ))}
              {overview.assets.length > 25 && <p style={{ color: '#64748b', fontSize: 12, marginTop: 8 }}>...and {overview.assets.length - 25} more</p>}
            </div>
            <div style={{ marginTop: 20, textAlign: 'right' }}><button className="btn-secondary" onClick={() => { setShowViewCompany(null); setOverview(null); }}>Close</button></div>
          </div>
        </div>
      )}

      {/* Change Password */}
      {showChangePw && (
        <div className="modal-overlay" onClick={() => setShowChangePw(false)}>
          <div className="modal-content" onClick={e => e.stopPropagation()} style={{ maxWidth: 400 }}>
            <h2 style={{ marginBottom: 20 }}>üîë Change Password</h2>
            <input className="input-field" type="password" placeholder="Current Password" value={pwData.current} onChange={e => setPwData({...pwData, current: e.target.value})} style={{ marginBottom: 12 }} />
            <input className="input-field" type="password" placeholder="New Password" value={pwData.new} onChange={e => setPwData({...pwData, new: e.target.value})} style={{ marginBottom: 12 }} />
            <input className="input-field" type="password" placeholder="Confirm New Password" value={pwData.confirm} onChange={e => setPwData({...pwData, confirm: e.target.value})} style={{ marginBottom: 20 }} />
            <div style={{ display: 'flex', gap: 12, justifyContent: 'flex-end' }}>
              <button className="btn-secondary" onClick={() => setShowChangePw(false)}>Cancel</button>
              <button className="btn-primary" onClick={handleChangePw}>Change</button>
            </div>
          </div>
        </div>
      )}

      {/* Import Legacy Database */}
      {showImportLegacy && (
        <div className="modal-overlay" onClick={() => { if (!importLoading) setShowImportLegacy(false); }}>
          <div className="modal-content" onClick={e => e.stopPropagation()} style={{ maxWidth: 550 }}>
            {!importResult ? (
              <>
                <h2 style={{ marginBottom: 4 }}>üì• Import Legacy Database</h2>
                <p style={{ color: '#64748b', fontSize: 13, marginBottom: 20 }}>Import a Kassets v1 data.json file as a new company</p>

                <label style={{ display: 'block', marginBottom: 6, color: '#94a3b8', fontSize: 13 }}>Company Name *</label>
                <input className="input-field" placeholder="e.g. Kaizen Automotive" value={importData.companyName} onChange={e => setImportData({...importData, companyName: e.target.value})} style={{ marginBottom: 16 }} />

                <label style={{ display: 'block', marginBottom: 6, color: '#94a3b8', fontSize: 13 }}>Legacy data.json File *</label>
                <div style={{ position: 'relative', marginBottom: 16 }}>
                  <input type="file" accept=".json" onChange={handleImportFile} style={{ display: 'none' }} id="legacy-file-input" />
                  <button className="btn-secondary" onClick={() => document.getElementById('legacy-file-input').click()} style={{ width: '100%', textAlign: 'left', padding: '14px 16px' }}>
                    {importData.fileName ? `‚úÖ ${importData.fileName}` : 'üìÅ Choose data.json file...'}
                  </button>
                  {importData.file && (
                    <div style={{ marginTop: 8, padding: 12, background: 'rgba(34,197,94,0.1)', border: '1px solid rgba(34,197,94,0.2)', borderRadius: 8, fontSize: 12, color: '#4ade80' }}>
                      Found: {importData.file.assets?.length || 0} assets, {importData.file.locations?.length || 0} locations, {importData.file.users?.length || 0} users, {importData.file.categories?.length || 0} categories
                    </div>
                  )}
                </div>

                <div style={{ background: 'rgba(139,92,246,0.1)', border: '1px solid rgba(139,92,246,0.2)', borderRadius: 10, padding: 16, marginBottom: 16 }}>
                  <p style={{ color: '#c084fc', fontSize: 13, fontWeight: 600, marginBottom: 8 }}>üë§ Master Admin (Optional)</p>
                  <p style={{ color: '#64748b', fontSize: 12, marginBottom: 12 }}>Create a master admin for the imported company. Leave blank to assign later.</p>
                  <input className="input-field" placeholder="Username" value={importData.masterUsername} onChange={e => setImportData({...importData, masterUsername: e.target.value})} style={{ marginBottom: 8, fontSize: 13 }} />
                  <input className="input-field" type="password" placeholder="Password" value={importData.masterPassword} onChange={e => setImportData({...importData, masterPassword: e.target.value})} style={{ marginBottom: 8, fontSize: 13 }} />
                  <input className="input-field" placeholder="Display Name" value={importData.masterDisplayName} onChange={e => setImportData({...importData, masterDisplayName: e.target.value})} style={{ fontSize: 13 }} />
                </div>

                <div style={{ display: 'flex', gap: 12, justifyContent: 'flex-end' }}>
                  <button className="btn-secondary" onClick={() => setShowImportLegacy(false)} disabled={importLoading}>Cancel</button>
                  <button className="btn-gold" onClick={handleImportLegacy} disabled={importLoading || !importData.file || !importData.companyName} style={{ minWidth: 140 }}>
                    {importLoading ? '‚è≥ Importing...' : 'üì• Import Now'}
                  </button>
                </div>
              </>
            ) : (
              <>
                <div style={{ textAlign: 'center', marginBottom: 20 }}>
                  <div style={{ fontSize: 48, marginBottom: 8 }}>‚úÖ</div>
                  <h2 style={{ margin: 0 }}>Import Successful!</h2>
                  <p style={{ color: '#64748b', fontSize: 14, marginTop: 4 }}>{importResult.companyName} has been created</p>
                </div>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 10, marginBottom: 16 }}>
                  {[
                    { l: 'Assets', v: importResult.imported.assets, icon: 'üì¶' },
                    { l: 'Locations', v: importResult.imported.locations, icon: 'üìç' },
                    { l: 'Categories', v: importResult.imported.categories, icon: 'üè∑Ô∏è' },
                    { l: 'Photos', v: importResult.imported.photos, icon: 'üì∑' },
                    { l: 'Notes', v: importResult.imported.notes, icon: 'üìù' },
                    { l: 'Users', v: importResult.imported.users?.length || 0, icon: 'üë§' }
                  ].map((s, i) => (
                    <div key={i} style={{ background: 'rgba(15,23,42,0.5)', borderRadius: 10, padding: 12, textAlign: 'center' }}>
                      <p style={{ fontSize: 20, margin: 0 }}>{s.icon}</p>
                      <p style={{ fontSize: 22, fontWeight: 700, margin: '4px 0', fontFamily: "'JetBrains Mono', monospace", color: '#34d399' }}>{s.v}</p>
                      <p style={{ color: '#64748b', fontSize: 11, margin: 0 }}>{s.l}</p>
                    </div>
                  ))}
                </div>
                {importResult.imported.users?.length > 0 && (
                  <div style={{ marginBottom: 16 }}>
                    <p style={{ color: '#94a3b8', fontSize: 13, fontWeight: 600, marginBottom: 8 }}>User Import Details:</p>
                    <div style={{ maxHeight: 150, overflowY: 'auto', background: 'rgba(15,23,42,0.5)', borderRadius: 8, padding: 8 }}>
                      {importResult.imported.users.map((u, i) => (
                        <div key={i} style={{ display: 'flex', justifyContent: 'space-between', padding: '6px 8px', borderBottom: '1px solid rgba(148,163,184,0.1)', fontSize: 13 }}>
                          <span>@{u.username}</span>
                          <span style={{ color: u.status === 'imported' ? '#4ade80' : u.status === 'created' ? '#c084fc' : '#fbbf24' }}>
                            {u.status === 'imported' ? `‚úÖ ${u.role}` : u.status === 'created' ? `üÜï ${u.role}` : `‚ö†Ô∏è ${u.reason}`}
                          </span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
                <div style={{ textAlign: 'right' }}>
                  <button className="btn-primary" onClick={() => { setShowImportLegacy(false); setImportResult(null); }}>Done</button>
                </div>
              </>
            )}
          </div>
        </div>
      )}
    </div>
  );
};

// ==================== USER MANAGEMENT ====================
const UserManagement = ({ currentUser, onClose }) => {
  const [users, setUsers] = useState([]);
  const [showAdd, setShowAdd] = useState(false);
  const [newUser, setNewUser] = useState({ username: '', password: '', displayName: '', role: 'viewer' });
  const [editUser, setEditUser] = useState(null);

  useEffect(() => { loadUsers(); }, []);
  const loadUsers = async () => { try { setUsers(await api('/users')); } catch(e) { console.error(e); } };

  const getAvailableRoles = () => {
    if (currentUser.role === 'master_admin') return ['master_admin', 'admin', 'editor', 'viewer'];
    if (currentUser.role === 'admin') return ['editor', 'viewer'];
    return ['viewer'];
  };
  const availableRoles = getAvailableRoles();

  const handleAdd = async () => {
    if (!newUser.username || !newUser.password) return alert('Username and password required');
    try { await api('/users', { method: 'POST', body: JSON.stringify(newUser) }); setShowAdd(false); setNewUser({ username: '', password: '', displayName: '', role: 'viewer' }); loadUsers(); } catch(e) { alert(e.message); }
  };

  const handleUpdate = async () => {
    try { await api('/users/' + editUser.id, { method: 'PUT', body: JSON.stringify({ displayName: editUser.display_name, email: editUser.email, role: editUser.role, isActive: editUser.is_active }) }); setEditUser(null); loadUsers(); } catch(e) { alert(e.message); }
  };

  const handleResetPw = async (id) => {
    const pw = prompt('New password (min 6 characters):');
    if (pw && pw.length >= 6) { try { await api('/users/' + id + '/reset-password', { method: 'POST', body: JSON.stringify({ newPassword: pw }) }); alert('Password reset!'); } catch(e) { alert(e.message); } }
  };

  const handleDelete = async (id) => {
    if (!confirm('Delete this user?')) return;
    try { await api('/users/' + id, { method: 'DELETE' }); loadUsers(); } catch(e) { alert(e.message); }
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content" onClick={e => e.stopPropagation()} style={{ maxWidth: 700 }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 24 }}>
          <h2 style={{ margin: 0 }}>üë• User Management</h2>
          <button className="btn-primary" onClick={() => setShowAdd(true)}>+ Add User</button>
        </div>
        <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
          {users.map(u => (
            <div key={u.id} style={{ background: 'rgba(30,41,59,0.5)', borderRadius: 12, padding: 16, display: 'flex', justifyContent: 'space-between', alignItems: 'center', opacity: u.is_active?1:0.5, flexWrap: 'wrap', gap: 8 }}>
              <div>
                <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                  <strong>{u.display_name || u.username}</strong>
                  <span className={`category-badge ${roleColors[u.role]}`} style={{ fontSize: 11 }}>{roleLabels[u.role]}</span>
                  {!u.is_active && <span style={{ color: '#f87171', fontSize: 12 }}>INACTIVE</span>}
                </div>
                <p style={{ margin: '4px 0 0', fontSize: 13, color: '#64748b' }}>@{u.username}</p>
              </div>
              <div style={{ display: 'flex', gap: 8 }}>
                <button className="btn-secondary" style={{ padding: '8px 12px' }} onClick={() => setEditUser({...u})}>Edit</button>
                {u.id !== currentUser.id && <button className="btn-secondary" style={{ padding: '8px 12px' }} onClick={() => handleResetPw(u.id)}>Reset PW</button>}
                {u.id !== currentUser.id && <button className="btn-danger" style={{ padding: '8px 10px', fontSize: 12 }} onClick={() => handleDelete(u.id)}>üóë</button>}
              </div>
            </div>
          ))}
        </div>
        <div style={{ marginTop: 24, textAlign: 'right' }}><button className="btn-secondary" onClick={onClose}>Close</button></div>
        
        {showAdd && (
          <div className="modal-overlay" onClick={() => setShowAdd(false)}>
            <div className="modal-content" onClick={e => e.stopPropagation()} style={{ maxWidth: 400 }}>
              <h3 style={{ marginBottom: 20 }}>Add User</h3>
              <input className="input-field" placeholder="Username *" value={newUser.username} onChange={e => setNewUser({...newUser, username: e.target.value})} style={{ marginBottom: 12 }} />
              <input className="input-field" type="password" placeholder="Password *" value={newUser.password} onChange={e => setNewUser({...newUser, password: e.target.value})} style={{ marginBottom: 12 }} />
              <input className="input-field" placeholder="Display Name" value={newUser.displayName} onChange={e => setNewUser({...newUser, displayName: e.target.value})} style={{ marginBottom: 12 }} />
              <select className="input-field" value={newUser.role} onChange={e => setNewUser({...newUser, role: e.target.value})} style={{ marginBottom: 20 }}>
                {availableRoles.map(r => <option key={r} value={r}>{roleLabels[r]}</option>)}
              </select>
              <div style={{ display: 'flex', gap: 12, justifyContent: 'flex-end' }}>
                <button className="btn-secondary" onClick={() => setShowAdd(false)}>Cancel</button>
                <button className="btn-primary" onClick={handleAdd}>Add</button>
              </div>
            </div>
          </div>
        )}

        {editUser && (
          <div className="modal-overlay" onClick={() => setEditUser(null)}>
            <div className="modal-content" onClick={e => e.stopPropagation()} style={{ maxWidth: 400 }}>
              <h3 style={{ marginBottom: 20 }}>Edit: {editUser.username}</h3>
              <input className="input-field" placeholder="Display Name" value={editUser.display_name||''} onChange={e => setEditUser({...editUser, display_name: e.target.value})} style={{ marginBottom: 12 }} />
              <select className="input-field" value={editUser.role} onChange={e => setEditUser({...editUser, role: e.target.value})} style={{ marginBottom: 12 }} disabled={editUser.id === currentUser.id}>
                {availableRoles.map(r => <option key={r} value={r}>{roleLabels[r]}</option>)}
                {!availableRoles.includes(editUser.role) && <option value={editUser.role}>{roleLabels[editUser.role]}</option>}
              </select>
              {editUser.id !== currentUser.id && (
                <label style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 20, cursor: 'pointer' }}>
                  <input type="checkbox" checked={editUser.is_active} onChange={e => setEditUser({...editUser, is_active: e.target.checked?1:0})} /> Active
                </label>
              )}
              <div style={{ display: 'flex', gap: 12, justifyContent: 'flex-end' }}>
                <button className="btn-secondary" onClick={() => setEditUser(null)}>Cancel</button>
                <button className="btn-primary" onClick={handleUpdate}>Save</button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

// ==================== ASSET MANAGER (company-scoped) ====================
const AssetManager = ({ user, onLogout }) => {
  const [assets, setAssets] = useState([]);
  const [locations, setLocations] = useState([]);
  const [categories, setCategories] = useState([]);
  const [companyName, setCompanyName] = useState('');
  const [activeTab, setActiveTab] = useState('dashboard');
  const [filterLocation, setFilterLocation] = useState('all');
  const [filterCategory, setFilterCategory] = useState('all');
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedAssets, setSelectedAssets] = useState([]);
  const [showAddAsset, setShowAddAsset] = useState(false);
  const [showAddLocation, setShowAddLocation] = useState(false);
  const [showSettings, setShowSettings] = useState(false);
  const [showUserMgmt, setShowUserMgmt] = useState(false);
  const [showManageCategories, setShowManageCategories] = useState(false);
  const [showExportModal, setShowExportModal] = useState(false);
  const [exportProgress, setExportProgress] = useState(null); // null or { current, total, status }
  const [showBulkTransfer, setShowBulkTransfer] = useState(false);
  const [showBulkDelete, setShowBulkDelete] = useState(false);
  const [showBulkCategory, setShowBulkCategory] = useState(false);
  const [bulkTransferTo, setBulkTransferTo] = useState('');
  const [bulkCategoryTo, setBulkCategoryTo] = useState('');
  const [editingAsset, setEditingAsset] = useState(null);
  const [editingLocation, setEditingLocation] = useState(null);
  const [showNotesModal, setShowNotesModal] = useState(null);
  const [showPhotoViewer, setShowPhotoViewer] = useState(null);
  const [fullscreenPhoto, setFullscreenPhoto] = useState(null);
  const [newNote, setNewNote] = useState('');
  const [newCategory, setNewCategory] = useState('');
  const [editingCategory, setEditingCategory] = useState(null);
  const [editingCategoryName, setEditingCategoryName] = useState('');
  const [newAsset, setNewAsset] = useState({ name:'', category:'', purchaseDate:'', purchaseCost:0, currentValue:0, quantity:1, locationId:'', description:'', serialNumber:'', partNumber:'', depreciationRate:10, photos:[] });
  const [newLocation, setNewLocation] = useState({ name:'', address:'' });
  const [showChangePw, setShowChangePw] = useState(false);
  const [pwData, setPwData] = useState({ current:'', new:'', confirm:'' });
  const [brandColor, setBrandColor] = useState('#ffd700');
  const [bgColor1, setBgColor1] = useState('#0f172a');
  const [bgColor2, setBgColor2] = useState('#1e293b');

  const canEditData = ['master_admin','admin','editor'].includes(user.role);
  const isAdminRole = ['master_admin','admin'].includes(user.role);

  useEffect(() => { loadAllData(); }, []);

  const loadAllData = async () => {
    try {
      const [a,l,c,s] = await Promise.all([api('/assets'), api('/locations'), api('/categories'), api('/settings')]);
      setAssets(a.map(x => ({ id:x.id, name:x.name, category:x.category, serialNumber:x.serial_number, partNumber:x.part_number, description:x.description, purchaseDate:x.purchase_date, purchaseCost:x.purchase_cost, currentValue:x.current_value, quantity:x.quantity, depreciationRate:x.depreciation_rate, locationId:x.location_id, photos:x.photos||[], notes:x.notes||[] })));
      setLocations(l.map(x => ({ id:x.id, name:x.name, address:x.address })));
      setCategories(c.map(x => x.name));
      setCompanyName(s.company_name || '');
      if (s.brand_color) setBrandColor(s.brand_color);
      if (s.bg_color_1) setBgColor1(s.bg_color_1);
      if (s.bg_color_2) setBgColor2(s.bg_color_2);
    } catch (e) { console.error('Load error:', e); }
  };

  const getLocationName = (id) => locations.find(l => l.id === id)?.name || 'Unknown';
  const calculateTotals = () => {
    const f = filterLocation === 'all' ? assets : assets.filter(a => a.locationId === parseInt(filterLocation));
    return f.reduce((acc,a) => ({ totalPurchaseCost: acc.totalPurchaseCost+(a.purchaseCost*a.quantity), totalCurrentValue: acc.totalCurrentValue+(a.currentValue*a.quantity), totalAssets: acc.totalAssets+a.quantity }), { totalPurchaseCost:0, totalCurrentValue:0, totalAssets:0 });
  };

  const filteredAssets = assets.filter(a => {
    const ml = filterLocation==='all' || a.locationId===parseInt(filterLocation);
    const mc = filterCategory==='all' || a.category===filterCategory;
    const ms = a.name.toLowerCase().includes(searchTerm.toLowerCase()) || a.category?.toLowerCase().includes(searchTerm.toLowerCase()) || a.serialNumber?.toLowerCase().includes(searchTerm.toLowerCase()) || a.partNumber?.toLowerCase().includes(searchTerm.toLowerCase());
    return ml && mc && ms;
  }).sort((a,b) => a.name.localeCompare(b.name));

  // CRUD handlers
  const handleAddAsset = async () => {
    if (!newAsset.name) return alert('Name required');
    try {
      const d = { ...newAsset, purchaseCost:parseFloat(newAsset.purchaseCost)||0, currentValue:parseFloat(newAsset.currentValue)||0, quantity:parseInt(newAsset.quantity)||1 };
      delete d.photos;
      const r = await api('/assets', { method:'POST', body:JSON.stringify(d) });
      if (newAsset.photos?.length > 0) { for (const p of newAsset.photos) { await api('/assets/'+r.id+'/photos', { method:'POST', body:JSON.stringify({ url:p.url, name:p.name }) }); } }
      setShowAddAsset(false); setNewAsset({ name:'', category:'', purchaseDate:'', purchaseCost:0, currentValue:0, quantity:1, locationId:'', description:'', serialNumber:'', partNumber:'', depreciationRate:10, photos:[] }); loadAllData();
    } catch (e) { alert(e.message); }
  };

  const handleUpdateAsset = async () => {
    try {
      const orig = assets.find(a => a.id === editingAsset.id);
      const notes = [];
      const ts = new Date().toLocaleString('en-US',{year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
      const un = user.displayName || user.username;
      if (orig && parseInt(editingAsset.quantity) !== parseInt(orig.quantity)) {
        const od=parseInt(orig.quantity), nd=parseInt(editingAsset.quantity), df=nd-od;
        notes.push(df<0?`üì¶ QTY DEDUCTED: ${Math.abs(df)} removed (${od}‚Üí${nd}) by ${un} on ${ts}`:`üì¶ QTY ADDED: ${df} added (${od}‚Üí${nd}) by ${un} on ${ts}`);
      }
      if (orig && parseInt(editingAsset.locationId) !== parseInt(orig.locationId)) {
        notes.push(`üìç MOVED: ${getLocationName(parseInt(orig.locationId))} ‚Üí ${getLocationName(parseInt(editingAsset.locationId))} by ${un} on ${ts}`);
      }
      await api('/assets/'+editingAsset.id, { method:'PUT', body:JSON.stringify({ name:editingAsset.name, category:editingAsset.category, serialNumber:editingAsset.serialNumber, partNumber:editingAsset.partNumber, description:editingAsset.description, purchaseDate:editingAsset.purchaseDate, purchaseCost:editingAsset.purchaseCost, currentValue:editingAsset.currentValue, quantity:editingAsset.quantity, depreciationRate:editingAsset.depreciationRate, locationId:editingAsset.locationId }) });
      for (const n of notes) { await api('/assets/'+editingAsset.id+'/notes', { method:'POST', body:JSON.stringify({text:n}) }); }
      setEditingAsset(null); loadAllData();
    } catch (e) { alert(e.message); }
  };

  const handleDeleteAsset = async (id) => { if (!confirm('Delete this asset?')) return; try { await api('/assets/'+id,{method:'DELETE'}); loadAllData(); } catch(e){ alert(e.message); } };
  const handleDuplicate = async (a) => { try { await api('/assets',{method:'POST',body:JSON.stringify({name:a.name+' (Copy)',category:a.category,serialNumber:'',partNumber:a.partNumber,description:a.description,purchaseDate:a.purchaseDate,purchaseCost:a.purchaseCost,currentValue:a.currentValue,quantity:a.quantity,depreciationRate:a.depreciationRate,locationId:a.locationId})}); loadAllData(); } catch(e){ alert(e.message); } };
  
  const handleDeletePhoto = async (aid,pid) => { if(!confirm('Delete photo?')) return; try { await api('/assets/'+aid+'/photos/'+pid,{method:'DELETE'}); loadAllData(); if(editingAsset){const u=(await api('/assets')).find(a=>a.id===aid);if(u)setEditingAsset({...editingAsset,photos:u.photos||[]});} } catch(e){ alert(e.message); } };
  
  const handleBulkTransfer = async () => { if(!bulkTransferTo) return; try { await api('/assets/bulk-transfer',{method:'POST',body:JSON.stringify({assetIds:selectedAssets,locationId:parseInt(bulkTransferTo)})}); setShowBulkTransfer(false); setSelectedAssets([]); setBulkTransferTo(''); loadAllData(); } catch(e){ alert(e.message); } };
  const handleBulkCategory = async () => { if(!bulkCategoryTo) return; try { await api('/assets/bulk-category',{method:'POST',body:JSON.stringify({assetIds:selectedAssets,category:bulkCategoryTo})}); setShowBulkCategory(false); setSelectedAssets([]); setBulkCategoryTo(''); loadAllData(); } catch(e){ alert(e.message); } };
  const handleBulkDelete = async () => { try { await api('/assets/bulk-delete',{method:'POST',body:JSON.stringify({assetIds:selectedAssets})}); setShowBulkDelete(false); setSelectedAssets([]); loadAllData(); } catch(e){ alert(e.message); } };

  const handleAddLocation = async () => { if(!newLocation.name) return; try { await api('/locations',{method:'POST',body:JSON.stringify(newLocation)}); setShowAddLocation(false); setNewLocation({name:'',address:''}); loadAllData(); } catch(e){ alert(e.message); } };
  const handleUpdateLocation = async () => { try { await api('/locations/'+editingLocation.id,{method:'PUT',body:JSON.stringify(editingLocation)}); setEditingLocation(null); loadAllData(); } catch(e){ alert(e.message); } };
  const handleDeleteLocation = async (id) => { try { await api('/locations/'+id,{method:'DELETE'}); loadAllData(); } catch(e){ alert(e.message); } };

  const handleAddCategory = async () => { if(!newCategory.trim()||categories.includes(newCategory.trim())) return; try { await api('/categories',{method:'POST',body:JSON.stringify({name:newCategory.trim()})}); setNewCategory(''); loadAllData(); } catch(e){ alert(e.message); } };
  const handleRenameCategory = async () => { if(!editingCategoryName.trim()||editingCategoryName===editingCategory){setEditingCategory(null);return;} try { await api('/categories/rename',{method:'POST',body:JSON.stringify({oldName:editingCategory,newName:editingCategoryName.trim()})}); setEditingCategory(null); setEditingCategoryName(''); loadAllData(); } catch(e){ alert(e.message); } };
  const handleDeleteCategory = async (n) => { const c=await api('/categories'); const f=c.find(x=>x.name===n); if(f){ try { await api('/categories/'+f.id,{method:'DELETE'}); loadAllData(); } catch(e){ alert(e.message); } } };

  const handleSaveSettings = async () => { try { await api('/settings',{method:'PUT',body:JSON.stringify({companyName, brandColor, bgColor1, bgColor2})}); setShowSettings(false); } catch(e){ alert(e.message); } };
  const handleChangePw = async () => { if(!pwData.current||!pwData.new||!pwData.confirm) return alert('Fill all fields'); if(pwData.new!==pwData.confirm) return alert('Mismatch'); try { await api('/auth/change-password',{method:'POST',body:JSON.stringify({currentPassword:pwData.current,newPassword:pwData.new})}); alert('Changed!'); setShowChangePw(false); setPwData({current:'',new:'',confirm:''}); } catch(e){ alert(e.message); } };

  // ===== EXPORT FUNCTIONS =====
  const downloadFile = (content, filename, type) => {
    const blob = new Blob([content], { type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  };

  const handleExportJSON = (compressed = false) => {
    if (compressed) {
      handleExportCompressed();
      return;
    }
    const exportData = {
      exportDate: new Date().toISOString(),
      company: companyName || 'Kassets',
      assets: assets.map(a => ({
        name: a.name, category: a.category, serialNumber: a.serialNumber, partNumber: a.partNumber,
        description: a.description, purchaseDate: a.purchaseDate, purchaseCost: a.purchaseCost,
        currentValue: a.currentValue, quantity: a.quantity, depreciationRate: a.depreciationRate,
        location: getLocationName(a.locationId),
        notes: (a.notes||[]).map(n => ({ text: n.text, createdBy: n.created_by, date: n.created_at })),
        photos: (a.photos||[]).map(p => ({ name: p.name, url: p.url }))
      })),
      locations: locations.map(l => ({ name: l.name, address: l.address })),
      categories: categories,
      settings: { companyName, brandColor, bgColor1, bgColor2 }
    };
    const slug = (companyName || 'kassets').toLowerCase().replace(/[^a-z0-9]+/g, '-');
    downloadFile(JSON.stringify(exportData, null, 2), `${slug}-export-${new Date().toISOString().slice(0,10)}.json`, 'application/json');
  };

  const compressImage = (base64url, maxWidth=800, quality=0.6) => {
    return new Promise((resolve) => {
      if (!base64url || !base64url.startsWith('data:image')) { resolve(base64url); return; }
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        let w = img.width, h = img.height;
        if (w > maxWidth) { h = Math.round(h * (maxWidth / w)); w = maxWidth; }
        canvas.width = w; canvas.height = h;
        ctx.drawImage(img, 0, 0, w, h);
        resolve(canvas.toDataURL('image/jpeg', quality));
      };
      img.onerror = () => resolve(base64url);
      img.src = base64url;
    });
  };

  const handleExportCompressed = async () => {
    const totalPhotos = assets.reduce((s, a) => s + (a.photos||[]).filter(p => p.url && p.url.startsWith('data:image')).length, 0);
    setExportProgress({ current: 0, total: totalPhotos, status: 'Compressing photos...' });

    const compressedAssets = [];
    let photosDone = 0;

    for (const a of assets) {
      const compPhotos = [];
      for (const p of (a.photos||[])) {
        if (p.url && p.url.startsWith('data:image')) {
          const compressed = await compressImage(p.url, 800, 0.6);
          compPhotos.push({ name: p.name, url: compressed });
          photosDone++;
          setExportProgress({ current: photosDone, total: totalPhotos, status: `Compressing photo ${photosDone}/${totalPhotos}...` });
        } else {
          compPhotos.push({ name: p.name, url: p.url });
        }
      }
      compressedAssets.push({
        name: a.name, category: a.category, serialNumber: a.serialNumber, partNumber: a.partNumber,
        description: a.description, purchaseDate: a.purchaseDate, purchaseCost: a.purchaseCost,
        currentValue: a.currentValue, quantity: a.quantity, depreciationRate: a.depreciationRate,
        location: getLocationName(a.locationId),
        notes: (a.notes||[]).map(n => ({ text: n.text, createdBy: n.created_by, date: n.created_at })),
        photos: compPhotos
      });
    }

    const exportData = {
      exportDate: new Date().toISOString(),
      company: companyName || 'Kassets',
      compressed: true,
      assets: compressedAssets,
      locations: locations.map(l => ({ name: l.name, address: l.address })),
      categories: categories,
      settings: { companyName, brandColor, bgColor1, bgColor2 }
    };

    const slug = (companyName || 'kassets').toLowerCase().replace(/[^a-z0-9]+/g, '-');
    const jsonStr = JSON.stringify(exportData, null, 2);
    setExportProgress({ current: totalPhotos, total: totalPhotos, status: `Done! File size: ${(new Blob([jsonStr]).size / (1024*1024)).toFixed(1)} MB` });
    downloadFile(jsonStr, `${slug}-compressed-${new Date().toISOString().slice(0,10)}.json`, 'application/json');
    setTimeout(() => setExportProgress(null), 5000);
  };

  const handleExportExcel = () => {
    // Build CSV content (universal Excel compatible)
    const escape = (v) => { const s = String(v||'').replace(/"/g, '""'); return s.includes(',') || s.includes('"') || s.includes('\n') ? `"${s}"` : s; };
    
    // Assets sheet
    const headers = ['Name','Category','Location','Serial Number','Part Number','Description','Purchase Date','Purchase Cost','Current Value','Quantity','Total Value','Depreciation Rate %'];
    const rows = assets.map(a => [
      a.name, a.category, getLocationName(a.locationId), a.serialNumber, a.partNumber, a.description,
      a.purchaseDate, a.purchaseCost, a.currentValue, a.quantity, (a.currentValue*a.quantity).toFixed(2), a.depreciationRate
    ]);
    
    // Summary section
    const totalCost = assets.reduce((s,a) => s + a.purchaseCost * a.quantity, 0);
    const totalValue = assets.reduce((s,a) => s + a.currentValue * a.quantity, 0);
    const totalQty = assets.reduce((s,a) => s + a.quantity, 0);
    
    let csv = `${companyName || 'Kassets'} - Asset Export\n`;
    csv += `Generated: ${new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'})}\n\n`;
    csv += `Summary\n`;
    csv += `Total Assets,${totalQty}\n`;
    csv += `Total Purchase Cost,"${formatCurrency(totalCost)}"\n`;
    csv += `Total Current Value,"${formatCurrency(totalValue)}"\n`;
    csv += `Total Depreciation,"${formatCurrency(totalCost - totalValue)}"\n\n`;
    csv += `Assets by Category\n`;
    csv += `Category,Count,Purchase Cost,Current Value\n`;
    categories.forEach(cat => {
      const ca = assets.filter(a => a.category === cat);
      if (!ca.length) return;
      const cnt = ca.reduce((s,a) => s + a.quantity, 0);
      const cost = ca.reduce((s,a) => s + a.purchaseCost * a.quantity, 0);
      const val = ca.reduce((s,a) => s + a.currentValue * a.quantity, 0);
      csv += `${escape(cat)},${cnt},"${formatCurrency(cost)}","${formatCurrency(val)}"\n`;
    });
    csv += `\nAssets by Location\n`;
    csv += `Location,Count,Purchase Cost,Current Value\n`;
    locations.forEach(loc => {
      const la = assets.filter(a => a.locationId === loc.id);
      const cnt = la.reduce((s,a) => s + a.quantity, 0);
      const cost = la.reduce((s,a) => s + a.purchaseCost * a.quantity, 0);
      const val = la.reduce((s,a) => s + a.currentValue * a.quantity, 0);
      csv += `${escape(loc.name)},${cnt},"${formatCurrency(cost)}","${formatCurrency(val)}"\n`;
    });
    csv += `\nDetailed Asset List\n`;
    csv += headers.map(escape).join(',') + '\n';
    rows.forEach(r => { csv += r.map(escape).join(',') + '\n'; });
    
    // Notes section
    const assetsWithNotes = assets.filter(a => a.notes?.length > 0);
    if (assetsWithNotes.length > 0) {
      csv += `\nAsset Notes\n`;
      csv += `Asset,Note,Author,Date\n`;
      assetsWithNotes.forEach(a => {
        (a.notes||[]).forEach(n => {
          csv += `${escape(a.name)},${escape(n.text)},${escape(n.created_by)},${escape(n.created_at)}\n`;
        });
      });
    }

    const slug = (companyName || 'kassets').toLowerCase().replace(/[^a-z0-9]+/g, '-');
    downloadFile('\uFEFF' + csv, `${slug}-export-${new Date().toISOString().slice(0,10)}.csv`, 'text/csv;charset=utf-8');
  };

  const handleAddNote = async () => { if(!newNote.trim()||!showNotesModal) return; try { await api('/assets/'+showNotesModal.id+'/notes',{method:'POST',body:JSON.stringify({text:newNote})}); setNewNote(''); loadAllData(); const u=(await api('/assets')).find(a=>a.id===showNotesModal.id); if(u)setShowNotesModal({...showNotesModal,notes:u.notes||[]}); } catch(e){ alert(e.message); } };
  const handleDeleteNote = async (nid) => { try { await api('/assets/'+showNotesModal.id+'/notes/'+nid,{method:'DELETE'}); loadAllData(); const u=(await api('/assets')).find(a=>a.id===showNotesModal.id); if(u)setShowNotesModal({...showNotesModal,notes:u.notes||[]}); } catch(e){ alert(e.message); } };

  const handlePhotoUpload = async (e, aid) => {
    const files = Array.from(e.target.files); if(!files.length) return;
    const cur = editingAsset?.photos?.length || 0;
    const max = 5 - cur;
    const toUp = files.slice(0, max);
    if(files.length > max) alert(`Only uploading ${max} photo(s). Max 5.`);
    for (const f of toUp) {
      await new Promise(res => { const r = new FileReader(); r.onload = async () => { try { await api('/assets/'+aid+'/photos',{method:'POST',body:JSON.stringify({url:r.result,name:f.name})}); } catch(err){} res(); }; r.readAsDataURL(f); });
    }
    loadAllData();
    if(editingAsset){const u=(await api('/assets')).find(a=>a.id===aid);if(u)setEditingAsset({...editingAsset,photos:u.photos||[]});}
    e.target.value='';
  };

  const toggleSelect = (id) => setSelectedAssets(p => p.includes(id)?p.filter(x=>x!==id):[...p,id]);
  const selectAll = () => setSelectedAssets(selectedAssets.length===filteredAssets.length?[]:filteredAssets.map(a=>a.id));

  const totals = calculateTotals();
  const { theme, toggleTheme } = useTheme ? useTheme() : { theme: 'dark', toggleTheme: () => {} };

  // ==================== RENDER ====================
  const dynamicBg = `linear-gradient(135deg, ${bgColor1} 0%, ${bgColor2} 50%, ${bgColor1} 100%)`;
  
  return (
    <div style={{ minHeight:'100vh', background: dynamicBg }}>
      {/* Header */}
      <header style={{ padding:'16px 24px', borderBottom:'1px solid var(--border-color)', display:'flex', justifyContent:'space-between', alignItems:'center', flexWrap:'wrap', gap:12 }}>
        <div style={{ display:'flex', alignItems:'center', gap:12 }}>
          <CoinLogo size={48} />
          <div>
            <h1 style={{ fontSize:20, fontWeight:700, margin:0, color: brandColor }}>{companyName || 'KASSETS'}</h1>
            <p style={{ margin:0, fontSize:11, color:'var(--text-muted)' }}>Asset Management</p>
          </div>
        </div>
        <div style={{ display:'flex', gap:8, alignItems:'center', flexWrap:'wrap' }}>
          <span style={{ color:'var(--text-muted)', fontSize:13 }} className="hide-mobile">üë§ {user.displayName || user.username}</span>
          <span className={`category-badge ${roleColors[user.role]}`}>{roleLabels[user.role]}</span>
          <button className="theme-toggle" onClick={toggleTheme} title={theme==='dark'?'Light mode':'Dark mode'}>{theme==='dark'?'‚òÄÔ∏è':'üåô'}</button>
          {user.companyName && <span className="location-badge">{user.companyName}</span>}
          {isAdminRole && <button className="btn-secondary" style={{ padding:'8px 12px', fontSize:12 }} onClick={() => setShowUserMgmt(true)}>Users</button>}
          <button className="btn-secondary" style={{ padding:'8px 12px', fontSize:12 }} onClick={() => setShowSettings(true)}>‚öôÔ∏è</button>
          {canEditData && <button className="btn-primary" style={{ padding:'8px 16px', fontSize:12 }} onClick={() => setShowAddAsset(true)}>+ Asset</button>}
          <button className="btn-danger" style={{ padding:'8px 12px', fontSize:12 }} onClick={onLogout}>Logout</button>
        </div>
      </header>

      {/* Tabs */}
      <nav style={{ padding:'0 24px', borderBottom:'1px solid rgba(148,163,184,0.1)', display:'flex', gap:4, overflowX:'auto' }}>
        {(isAdminRole ? ['dashboard','assets','locations','balance-sheet'] : ['dashboard','assets','locations']).map(t => (
          <button key={t} className={`tab-btn ${activeTab===t?'active':''}`} onClick={() => setActiveTab(t)}>
            {t.charAt(0).toUpperCase()+t.slice(1).replace('-',' ')}
          </button>
        ))}
      </nav>

      <main style={{ padding:24 }}>
        {/* Dashboard */}
        {activeTab === 'dashboard' && (
          <div>
            <div style={{ display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(220px, 1fr))', gap:16, marginBottom:32 }} className="stat-grid">
              <div className="stat-card"><p style={{ color:'var(--text-secondary)', fontSize:13, marginBottom:8 }}>Total Assets</p><p style={{ fontSize:28, fontWeight:700, fontFamily:"'JetBrains Mono', monospace" }}>{totals.totalAssets}</p><p style={{ color:'var(--text-muted)', fontSize:12, marginTop:8 }}>{locations.length} locations ‚Ä¢ {categories.filter(c=>assets.some(a=>a.category===c)).length} categories</p></div>
              {isAdminRole && <>
                <div className="stat-card" style={{ borderLeft:'4px solid var(--accent-green)' }}><p style={{ color:'var(--text-secondary)', fontSize:13, marginBottom:8 }}>Current Value</p><p style={{ fontSize:24, fontWeight:700, fontFamily:"'JetBrains Mono', monospace", color:'var(--accent-green)' }}>{formatCurrency(totals.totalCurrentValue)}</p></div>
                <div className="stat-card"><p style={{ color:'var(--text-secondary)', fontSize:13, marginBottom:8 }}>Purchase Cost</p><p style={{ fontSize:24, fontWeight:700, fontFamily:"'JetBrains Mono', monospace" }}>{formatCurrency(totals.totalPurchaseCost)}</p></div>
                <div className="stat-card" style={{ borderLeft:`4px solid ${totals.totalPurchaseCost-totals.totalCurrentValue>0?'var(--accent-red)':'var(--accent-green)'}` }}><p style={{ color:'var(--text-secondary)', fontSize:13, marginBottom:8 }}>Depreciation</p><p style={{ fontSize:24, fontWeight:700, fontFamily:"'JetBrains Mono', monospace", color:totals.totalPurchaseCost-totals.totalCurrentValue>0?'var(--accent-red)':'var(--accent-green)' }}>{totals.totalPurchaseCost-totals.totalCurrentValue>0?'-':'+'}{formatCurrency(Math.abs(totals.totalPurchaseCost-totals.totalCurrentValue))}</p></div>
              </>}
            </div>

            {/* Bar Charts */}
            <div style={{ display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(320px, 1fr))', gap:20, marginBottom:32 }}>
              <BarChart title="Assets by Category" colorScheme="mixed"
                data={categories.map(cat => { const count=assets.filter(a=>a.category===cat).reduce((s,a)=>s+a.quantity,0); return {label:cat,value:count,displayValue:count}; }).filter(d=>d.value>0).sort((a,b)=>b.value-a.value)} />
              <BarChart title="Assets by Location" colorScheme="green"
                data={locations.map(loc => { const count=assets.filter(a=>a.locationId===loc.id).reduce((s,a)=>s+a.quantity,0); return {label:loc.name,value:count,displayValue:count}; }).sort((a,b)=>b.value-a.value)} />
            </div>

            {/* Donut Charts (admin only) */}
            {isAdminRole && (
              <div style={{ display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(280px, 1fr))', gap:20, marginBottom:32 }}>
                <DonutChart title="Value Distribution by Category"
                  data={categories.map(cat => { const v=assets.filter(a=>a.category===cat).reduce((s,a)=>s+(a.currentValue||0)*(a.quantity||1),0); return {label:cat,value:v,displayValue:formatCurrency(v)}; }).filter(d=>d.value>0).sort((a,b)=>b.value-a.value).slice(0,6)} />
                <DonutChart title="Value Distribution by Location"
                  data={locations.map(loc => { const v=assets.filter(a=>a.locationId===loc.id).reduce((s,a)=>s+(a.currentValue||0)*(a.quantity||1),0); return {label:loc.name,value:v,displayValue:formatCurrency(v)}; }).filter(d=>d.value>0).sort((a,b)=>b.value-a.value)} />
              </div>
            )}

            {/* Summary Lists */}
            <div style={{ display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(300px, 1fr))', gap:20 }}>
              <div className="glass-card" style={{ padding:24 }}>
                <h3 style={{ marginBottom:16, color:'var(--text-primary)' }}>Category Summary</h3>
                {categories.map(cat => { const ca=assets.filter(a=>a.category===cat); const cv=ca.reduce((s,a)=>s+(a.currentValue||0)*(a.quantity||1),0); const cc=ca.reduce((s,a)=>s+(a.quantity||1),0); if(!ca.length) return null; return (<div key={cat} style={{ display:'flex', justifyContent:'space-between', alignItems:'center', padding:'10px 0', borderBottom:'1px solid var(--border-color)' }}><div><span style={{ color:'var(--text-primary)' }}>{cat}</span><span style={{ color:'var(--text-muted)', fontSize:12, marginLeft:8 }}>{cc} items</span></div>{isAdminRole && <span style={{ fontFamily:"'JetBrains Mono', monospace", color:'var(--accent-green)', fontSize:14 }}>{formatCurrency(cv)}</span>}</div>); })}
              </div>
              <div className="glass-card" style={{ padding:24 }}>
                <h3 style={{ marginBottom:16, color:'var(--text-primary)' }}>Location Summary</h3>
                {locations.map(loc => { const la=assets.filter(a=>a.locationId===loc.id); const lv=la.reduce((s,a)=>s+(a.currentValue||0)*(a.quantity||1),0); const lc=la.reduce((s,a)=>s+(a.quantity||1),0); return (<div key={loc.id} style={{ display:'flex', justifyContent:'space-between', alignItems:'center', padding:'10px 0', borderBottom:'1px solid var(--border-color)' }}><div><span style={{ color:'var(--text-primary)' }}>{loc.name}</span><span style={{ color:'var(--text-muted)', fontSize:12, marginLeft:8 }}>{lc} items</span></div>{isAdminRole && <span style={{ fontFamily:"'JetBrains Mono', monospace", color:'var(--accent-green)', fontSize:14 }}>{formatCurrency(lv)}</span>}</div>); })}
              </div>
            </div>
          </div>
        )}

        {/* Assets */}
        {activeTab === 'assets' && (
          <div>
            <div style={{ display:'flex', gap:12, marginBottom:16, flexWrap:'wrap', alignItems:'center' }}>
              <input type="text" className="input-field" placeholder="Search assets..." style={{ maxWidth:250 }} value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
              <select className="input-field" style={{ maxWidth:180 }} value={filterLocation} onChange={e => { setFilterLocation(e.target.value); setSelectedAssets([]); }}><option value="all">All Locations</option>{locations.map(l => <option key={l.id} value={l.id}>{l.name}</option>)}</select>
              <select className="input-field" style={{ maxWidth:180 }} value={filterCategory} onChange={e => { setFilterCategory(e.target.value); setSelectedAssets([]); }}><option value="all">All Categories</option>{categories.map(c => <option key={c} value={c}>{c}</option>)}</select>
              {canEditData && filteredAssets.length>0 && <button className="btn-secondary" style={{ padding:'10px 16px' }} onClick={selectAll}>{selectedAssets.length===filteredAssets.length?'‚òë Deselect All':'‚òê Select All'}</button>}
            </div>
            
            {canEditData && selectedAssets.length>0 && (
              <div style={{ display:'flex', gap:12, padding:16, marginBottom:16, background:'linear-gradient(135deg, rgba(59,130,246,0.2), rgba(30,41,59,0.9))', borderRadius:12, alignItems:'center', flexWrap:'wrap' }}>
                <span style={{ fontWeight:600 }}>{selectedAssets.length} selected</span>
                <button className="btn-primary" style={{ padding:'8px 16px' }} onClick={() => setShowBulkTransfer(true)}>üìç Move</button>
                <button className="btn-purple" style={{ padding:'8px 16px' }} onClick={() => setShowBulkCategory(true)}>üè∑Ô∏è Category</button>
                <button className="btn-danger" style={{ padding:'8px 16px' }} onClick={() => setShowBulkDelete(true)}>üóëÔ∏è Delete</button>
                <button className="btn-secondary" style={{ padding:'8px 16px' }} onClick={() => setSelectedAssets([])}>Clear</button>
              </div>
            )}
            
            <div style={{ maxHeight:'calc(100vh - 320px)', overflowY:'auto' }}>
              {filteredAssets.length===0 ? <div className="glass-card" style={{ padding:40, textAlign:'center' }}><p style={{ color:'#64748b' }}>No assets found</p></div> : filteredAssets.map(asset => (
                <div key={asset.id} className={`asset-row ${selectedAssets.includes(asset.id)?'selected':''}`}>
                  <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center', flexWrap:'wrap', gap:12 }}>
                    <div style={{ display:'flex', alignItems:'center', gap:12, flex:1, minWidth:200 }}>
                      {canEditData && <div onClick={() => toggleSelect(asset.id)} style={{ width:22, height:22, borderRadius:6, border:selectedAssets.includes(asset.id)?'2px solid #3b82f6':'2px solid #475569', background:selectedAssets.includes(asset.id)?'#3b82f6':'transparent', cursor:'pointer', display:'flex', alignItems:'center', justifyContent:'center', flexShrink:0 }}>{selectedAssets.includes(asset.id) && <span style={{ color:'white', fontSize:12 }}>‚úì</span>}</div>}
                      {asset.photos?.length>0 ? <img src={asset.photos[0].url} onClick={() => setShowPhotoViewer(asset)} style={{ width:50, height:50, objectFit:'cover', borderRadius:8, cursor:'pointer', flexShrink:0, border:'2px solid rgba(148,163,184,0.2)' }} /> : <div style={{ width:50, height:50, borderRadius:8, background:'rgba(148,163,184,0.1)', display:'flex', alignItems:'center', justifyContent:'center', flexShrink:0 }}><span style={{ fontSize:20, opacity:0.3 }}>üì∑</span></div>}
                      <div>
                        <h4 style={{ margin:0, fontSize:15 }}>{asset.name}</h4>
                        <p style={{ margin:'4px 0 0', fontSize:12, color:'#64748b' }}>{asset.partNumber&&`P/N: ${asset.partNumber} ‚Ä¢ `}{asset.serialNumber&&`SN: ${asset.serialNumber} ‚Ä¢ `}Qty: {asset.quantity}{asset.description&&` ‚Ä¢ ${asset.description}`}</p>
                      </div>
                    </div>
                    <div style={{ display:'flex', gap:6, alignItems:'center', flexWrap:'wrap' }}>
                      <span className="category-badge">{asset.category}</span>
                      <span className="location-badge">{getLocationName(asset.locationId)}</span>
                      {isAdminRole && <span style={{ fontFamily:"'JetBrains Mono', monospace", color:'#34d399', minWidth:80, textAlign:'right', fontSize:13 }}>{formatCurrency(asset.currentValue*asset.quantity)}</span>}
                      {asset.photos?.length>1 && <button className="btn-secondary" style={{ padding:'5px 10px', fontSize:11 }} onClick={() => setShowPhotoViewer(asset)}>+{asset.photos.length-1} more</button>}
                      <button className="btn-secondary" style={{ padding:'5px 10px', fontSize:11, background:asset.notes?.length?'rgba(251,191,36,0.2)':undefined }} onClick={() => setShowNotesModal(asset)}>üìù {asset.notes?.length||''}</button>
                      {canEditData && <button className="btn-secondary" style={{ padding:'5px 10px', fontSize:11 }} onClick={() => handleDuplicate(asset)}>üìã</button>}
                      {canEditData && <button className="btn-secondary" style={{ padding:'5px 10px', fontSize:11 }} onClick={() => setEditingAsset({...asset})}>Edit</button>}
                      {canEditData && <button className="btn-danger" style={{ padding:'5px 10px', fontSize:11 }} onClick={() => handleDeleteAsset(asset.id)}>Delete</button>}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Locations */}
        {activeTab === 'locations' && (
          <div style={{ display:'grid', gridTemplateColumns:'repeat(auto-fill, minmax(300px, 1fr))', gap:20 }}>
            {locations.map(loc => { const la=assets.filter(a=>a.locationId===loc.id); const lv=la.reduce((s,a)=>s+(a.currentValue||0)*(a.quantity||1),0); return (
              <div key={loc.id} className="glass-card" style={{ padding:24 }}>
                <h3 style={{ margin:'0 0 8px' }}>{loc.name}</h3>
                <p style={{ color:'#64748b', fontSize:13, margin:'0 0 16px' }}>{loc.address||'No address'}</p>
                <div style={{ display:'grid', gridTemplateColumns:isAdminRole?'1fr 1fr':'1fr', gap:12, marginBottom:16 }}>
                  <div style={{ background:'rgba(15,23,42,0.5)', borderRadius:10, padding:12 }}><p style={{ color:'#64748b', fontSize:11, margin:0 }}>Assets</p><p style={{ fontSize:22, fontWeight:700, margin:'4px 0 0' }}>{la.length}</p></div>
                  {isAdminRole && <div style={{ background:'rgba(15,23,42,0.5)', borderRadius:10, padding:12 }}><p style={{ color:'#64748b', fontSize:11, margin:0 }}>Value</p><p style={{ fontSize:16, fontWeight:700, margin:'4px 0 0', color:'#34d399', fontFamily:"'JetBrains Mono', monospace" }}>{formatCurrency(lv)}</p></div>}
                </div>
                {canEditData && <div style={{ display:'flex', gap:8 }}><button className="btn-secondary" style={{ flex:1, padding:'10px 16px' }} onClick={() => setEditingLocation({...loc})}>Edit</button><button className="btn-danger" style={{ flex:1, padding:'10px 16px' }} onClick={() => handleDeleteLocation(loc.id)}>Delete</button></div>}
              </div>
            ); })}
          </div>
        )}

        {/* Balance Sheet */}
        {activeTab === 'balance-sheet' && isAdminRole && (
          <div className="glass-card" style={{ padding:32 }}>
            <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:24, flexWrap:'wrap', gap:12 }}>
              <div><h2 style={{ margin:0 }}>{companyName||'Kassets'} - Balance Sheet</h2><p style={{ color:'var(--text-muted)', marginTop:4 }}>{new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'})}</p></div>
              <button className="btn-gold" style={{ background:`linear-gradient(135deg, ${brandColor}, ${brandColor}cc)` }} onClick={() => {
                const catStats=categories.map(cat=>{const ca=assets.filter(a=>a.category===cat);if(!ca.length)return null;const cnt=ca.reduce((s,a)=>s+a.quantity,0),cost=ca.reduce((s,a)=>s+a.purchaseCost*a.quantity,0),val=ca.reduce((s,a)=>s+a.currentValue*a.quantity,0);return{name:cat,count:cnt,cost,value:val,dep:cost-val};}).filter(Boolean);
                const locStats=locations.map(loc=>{const la=assets.filter(a=>a.locationId===loc.id);const cnt=la.reduce((s,a)=>s+a.quantity,0),cost=la.reduce((s,a)=>s+a.purchaseCost*a.quantity,0),val=la.reduce((s,a)=>s+a.currentValue*a.quantity,0),pct=totals.totalCurrentValue>0?((val/totals.totalCurrentValue)*100).toFixed(1):'0.0';return{name:loc.name,count:cnt,cost,value:val,pct};}).sort((a,b)=>a.name.localeCompare(b.name));
                const sorted=[...assets].sort((a,b)=>a.name.localeCompare(b.name));
                const bc=brandColor;
                const html=`<!DOCTYPE html><html><head><title>Balance Sheet</title><style>*{box-sizing:border-box;margin:0;padding:0}body{font-family:-apple-system,sans-serif;padding:40px;color:#1a1a2e;background:white}.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;padding-bottom:20px;border-bottom:3px solid ${bc}}h1{font-size:24px;margin-bottom:5px}h2{font-size:18px;margin:25px 0 15px;color:#1a1a2e;border-bottom:2px solid ${bc};padding-bottom:8px}.sg{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:30px}.sb{background:#f8f9fa;padding:20px;border-radius:8px;border-left:4px solid ${bc}}.sl{font-size:12px;color:#666;text-transform:uppercase}.sv{font-size:24px;font-weight:700;margin-top:5px}.green{color:#22c55e}.red{color:#ef4444}table{width:100%;border-collapse:collapse;margin-bottom:30px}th{background:#1a1a2e;color:white;padding:12px;text-align:left;font-size:12px;text-transform:uppercase}td{padding:12px;border-bottom:1px solid #eee;font-size:14px}.tr{text-align:right}.fm{font-family:Monaco,Consolas,monospace}.total-row{font-weight:700;background:#f0f0f0}.footer{margin-top:40px;padding-top:20px;border-top:1px solid #eee;font-size:12px;color:#666;text-align:center}</style></head><body>
                <div class="header"><div><div style="font-size:28px;font-weight:800;color:${bc}">${companyName||'KASSETS'}</div><p style="color:#666;font-size:12px">Asset Management by Kassets</p></div><div style="color:#666;font-size:14px">Generated: ${new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'})}</div></div>
                <h1>${companyName||'Kassets'} - Asset Balance Sheet</h1>
                <div class="sg"><div class="sb"><div class="sl">Total Assets (at cost)</div><div class="sv">${formatCurrency(totals.totalPurchaseCost)}</div></div><div class="sb"><div class="sl">Accumulated Depreciation</div><div class="sv red">(${formatCurrency(totals.totalPurchaseCost-totals.totalCurrentValue)})</div></div><div class="sb"><div class="sl">Net Book Value</div><div class="sv green">${formatCurrency(totals.totalCurrentValue)}</div></div></div>
                <h2>Assets by Category</h2><table><thead><tr><th>Category</th><th class="tr">Count</th><th class="tr">Purchase Cost</th><th class="tr">Current Value</th><th class="tr">Depreciation</th></tr></thead><tbody>${catStats.map(c=>`<tr><td>${c.name}</td><td class="tr fm">${c.count}</td><td class="tr fm">${formatCurrency(c.cost)}</td><td class="tr fm green">${formatCurrency(c.value)}</td><td class="tr fm red">(${formatCurrency(c.dep)})</td></tr>`).join('')}<tr class="total-row"><td>TOTAL</td><td class="tr fm">${totals.totalAssets}</td><td class="tr fm">${formatCurrency(totals.totalPurchaseCost)}</td><td class="tr fm green">${formatCurrency(totals.totalCurrentValue)}</td><td class="tr fm red">(${formatCurrency(totals.totalPurchaseCost-totals.totalCurrentValue)})</td></tr></tbody></table>
                <h2>Assets by Location</h2><table><thead><tr><th>Location</th><th class="tr">Count</th><th class="tr">Purchase Cost</th><th class="tr">Current Value</th><th class="tr">% of Total</th></tr></thead><tbody>${locStats.map(l=>`<tr><td>${l.name}</td><td class="tr fm">${l.count}</td><td class="tr fm">${formatCurrency(l.cost)}</td><td class="tr fm green">${formatCurrency(l.value)}</td><td class="tr fm">${l.pct}%</td></tr>`).join('')}</tbody></table>
                <h2>Detailed Asset Schedule</h2><table><thead><tr><th>Asset</th><th>Serial #</th><th>Location</th><th class="tr">Qty</th><th>Purchase Date</th><th class="tr">Unit Cost</th><th class="tr">Total Value</th></tr></thead><tbody>${sorted.map(a=>`<tr><td>${a.name}</td><td class="fm" style="color:#666;font-size:12px">${a.serialNumber||'-'}</td><td>${getLocationName(a.locationId)}</td><td class="tr">${a.quantity}</td><td>${a.purchaseDate?new Date(a.purchaseDate).toLocaleDateString('en-US',{year:'numeric',month:'short',day:'numeric'}):'-'}</td><td class="tr fm">${formatCurrency(a.purchaseCost)}</td><td class="tr fm green">${formatCurrency(a.currentValue*a.quantity)}</td></tr>`).join('')}</tbody></table>
                <div class="footer">Generated by Kassets Asset Management System</div></body></html>`;
                const w=window.open('','_blank');w.document.write(html);w.document.close();w.print();
              }}>üìÑ Generate PDF Report</button>
            </div>
            
            {/* Summary Cards */}
            <div style={{ display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(180px, 1fr))', gap:16, marginBottom:32 }}>
              <div style={{ background:'rgba(15,23,42,0.5)', padding:16, borderRadius:12, borderLeft:`4px solid ${brandColor}` }}><p style={{ color:'var(--text-muted)', fontSize:11, margin:0, textTransform:'uppercase' }}>Total Assets (at cost)</p><p style={{ fontSize:20, fontWeight:700, margin:'8px 0 0', fontFamily:"'JetBrains Mono', monospace" }}>{formatCurrency(totals.totalPurchaseCost)}</p></div>
              <div style={{ background:'rgba(15,23,42,0.5)', padding:16, borderRadius:12, borderLeft:'4px solid #ef4444' }}><p style={{ color:'var(--text-muted)', fontSize:11, margin:0, textTransform:'uppercase' }}>Accumulated Depreciation</p><p style={{ fontSize:20, fontWeight:700, margin:'8px 0 0', fontFamily:"'JetBrains Mono', monospace", color:'var(--accent-red)' }}>({formatCurrency(totals.totalPurchaseCost-totals.totalCurrentValue)})</p></div>
              <div style={{ background:'rgba(15,23,42,0.5)', padding:16, borderRadius:12, borderLeft:'4px solid #22c55e' }}><p style={{ color:'var(--text-muted)', fontSize:11, margin:0, textTransform:'uppercase' }}>Net Book Value</p><p style={{ fontSize:20, fontWeight:700, margin:'8px 0 0', fontFamily:"'JetBrains Mono', monospace", color:'var(--accent-green)' }}>{formatCurrency(totals.totalCurrentValue)}</p></div>
            </div>

            {/* By Category Table */}
            <h3 style={{ marginBottom:16, borderBottom:`2px solid ${brandColor}`, paddingBottom:8 }}>Assets by Category</h3>
            <div style={{ overflowX:'auto', marginBottom:32 }}>
              <table style={{ width:'100%', borderCollapse:'collapse', minWidth:500 }}>
                <thead><tr style={{ background:'rgba(15,23,42,0.8)' }}>
                  <th style={{ textAlign:'left', padding:12, color:'var(--text-secondary)', fontSize:11 }}>CATEGORY</th>
                  <th style={{ textAlign:'right', padding:12, color:'var(--text-secondary)', fontSize:11 }}>COUNT</th>
                  <th style={{ textAlign:'right', padding:12, color:'var(--text-secondary)', fontSize:11 }}>PURCHASE COST</th>
                  <th style={{ textAlign:'right', padding:12, color:'var(--text-secondary)', fontSize:11 }}>CURRENT VALUE</th>
                  <th style={{ textAlign:'right', padding:12, color:'var(--text-secondary)', fontSize:11 }}>DEPRECIATION</th>
                </tr></thead>
                <tbody>{categories.map(cat => { const ca=assets.filter(a=>a.category===cat); if(!ca.length) return null; const cnt=ca.reduce((s,a)=>s+a.quantity,0),cost=ca.reduce((s,a)=>s+a.purchaseCost*a.quantity,0),val=ca.reduce((s,a)=>s+a.currentValue*a.quantity,0); return (
                  <tr key={cat} style={{ borderBottom:'1px solid var(--border-color)' }}>
                    <td style={{ padding:12 }}>{cat}</td>
                    <td style={{ padding:12, textAlign:'right', fontFamily:"'JetBrains Mono', monospace" }}>{cnt}</td>
                    <td style={{ padding:12, textAlign:'right', fontFamily:"'JetBrains Mono', monospace" }}>{formatCurrency(cost)}</td>
                    <td style={{ padding:12, textAlign:'right', fontFamily:"'JetBrains Mono', monospace", color:'var(--accent-green)' }}>{formatCurrency(val)}</td>
                    <td style={{ padding:12, textAlign:'right', fontFamily:"'JetBrains Mono', monospace", color:'var(--accent-red)' }}>({formatCurrency(cost-val)})</td>
                  </tr>); })}</tbody>
              </table>
            </div>

            {/* By Location Table */}
            <h3 style={{ marginBottom:16, borderBottom:`2px solid ${brandColor}`, paddingBottom:8 }}>Assets by Location</h3>
            <div style={{ overflowX:'auto', marginBottom:32 }}>
              <table style={{ width:'100%', borderCollapse:'collapse', minWidth:500 }}>
                <thead><tr style={{ background:'rgba(15,23,42,0.8)' }}>
                  <th style={{ textAlign:'left', padding:12, color:'var(--text-secondary)', fontSize:11 }}>LOCATION</th>
                  <th style={{ textAlign:'right', padding:12, color:'var(--text-secondary)', fontSize:11 }}>COUNT</th>
                  <th style={{ textAlign:'right', padding:12, color:'var(--text-secondary)', fontSize:11 }}>PURCHASE COST</th>
                  <th style={{ textAlign:'right', padding:12, color:'var(--text-secondary)', fontSize:11 }}>CURRENT VALUE</th>
                  <th style={{ textAlign:'right', padding:12, color:'var(--text-secondary)', fontSize:11 }}>% OF TOTAL</th>
                </tr></thead>
                <tbody>{[...locations].sort((a,b)=>a.name.localeCompare(b.name)).map(loc => { const la=assets.filter(a=>a.locationId===loc.id); const cnt=la.reduce((s,a)=>s+a.quantity,0),cost=la.reduce((s,a)=>s+a.purchaseCost*a.quantity,0),val=la.reduce((s,a)=>s+a.currentValue*a.quantity,0),pct=totals.totalCurrentValue>0?((val/totals.totalCurrentValue)*100).toFixed(1):'0.0'; return (
                  <tr key={loc.id} style={{ borderBottom:'1px solid var(--border-color)' }}>
                    <td style={{ padding:12 }}>{loc.name}</td>
                    <td style={{ padding:12, textAlign:'right', fontFamily:"'JetBrains Mono', monospace" }}>{cnt}</td>
                    <td style={{ padding:12, textAlign:'right', fontFamily:"'JetBrains Mono', monospace" }}>{formatCurrency(cost)}</td>
                    <td style={{ padding:12, textAlign:'right', fontFamily:"'JetBrains Mono', monospace", color:'var(--accent-green)' }}>{formatCurrency(val)}</td>
                    <td style={{ padding:12, textAlign:'right', fontFamily:"'JetBrains Mono', monospace" }}>{pct}%</td>
                  </tr>); })}</tbody>
              </table>
            </div>

            {/* Detailed Asset Schedule */}
            <h3 style={{ marginBottom:16, borderBottom:`2px solid ${brandColor}`, paddingBottom:8 }}>Detailed Asset Schedule</h3>
            <div style={{ overflowX:'auto' }}>
              <table style={{ width:'100%', borderCollapse:'collapse', minWidth:700 }}>
                <thead><tr style={{ background:'rgba(15,23,42,0.8)' }}>
                  <th style={{ textAlign:'left', padding:12, color:'var(--text-secondary)', fontSize:11 }}>ASSET NAME</th>
                  <th style={{ textAlign:'left', padding:12, color:'var(--text-secondary)', fontSize:11 }}>SERIAL #</th>
                  <th style={{ textAlign:'left', padding:12, color:'var(--text-secondary)', fontSize:11 }}>LOCATION</th>
                  <th style={{ textAlign:'right', padding:12, color:'var(--text-secondary)', fontSize:11 }}>QTY</th>
                  <th style={{ textAlign:'left', padding:12, color:'var(--text-secondary)', fontSize:11 }}>PURCHASE DATE</th>
                  <th style={{ textAlign:'right', padding:12, color:'var(--text-secondary)', fontSize:11 }}>UNIT COST</th>
                  <th style={{ textAlign:'right', padding:12, color:'var(--text-secondary)', fontSize:11 }}>TOTAL VALUE</th>
                </tr></thead>
                <tbody>{[...assets].sort((a,b)=>a.name.localeCompare(b.name)).map(a => (
                  <tr key={a.id} style={{ borderBottom:'1px solid var(--border-color)' }}>
                    <td style={{ padding:12 }}>{a.name}</td>
                    <td style={{ padding:12, color:'var(--text-muted)', fontSize:12, fontFamily:"'JetBrains Mono', monospace" }}>{a.serialNumber||'-'}</td>
                    <td style={{ padding:12 }}>{getLocationName(a.locationId)}</td>
                    <td style={{ padding:12, textAlign:'right' }}>{a.quantity}</td>
                    <td style={{ padding:12 }}>{a.purchaseDate?new Date(a.purchaseDate).toLocaleDateString('en-US',{year:'numeric',month:'short',day:'numeric'}):'-'}</td>
                    <td style={{ padding:12, textAlign:'right', fontFamily:"'JetBrains Mono', monospace" }}>{formatCurrency(a.purchaseCost)}</td>
                    <td style={{ padding:12, textAlign:'right', fontFamily:"'JetBrains Mono', monospace", color:'var(--accent-green)' }}>{formatCurrency(a.currentValue*a.quantity)}</td>
                  </tr>))}</tbody>
              </table>
            </div>
            <div style={{ marginTop:32, paddingTop:20, borderTop:'1px solid var(--border-color)', textAlign:'center', color:'var(--text-muted)', fontSize:12 }}>Generated by Kassets Asset Management System</div>
          </div>
        )}
      </main>

      {/* ===== MODALS ===== */}
      
      {/* Add Asset */}
      {showAddAsset && (
        <div className="modal-overlay" onClick={() => setShowAddAsset(false)}>
          <div className="modal-content" onClick={e => e.stopPropagation()} style={{ maxWidth:550 }}>
            <h2 style={{ marginBottom:20 }}>‚ûï Add Asset</h2>
            <input className="input-field" placeholder="Asset Name *" value={newAsset.name} onChange={e => setNewAsset({...newAsset, name:e.target.value})} style={{ marginBottom:12 }} />
            <div style={{ display:'grid', gridTemplateColumns:'1fr 1fr', gap:12, marginBottom:12 }}>
              <select className="input-field" value={newAsset.category} onChange={e => setNewAsset({...newAsset, category:e.target.value})}><option value="">Category</option>{categories.map(c => <option key={c} value={c}>{c}</option>)}</select>
              <select className="input-field" value={newAsset.locationId} onChange={e => setNewAsset({...newAsset, locationId:e.target.value})}><option value="">Location</option>{locations.map(l => <option key={l.id} value={l.id}>{l.name}</option>)}</select>
            </div>
            <div style={{ display:'grid', gridTemplateColumns:'1fr 1fr', gap:12, marginBottom:12 }}>
              <input className="input-field" placeholder="Serial Number" value={newAsset.serialNumber} onChange={e => setNewAsset({...newAsset, serialNumber:e.target.value})} />
              <input className="input-field" placeholder="Part Number" value={newAsset.partNumber} onChange={e => setNewAsset({...newAsset, partNumber:e.target.value})} />
            </div>
            <textarea className="input-field" placeholder="Description" value={newAsset.description} onChange={e => setNewAsset({...newAsset, description:e.target.value})} rows={2} style={{ marginBottom:12, resize:'vertical' }} />
            <div style={{ display:'grid', gridTemplateColumns:'1fr 1fr 1fr', gap:12, marginBottom:12 }}>
              <div><label style={{ display:'block', marginBottom:4, fontSize:12, color:'#94a3b8' }}>Purchase Date</label><input className="input-field" type="date" value={newAsset.purchaseDate} onChange={e => setNewAsset({...newAsset, purchaseDate:e.target.value})} /></div>
              <div><label style={{ display:'block', marginBottom:4, fontSize:12, color:'#94a3b8' }}>Purchase Cost</label><input className="input-field" type="number" value={newAsset.purchaseCost} onChange={e => setNewAsset({...newAsset, purchaseCost:e.target.value})} /></div>
              <div><label style={{ display:'block', marginBottom:4, fontSize:12, color:'#94a3b8' }}>Current Value</label><input className="input-field" type="number" value={newAsset.currentValue} onChange={e => setNewAsset({...newAsset, currentValue:e.target.value})} /></div>
            </div>
            <div style={{ display:'grid', gridTemplateColumns:'1fr 1fr', gap:12, marginBottom:20 }}>
              <div><label style={{ display:'block', marginBottom:4, fontSize:12, color:'#94a3b8' }}>Quantity</label><input className="input-field" type="number" min="1" value={newAsset.quantity} onChange={e => setNewAsset({...newAsset, quantity:e.target.value})} /></div>
              <div><label style={{ display:'block', marginBottom:4, fontSize:12, color:'#94a3b8' }}>Depreciation %</label><input className="input-field" type="number" value={newAsset.depreciationRate} onChange={e => setNewAsset({...newAsset, depreciationRate:e.target.value})} /></div>
            </div>
            <div style={{ display:'flex', gap:12, justifyContent:'flex-end' }}>
              <button className="btn-secondary" onClick={() => setShowAddAsset(false)}>Cancel</button>
              <button className="btn-primary" onClick={handleAddAsset}>Add Asset</button>
            </div>
          </div>
        </div>
      )}

      {/* Edit Asset */}
      {editingAsset && (
        <div className="modal-overlay" onClick={() => setEditingAsset(null)}>
          <div className="modal-content" onClick={e => e.stopPropagation()} style={{ maxWidth:550 }}>
            <h2 style={{ marginBottom:20 }}>‚úèÔ∏è Edit Asset</h2>
            <input className="input-field" placeholder="Asset Name *" value={editingAsset.name} onChange={e => setEditingAsset({...editingAsset, name:e.target.value})} style={{ marginBottom:12 }} />
            <div style={{ display:'grid', gridTemplateColumns:'1fr 1fr', gap:12, marginBottom:12 }}>
              <select className="input-field" value={editingAsset.category} onChange={e => setEditingAsset({...editingAsset, category:e.target.value})}><option value="">Category</option>{categories.map(c => <option key={c} value={c}>{c}</option>)}</select>
              <select className="input-field" value={editingAsset.locationId||''} onChange={e => setEditingAsset({...editingAsset, locationId:e.target.value})}><option value="">Location</option>{locations.map(l => <option key={l.id} value={l.id}>{l.name}</option>)}</select>
            </div>
            <div style={{ display:'grid', gridTemplateColumns:'1fr 1fr', gap:12, marginBottom:12 }}>
              <input className="input-field" placeholder="Serial Number" value={editingAsset.serialNumber||''} onChange={e => setEditingAsset({...editingAsset, serialNumber:e.target.value})} />
              <input className="input-field" placeholder="Part Number" value={editingAsset.partNumber||''} onChange={e => setEditingAsset({...editingAsset, partNumber:e.target.value})} />
            </div>
            <textarea className="input-field" placeholder="Description" value={editingAsset.description||''} onChange={e => setEditingAsset({...editingAsset, description:e.target.value})} rows={2} style={{ marginBottom:12, resize:'vertical' }} />
            <div style={{ display:'grid', gridTemplateColumns:'1fr 1fr 1fr', gap:12, marginBottom:12 }}>
              <div><label style={{ display:'block', marginBottom:4, fontSize:12, color:'#94a3b8' }}>Purchase Date</label><input className="input-field" type="date" value={editingAsset.purchaseDate||''} onChange={e => setEditingAsset({...editingAsset, purchaseDate:e.target.value})} /></div>
              <div><label style={{ display:'block', marginBottom:4, fontSize:12, color:'#94a3b8' }}>Purchase Cost</label><input className="input-field" type="number" value={editingAsset.purchaseCost} onChange={e => setEditingAsset({...editingAsset, purchaseCost:e.target.value})} /></div>
              <div><label style={{ display:'block', marginBottom:4, fontSize:12, color:'#94a3b8' }}>Current Value</label><input className="input-field" type="number" value={editingAsset.currentValue} onChange={e => setEditingAsset({...editingAsset, currentValue:e.target.value})} /></div>
            </div>
            <div style={{ display:'grid', gridTemplateColumns:'1fr 1fr', gap:12, marginBottom:12 }}>
              <div><label style={{ display:'block', marginBottom:4, fontSize:12, color:'#94a3b8' }}>Quantity</label><input className="input-field" type="number" min="1" value={editingAsset.quantity} onChange={e => setEditingAsset({...editingAsset, quantity:e.target.value})} /></div>
              <div><label style={{ display:'block', marginBottom:4, fontSize:12, color:'#94a3b8' }}>Depreciation %</label><input className="input-field" type="number" value={editingAsset.depreciationRate} onChange={e => setEditingAsset({...editingAsset, depreciationRate:e.target.value})} /></div>
            </div>
            {/* Photos */}
            <div style={{ marginBottom:16 }}>
              <label style={{ display:'block', marginBottom:8, fontSize:13, color:'#94a3b8' }}>Photos ({editingAsset.photos?.length||0}/5)</label>
              {editingAsset.photos?.length>0 && <div style={{ display:'flex', gap:8, flexWrap:'wrap', marginBottom:8 }}>{editingAsset.photos.map(p => (
                <div key={p.id} style={{ position:'relative' }}>
                  <img src={p.url} style={{ width:60, height:60, objectFit:'cover', borderRadius:8 }} />
                  <button onClick={() => handleDeletePhoto(editingAsset.id, p.id)} style={{ position:'absolute', top:-6, right:-6, background:'#ef4444', border:'none', borderRadius:'50%', width:20, height:20, color:'white', fontSize:10, cursor:'pointer', display:'flex', alignItems:'center', justifyContent:'center' }}>‚úï</button>
                </div>
              ))}</div>}
              {(editingAsset.photos?.length||0)<5 && <input type="file" accept="image/*" multiple onChange={e => handlePhotoUpload(e, editingAsset.id)} style={{ fontSize:12 }} />}
            </div>
            <div style={{ display:'flex', gap:12, justifyContent:'flex-end' }}>
              <button className="btn-secondary" onClick={() => setEditingAsset(null)}>Cancel</button>
              <button className="btn-primary" onClick={handleUpdateAsset}>Save Changes</button>
            </div>
          </div>
        </div>
      )}

      {/* Add Location */}
      {showAddLocation && (
        <div className="modal-overlay" onClick={() => setShowAddLocation(false)}>
          <div className="modal-content" onClick={e => e.stopPropagation()} style={{ maxWidth:400 }}>
            <h2 style={{ marginBottom:20 }}>üìç Add Location</h2>
            <input className="input-field" placeholder="Location Name *" value={newLocation.name} onChange={e => setNewLocation({...newLocation, name:e.target.value})} style={{ marginBottom:12 }} />
            <input className="input-field" placeholder="Address" value={newLocation.address} onChange={e => setNewLocation({...newLocation, address:e.target.value})} style={{ marginBottom:20 }} />
            <div style={{ display:'flex', gap:12, justifyContent:'flex-end' }}><button className="btn-secondary" onClick={() => setShowAddLocation(false)}>Cancel</button><button className="btn-primary" onClick={handleAddLocation}>Add</button></div>
          </div>
        </div>
      )}

      {/* Edit Location */}
      {editingLocation && (
        <div className="modal-overlay" onClick={() => setEditingLocation(null)}>
          <div className="modal-content" onClick={e => e.stopPropagation()} style={{ maxWidth:400 }}>
            <h2 style={{ marginBottom:20 }}>‚úèÔ∏è Edit Location</h2>
            <input className="input-field" placeholder="Name" value={editingLocation.name} onChange={e => setEditingLocation({...editingLocation, name:e.target.value})} style={{ marginBottom:12 }} />
            <input className="input-field" placeholder="Address" value={editingLocation.address||''} onChange={e => setEditingLocation({...editingLocation, address:e.target.value})} style={{ marginBottom:20 }} />
            <div style={{ display:'flex', gap:12, justifyContent:'flex-end' }}><button className="btn-secondary" onClick={() => setEditingLocation(null)}>Cancel</button><button className="btn-primary" onClick={handleUpdateLocation}>Save</button></div>
          </div>
        </div>
      )}

      {/* Settings */}
      {showSettings && (
        <div className="modal-overlay" onClick={() => setShowSettings(false)}>
          <div className="modal-content" onClick={e => e.stopPropagation()} style={{ maxWidth:450 }}>
            <h2 style={{ marginBottom:20 }}>‚öôÔ∏è Settings</h2>
            <label style={{ display:'block', marginBottom:8, fontSize:14, color:'#94a3b8' }}>Company Display Name</label>
            <input className="input-field" placeholder="Company Name" value={companyName} onChange={e => setCompanyName(e.target.value)} style={{ marginBottom:20 }} />
            
            {isAdminRole && <>
              <label style={{ display:'block', marginBottom:8, fontSize:14, color:'#94a3b8' }}>üé® Company Branding</label>
              <div style={{ background:'rgba(15,23,42,0.5)', borderRadius:12, padding:16, marginBottom:20, border:'1px solid var(--border-color)' }}>
                <div style={{ marginBottom:16 }}>
                  <label style={{ display:'flex', alignItems:'center', gap:10, marginBottom:6, fontSize:13, color:'var(--text-secondary)' }}>
                    Brand / Text Color
                    <span style={{ display:'inline-block', width:24, height:24, borderRadius:6, background:brandColor, border:'2px solid var(--border-color)' }} />
                  </label>
                  <div style={{ display:'flex', gap:8, alignItems:'center' }}>
                    <input type="color" value={brandColor} onChange={e => setBrandColor(e.target.value)} style={{ width:50, height:36, border:'none', borderRadius:8, cursor:'pointer', background:'transparent' }} />
                    <input className="input-field" value={brandColor} onChange={e => setBrandColor(e.target.value)} style={{ fontFamily:"'JetBrains Mono', monospace", fontSize:13, flex:1 }} placeholder="#ffd700" />
                  </div>
                </div>
                <div style={{ marginBottom:16 }}>
                  <label style={{ display:'flex', alignItems:'center', gap:10, marginBottom:6, fontSize:13, color:'var(--text-secondary)' }}>
                    Background Color 1
                    <span style={{ display:'inline-block', width:24, height:24, borderRadius:6, background:bgColor1, border:'2px solid var(--border-color)' }} />
                  </label>
                  <div style={{ display:'flex', gap:8, alignItems:'center' }}>
                    <input type="color" value={bgColor1} onChange={e => setBgColor1(e.target.value)} style={{ width:50, height:36, border:'none', borderRadius:8, cursor:'pointer', background:'transparent' }} />
                    <input className="input-field" value={bgColor1} onChange={e => setBgColor1(e.target.value)} style={{ fontFamily:"'JetBrains Mono', monospace", fontSize:13, flex:1 }} placeholder="#0f172a" />
                  </div>
                </div>
                <div style={{ marginBottom:12 }}>
                  <label style={{ display:'flex', alignItems:'center', gap:10, marginBottom:6, fontSize:13, color:'var(--text-secondary)' }}>
                    Background Color 2
                    <span style={{ display:'inline-block', width:24, height:24, borderRadius:6, background:bgColor2, border:'2px solid var(--border-color)' }} />
                  </label>
                  <div style={{ display:'flex', gap:8, alignItems:'center' }}>
                    <input type="color" value={bgColor2} onChange={e => setBgColor2(e.target.value)} style={{ width:50, height:36, border:'none', borderRadius:8, cursor:'pointer', background:'transparent' }} />
                    <input className="input-field" value={bgColor2} onChange={e => setBgColor2(e.target.value)} style={{ fontFamily:"'JetBrains Mono', monospace", fontSize:13, flex:1 }} placeholder="#1e293b" />
                  </div>
                </div>
                {/* Live preview */}
                <div style={{ background:`linear-gradient(135deg, ${bgColor1} 0%, ${bgColor2} 50%, ${bgColor1} 100%)`, borderRadius:10, padding:16, textAlign:'center', border:'1px solid var(--border-color)' }}>
                  <p style={{ fontSize:11, color:'var(--text-muted)', marginBottom:4 }}>Preview</p>
                  <h3 style={{ margin:0, color: brandColor, fontSize:18, fontWeight:700 }}>{companyName || 'Company Name'}</h3>
                  <p style={{ margin:'2px 0 0', fontSize:11, color:'var(--text-muted)' }}>Asset Management</p>
                </div>
                <button className="btn-secondary" style={{ marginTop:12, width:'100%', fontSize:12 }} onClick={() => { setBrandColor('#ffd700'); setBgColor1('#0f172a'); setBgColor2('#1e293b'); }}>‚Ü© Reset to Defaults</button>
              </div>
            </>}
            
            <button className="btn-secondary" style={{ width:'100%', marginBottom:20 }} onClick={() => { setShowSettings(false); setShowChangePw(true); }}>üîë Change Password</button>
            
            {/* Quick Actions */}
            <label style={{ display:'block', marginBottom:8, fontSize:14, color:'#94a3b8' }}>‚ö° Quick Actions</label>
            <div style={{ display:'grid', gridTemplateColumns: canEditData ? '1fr 1fr' : '1fr', gap:10, marginBottom:20 }}>
              {isAdminRole && <button className="btn-secondary" style={{ padding:'12px 16px', fontSize:13, display:'flex', alignItems:'center', gap:8, justifyContent:'center' }} onClick={() => { setShowSettings(false); setShowExportModal(true); }}>üì§ Export Data</button>}
              {canEditData && <button className="btn-secondary" style={{ padding:'12px 16px', fontSize:13, display:'flex', alignItems:'center', gap:8, justifyContent:'center' }} onClick={() => { setShowSettings(false); setShowManageCategories(true); }}>üè∑Ô∏è Categories</button>}
              {canEditData && <button className="btn-secondary" style={{ padding:'12px 16px', fontSize:13, display:'flex', alignItems:'center', gap:8, justifyContent:'center' }} onClick={() => { setShowSettings(false); setShowAddLocation(true); }}>üìç Add Location</button>}
              {canEditData && <button className="btn-secondary" style={{ padding:'12px 16px', fontSize:13, display:'flex', alignItems:'center', gap:8, justifyContent:'center' }} onClick={() => { setShowSettings(false); setShowAddAsset(true); }}>‚ûï Add Asset</button>}
            </div>

            <div style={{ display:'flex', gap:12, justifyContent:'flex-end' }}><button className="btn-secondary" onClick={() => setShowSettings(false)}>Cancel</button><button className="btn-primary" onClick={handleSaveSettings}>Save</button></div>
          </div>
        </div>
      )}

      {/* Change Password */}
      {showChangePw && (
        <div className="modal-overlay" onClick={() => setShowChangePw(false)}>
          <div className="modal-content" onClick={e => e.stopPropagation()} style={{ maxWidth:400 }}>
            <h2 style={{ marginBottom:20 }}>üîë Change Password</h2>
            <input className="input-field" type="password" placeholder="Current Password" value={pwData.current} onChange={e => setPwData({...pwData, current:e.target.value})} style={{ marginBottom:12 }} />
            <input className="input-field" type="password" placeholder="New Password" value={pwData.new} onChange={e => setPwData({...pwData, new:e.target.value})} style={{ marginBottom:12 }} />
            <input className="input-field" type="password" placeholder="Confirm" value={pwData.confirm} onChange={e => setPwData({...pwData, confirm:e.target.value})} style={{ marginBottom:20 }} />
            <div style={{ display:'flex', gap:12, justifyContent:'flex-end' }}><button className="btn-secondary" onClick={() => setShowChangePw(false)}>Cancel</button><button className="btn-primary" onClick={handleChangePw}>Change</button></div>
          </div>
        </div>
      )}

      {/* Manage Categories */}
      {showManageCategories && (
        <div className="modal-overlay" onClick={() => setShowManageCategories(false)}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <h2 style={{ marginBottom:20 }}>üè∑Ô∏è Manage Categories</h2>
            <div style={{ display:'flex', gap:8, marginBottom:16 }}>
              <input className="input-field" placeholder="New category name" value={newCategory} onChange={e => setNewCategory(e.target.value)} onKeyDown={e => e.key==='Enter'&&handleAddCategory()} />
              <button className="btn-primary" style={{ whiteSpace:'nowrap' }} onClick={handleAddCategory}>+ Add</button>
            </div>
            <div style={{ display:'flex', flexDirection:'column', gap:8 }}>
              {categories.map(cat => (
                <div key={cat} style={{ display:'flex', justifyContent:'space-between', alignItems:'center', padding:'10px 12px', background:'rgba(15,23,42,0.5)', borderRadius:8 }}>
                  {editingCategory===cat ? (
                    <div style={{ display:'flex', gap:8, flex:1 }}>
                      <input className="input-field" value={editingCategoryName} onChange={e => setEditingCategoryName(e.target.value)} style={{ padding:'6px 10px' }} />
                      <button className="btn-primary" style={{ padding:'6px 12px' }} onClick={handleRenameCategory}>Save</button>
                      <button className="btn-secondary" style={{ padding:'6px 12px' }} onClick={() => setEditingCategory(null)}>Cancel</button>
                    </div>
                  ) : (
                    <><span>{cat}</span><div style={{ display:'flex', gap:4 }}><button className="btn-secondary" style={{ padding:'4px 8px', fontSize:12 }} onClick={() => { setEditingCategory(cat); setEditingCategoryName(cat); }}>‚úèÔ∏è</button><button className="btn-danger" style={{ padding:'4px 8px', fontSize:12 }} onClick={() => handleDeleteCategory(cat)}>üóë</button></div></>
                  )}
                </div>
              ))}
            </div>
            <div style={{ marginTop:20, textAlign:'right' }}><button className="btn-secondary" onClick={() => setShowManageCategories(false)}>Close</button></div>
          </div>
        </div>
      )}

      {/* User Management */}
      {showUserMgmt && <UserManagement currentUser={user} onClose={() => setShowUserMgmt(false)} />}

      {/* Export Modal */}
      {showExportModal && (
        <div className="modal-overlay" onClick={() => !exportProgress && setShowExportModal(false)}>
          <div className="modal-content" onClick={e => e.stopPropagation()} style={{ maxWidth:480 }}>
            <h2 style={{ marginBottom:8 }}>üì§ Export Company Data</h2>
            <p style={{ color:'var(--text-muted)', fontSize:13, marginBottom:24 }}>Download all assets, locations, categories, and notes for <strong style={{ color:'var(--text-primary)' }}>{companyName || 'this company'}</strong></p>
            
            <div style={{ display:'flex', flexDirection:'column', gap:12, marginBottom:20 }}>
              <button className="btn-primary" style={{ padding:'16px 24px', display:'flex', alignItems:'center', gap:12, justifyContent:'center' }} disabled={!!exportProgress} onClick={() => { handleExportJSON(true); }}>
                <span style={{ fontSize:22 }}>üóúÔ∏è</span>
                <div style={{ textAlign:'left' }}>
                  <div style={{ fontWeight:600 }}>Export Compressed JSON</div>
                  <div style={{ fontSize:11, opacity:0.8, fontWeight:400 }}>Photos resized & compressed ‚Ä¢ Small file ‚Ä¢ Re-importable</div>
                </div>
              </button>
              <button className="btn-secondary" style={{ padding:'14px 24px', display:'flex', alignItems:'center', gap:12, justifyContent:'center' }} disabled={!!exportProgress} onClick={() => { handleExportJSON(false); setShowExportModal(false); }}>
                <span style={{ fontSize:22 }}>üìã</span>
                <div style={{ textAlign:'left' }}>
                  <div style={{ fontWeight:600 }}>Export Full JSON</div>
                  <div style={{ fontSize:11, opacity:0.8, fontWeight:400 }}>Original quality photos ‚Ä¢ Larger file ‚Ä¢ Full backup</div>
                </div>
              </button>
              <button className="btn-secondary" style={{ padding:'14px 24px', display:'flex', alignItems:'center', gap:12, justifyContent:'center' }} disabled={!!exportProgress} onClick={() => { handleExportExcel(); setShowExportModal(false); }}>
                <span style={{ fontSize:22 }}>üìä</span>
                <div style={{ textAlign:'left' }}>
                  <div style={{ fontWeight:600 }}>Export as CSV / Excel</div>
                  <div style={{ fontSize:11, opacity:0.8, fontWeight:400 }}>Spreadsheet format ‚Ä¢ No photos ‚Ä¢ Opens in Excel</div>
                </div>
              </button>
            </div>

            {exportProgress && (
              <div style={{ background:'rgba(15,23,42,0.5)', borderRadius:12, padding:16, marginBottom:20, border:'1px solid var(--border-color)' }}>
                <div style={{ display:'flex', justifyContent:'space-between', fontSize:12, color:'var(--text-muted)', marginBottom:8 }}>
                  <span>{exportProgress.status}</span>
                  <span>{exportProgress.total > 0 ? Math.round((exportProgress.current/exportProgress.total)*100) : 0}%</span>
                </div>
                <div style={{ width:'100%', height:8, background:'rgba(148,163,184,0.1)', borderRadius:4, overflow:'hidden' }}>
                  <div style={{ height:'100%', borderRadius:4, background:'linear-gradient(90deg, #ffd700, #34d399)', transition:'width 0.3s', width: exportProgress.total > 0 ? (exportProgress.current/exportProgress.total*100)+'%' : '0%' }} />
                </div>
              </div>
            )}

            <div style={{ background:'rgba(15,23,42,0.5)', borderRadius:10, padding:14, border:'1px solid var(--border-color)', marginBottom:20 }}>
              <div style={{ display:'grid', gridTemplateColumns:'1fr 1fr 1fr', gap:10, textAlign:'center' }}>
                <div><p style={{ fontSize:20, fontWeight:700, margin:0, fontFamily:"'JetBrains Mono', monospace" }}>{assets.length}</p><p style={{ fontSize:11, color:'var(--text-muted)', margin:0 }}>Assets</p></div>
                <div><p style={{ fontSize:20, fontWeight:700, margin:0, fontFamily:"'JetBrains Mono', monospace" }}>{locations.length}</p><p style={{ fontSize:11, color:'var(--text-muted)', margin:0 }}>Locations</p></div>
                <div><p style={{ fontSize:20, fontWeight:700, margin:0, fontFamily:"'JetBrains Mono', monospace" }}>{assets.reduce((s,a) => s + (a.photos||[]).length, 0)}</p><p style={{ fontSize:11, color:'var(--text-muted)', margin:0 }}>Photos</p></div>
              </div>
            </div>

            <div style={{ textAlign:'right' }}><button className="btn-secondary" onClick={() => { setExportProgress(null); setShowExportModal(false); }}>{exportProgress ? 'Done' : 'Close'}</button></div>
          </div>
        </div>
      )}

      {/* Notes Modal */}
      {showNotesModal && (
        <div className="modal-overlay" onClick={() => { setShowNotesModal(null); setNewNote(''); }}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <h2 style={{ marginBottom:16 }}>üìù Notes: {showNotesModal.name}</h2>
            {canEditData && <div style={{ display:'flex', gap:8, marginBottom:16 }}>
              <textarea className="input-field" placeholder="Add a note..." value={newNote} onChange={e => setNewNote(e.target.value)} rows={2} style={{ resize:'vertical' }} />
              <button className="btn-primary" style={{ alignSelf:'flex-end' }} onClick={handleAddNote}>Add</button>
            </div>}
            <div style={{ maxHeight:300, overflowY:'auto' }}>
              {(showNotesModal.notes||[]).map(n => (
                <div key={n.id} style={{ padding:'12px', marginBottom:8, background:'rgba(15,23,42,0.5)', borderRadius:8, borderLeft:'3px solid #3b82f6' }}>
                  <div style={{ display:'flex', justifyContent:'space-between', marginBottom:4 }}>
                    <span style={{ fontSize:11, color:'#64748b' }}>{n.created_by} ‚Ä¢ {new Date(n.created_at).toLocaleString()}</span>
                    {canEditData && <button onClick={() => handleDeleteNote(n.id)} style={{ background:'none', border:'none', color:'#64748b', cursor:'pointer' }}>‚úï</button>}
                  </div>
                  <p style={{ margin:0, whiteSpace:'pre-wrap' }}>{n.text}</p>
                </div>
              ))}
            </div>
            <div style={{ marginTop:20, textAlign:'right' }}><button className="btn-secondary" onClick={() => { setShowNotesModal(null); setNewNote(''); }}>Close</button></div>
          </div>
        </div>
      )}

      {/* Photo Viewer */}
      {showPhotoViewer && (
        <div className="modal-overlay" onClick={() => setShowPhotoViewer(null)}>
          <div className="modal-content" onClick={e => e.stopPropagation()} style={{ maxWidth:700 }}>
            <h2 style={{ marginBottom:20 }}>üì∑ {showPhotoViewer.name}</h2>
            <div style={{ display:'grid', gridTemplateColumns:'repeat(auto-fill, minmax(180px, 1fr))', gap:16 }}>
              {showPhotoViewer.photos?.map(p => (
                <div key={p.id} style={{ borderRadius:12, overflow:'hidden', border:'1px solid rgba(148,163,184,0.2)', position:'relative' }}>
                  <img src={p.url} style={{ width:'100%', height:150, objectFit:'cover', cursor:'pointer' }} onClick={() => setFullscreenPhoto(p)} />
                  <div style={{ padding:8, display:'flex', justifyContent:'space-between', alignItems:'center', gap:8 }}>
                    <span style={{ fontSize:11, color:'#64748b', overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap', flex:1 }}>{p.name}</span>
                    <a href={p.url} download={p.name} style={{ color:'#60a5fa', fontSize:11, textDecoration:'none' }}>‚¨á</a>
                    {canEditData && <button onClick={() => { handleDeletePhoto(showPhotoViewer.id,p.id); setShowPhotoViewer({...showPhotoViewer, photos:showPhotoViewer.photos.filter(x=>x.id!==p.id)}); }} style={{ background:'rgba(239,68,68,0.2)', border:'none', color:'#f87171', fontSize:11, padding:'2px 6px', borderRadius:4, cursor:'pointer' }}>üóë</button>}
                  </div>
                </div>
              ))}
            </div>
            <div style={{ marginTop:20, textAlign:'right' }}><button className="btn-secondary" onClick={() => setShowPhotoViewer(null)}>Close</button></div>
          </div>
        </div>
      )}

      {/* Fullscreen Photo */}
      {fullscreenPhoto && (
        <div className="modal-overlay" style={{ background:'rgba(0,0,0,0.95)', zIndex:2000 }} onClick={() => setFullscreenPhoto(null)}>
          <div onClick={e => e.stopPropagation()} style={{ maxWidth:'95vw', maxHeight:'95vh', display:'flex', flexDirection:'column', alignItems:'center', position:'relative' }}>
            <button onClick={() => setFullscreenPhoto(null)} style={{ position:'absolute', top:20, right:20, background:'rgba(255,255,255,0.1)', border:'none', borderRadius:'50%', width:40, height:40, color:'white', fontSize:20, cursor:'pointer', zIndex:10 }}>‚úï</button>
            {showPhotoViewer?.photos?.length>1 && <>
              <button onClick={() => { const i=showPhotoViewer.photos.findIndex(p=>p.id===fullscreenPhoto.id); setFullscreenPhoto(showPhotoViewer.photos[i===0?showPhotoViewer.photos.length-1:i-1]); }} style={{ position:'absolute', left:20, top:'50%', transform:'translateY(-50%)', background:'linear-gradient(135deg,#ffd700,#d4a000)', border:'none', borderRadius:'50%', width:60, height:60, color:'#1a1a2e', fontSize:28, fontWeight:'bold', cursor:'pointer', zIndex:10, boxShadow:'0 4px 20px rgba(0,0,0,0.5)', display:'flex', alignItems:'center', justifyContent:'center' }}>‚óÄ</button>
              <button onClick={() => { const i=showPhotoViewer.photos.findIndex(p=>p.id===fullscreenPhoto.id); setFullscreenPhoto(showPhotoViewer.photos[i===showPhotoViewer.photos.length-1?0:i+1]); }} style={{ position:'absolute', right:20, top:'50%', transform:'translateY(-50%)', background:'linear-gradient(135deg,#ffd700,#d4a000)', border:'none', borderRadius:'50%', width:60, height:60, color:'#1a1a2e', fontSize:28, fontWeight:'bold', cursor:'pointer', zIndex:10, boxShadow:'0 4px 20px rgba(0,0,0,0.5)', display:'flex', alignItems:'center', justifyContent:'center' }}>‚ñ∂</button>
            </>}
            <img src={fullscreenPhoto.url} style={{ maxWidth:'100%', maxHeight:'calc(95vh - 120px)', objectFit:'contain', borderRadius:8 }} />
            <div style={{ marginTop:16, display:'flex', alignItems:'center', gap:16, background:'rgba(30,41,59,0.9)', padding:'12px 20px', borderRadius:10 }}>
              {showPhotoViewer?.photos?.length>1 && <span style={{ color:'#64748b', fontSize:13 }}>{showPhotoViewer.photos.findIndex(p=>p.id===fullscreenPhoto.id)+1} / {showPhotoViewer.photos.length}</span>}
              <span>{fullscreenPhoto.name}</span>
              <a href={fullscreenPhoto.url} download={fullscreenPhoto.name} className="btn-primary" style={{ textDecoration:'none', padding:'8px 16px' }}>‚¨á Download</a>
            </div>
            {showPhotoViewer?.photos?.length>1 && (
              <div style={{ display:'flex', gap:8, marginTop:12, padding:'8px 12px', background:'rgba(30,41,59,0.7)', borderRadius:10 }}>
                {showPhotoViewer.photos.map(p => (
                  <img key={p.id} src={p.url} onClick={() => setFullscreenPhoto(p)} style={{ width:50, height:50, objectFit:'cover', borderRadius:6, cursor:'pointer', border:p.id===fullscreenPhoto.id?'2px solid #ffd700':'2px solid transparent', opacity:p.id===fullscreenPhoto.id?1:0.6 }} />
                ))}
              </div>
            )}
          </div>
        </div>
      )}

      {/* Bulk Transfer */}
      {showBulkTransfer && (
        <div className="modal-overlay" onClick={() => setShowBulkTransfer(false)}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <h2 style={{ marginBottom:20 }}>üìç Move {selectedAssets.length} Asset(s)</h2>
            <select className="input-field" value={bulkTransferTo} onChange={e => setBulkTransferTo(e.target.value)} style={{ marginBottom:20 }}><option value="">Select destination</option>{locations.map(l => <option key={l.id} value={l.id}>{l.name}</option>)}</select>
            <div style={{ display:'flex', gap:12, justifyContent:'flex-end' }}><button className="btn-secondary" onClick={() => setShowBulkTransfer(false)}>Cancel</button><button className="btn-primary" onClick={handleBulkTransfer} disabled={!bulkTransferTo}>Transfer</button></div>
          </div>
        </div>
      )}

      {/* Bulk Category */}
      {showBulkCategory && (
        <div className="modal-overlay" onClick={() => setShowBulkCategory(false)}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <h2 style={{ marginBottom:20 }}>üè∑Ô∏è Change Category for {selectedAssets.length} Asset(s)</h2>
            <select className="input-field" value={bulkCategoryTo} onChange={e => setBulkCategoryTo(e.target.value)} style={{ marginBottom:20 }}><option value="">Select category</option>{categories.map(c => <option key={c} value={c}>{c}</option>)}</select>
            <div style={{ display:'flex', gap:12, justifyContent:'flex-end' }}><button className="btn-secondary" onClick={() => setShowBulkCategory(false)}>Cancel</button><button className="btn-purple" onClick={handleBulkCategory} disabled={!bulkCategoryTo}>Apply</button></div>
          </div>
        </div>
      )}

      {/* Bulk Delete */}
      {showBulkDelete && (
        <div className="modal-overlay" onClick={() => setShowBulkDelete(false)}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <h2 style={{ marginBottom:8, color:'#ef4444' }}>üóëÔ∏è Delete {selectedAssets.length} Asset(s)?</h2>
            <p style={{ color:'#94a3b8', fontSize:14, marginBottom:16 }}>This cannot be undone.</p>
            <div style={{ background:'rgba(239,68,68,0.1)', borderRadius:10, padding:12, marginBottom:20, border:'1px solid rgba(239,68,68,0.2)', maxHeight:200, overflowY:'auto' }}>
              {assets.filter(a => selectedAssets.includes(a.id)).map(a => (
                <div key={a.id} style={{ display:'flex', justifyContent:'space-between', padding:'6px 0', borderBottom:'1px solid rgba(148,163,184,0.1)', fontSize:13 }}>
                  <span>{a.name}</span>
                  <span style={{ fontFamily:"'JetBrains Mono',monospace", color:'#ef4444' }}>{formatCurrency(a.currentValue*a.quantity)}</span>
                </div>
              ))}
            </div>
            <div style={{ display:'flex', gap:12, justifyContent:'flex-end' }}><button className="btn-secondary" onClick={() => setShowBulkDelete(false)}>Cancel</button><button className="btn-danger" onClick={handleBulkDelete}>Delete All</button></div>
          </div>
        </div>
      )}

    </div>
  );
};

// ==================== CHART COMPONENTS ====================
const BarChart = ({ data, title, showValues = true, colorScheme = 'blue' }) => {
  const maxValue = Math.max(...data.map(d => d.value), 1);
  const colors = {
    blue: ['#3b82f6','#60a5fa','#93c5fd','#2563eb','#1d4ed8','#1e40af','#3b82f6','#60a5fa'],
    green: ['#22c55e','#4ade80','#86efac','#16a34a','#15803d','#166534','#22c55e','#4ade80'],
    mixed: ['#3b82f6','#22c55e','#f59e0b','#ef4444','#8b5cf6','#06b6d4','#ec4899','#84cc16']
  };
  const p = colors[colorScheme] || colors.mixed;
  return (
    <div className="chart-container">
      {title && <h4 style={{ marginBottom:16, color:'var(--text-primary)' }}>{title}</h4>}
      <div style={{ display:'flex', flexDirection:'column', gap:8 }}>
        {data.map((item, idx) => (
          <div key={idx} style={{ display:'flex', alignItems:'center', gap:12 }}>
            <span style={{ width:100, fontSize:12, color:'var(--text-secondary)', overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap' }}>{item.label}</span>
            <div style={{ flex:1, background:'var(--bg-tertiary)', borderRadius:6, height:24, overflow:'hidden' }}>
              <div className="chart-bar" style={{ width:`${(item.value/maxValue)*100}%`, background:p[idx%p.length], display:'flex', alignItems:'center', justifyContent:'flex-end', paddingRight:8 }}>
                {showValues && item.value > maxValue*0.15 && <span style={{ fontSize:11, color:'white', fontWeight:600 }}>{item.displayValue||item.value}</span>}
              </div>
            </div>
            {showValues && item.value <= maxValue*0.15 && <span style={{ fontSize:11, color:'var(--text-muted)', minWidth:50 }}>{item.displayValue||item.value}</span>}
          </div>
        ))}
      </div>
    </div>
  );
};

const DonutChart = ({ data, title, size = 160 }) => {
  const total = data.reduce((sum,d) => sum+d.value, 0) || 1;
  const colors = ['#3b82f6','#22c55e','#f59e0b','#ef4444','#8b5cf6','#06b6d4','#ec4899','#84cc16'];
  let cum = 0;
  const coord = (pct) => [Math.cos(2*Math.PI*pct), Math.sin(2*Math.PI*pct)];
  return (
    <div className="chart-container" style={{ textAlign:'center' }}>
      {title && <h4 style={{ marginBottom:16, color:'var(--text-primary)' }}>{title}</h4>}
      <svg width={size} height={size} viewBox="-1 -1 2 2" style={{ transform:'rotate(-90deg)', margin:'0 auto', display:'block' }}>
        {data.map((item,idx) => {
          if(item.value===0) return null;
          const [sx,sy] = coord(cum);
          const pct = item.value/total; cum += pct;
          const [ex,ey] = coord(cum);
          return <path key={idx} d={`M ${sx} ${sy} A 1 1 0 ${pct>0.5?1:0} 1 ${ex} ${ey} L 0 0`} fill={colors[idx%colors.length]} style={{ opacity:0.9 }}><title>{item.label}: {item.displayValue||item.value}</title></path>;
        })}
        <circle cx="0" cy="0" r="0.6" fill="var(--bg-card-solid, #1e293b)" />
      </svg>
      <div style={{ display:'flex', flexWrap:'wrap', gap:12, marginTop:16, justifyContent:'center' }}>
        {data.filter(d=>d.value>0).map((item,idx) => (
          <div key={idx} style={{ display:'flex', alignItems:'center', gap:6, fontSize:12, color:'var(--text-secondary)' }}>
            <div style={{ width:10, height:10, borderRadius:'50%', background:colors[idx%colors.length] }} /><span>{item.label}</span>
          </div>
        ))}
      </div>
    </div>
  );
};

// Theme Context
const ThemeContext = React.createContext();
const useTheme = () => React.useContext(ThemeContext);

// ==================== MAIN APP ====================
const App = () => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [theme, setTheme] = useState(() => localStorage.getItem('kassets_theme') || 'dark');

  useEffect(() => { document.documentElement.setAttribute('data-theme', theme); localStorage.setItem('kassets_theme', theme); }, [theme]);

  useEffect(() => {
    const token = localStorage.getItem('kassets_token');
    const savedUser = localStorage.getItem('kassets_user');
    if (token && savedUser) {
      api('/auth/me').then(u => setUser(u)).catch(() => { localStorage.clear(); }).finally(() => setLoading(false));
    } else {
      setLoading(false);
    }
  }, []);

  const handleLogout = () => { localStorage.clear(); setUser(null); };
  const toggleTheme = () => setTheme(t => t === 'dark' ? 'light' : 'dark');

  if (loading) return <div style={{ minHeight:'100vh', background:'var(--bg-secondary)', display:'flex', alignItems:'center', justifyContent:'center', color:'var(--text-muted)' }}>Loading...</div>;
  if (!user) return <LoginPage onLogin={setUser} theme={theme} toggleTheme={toggleTheme} />;
  
  // Route based on role
  if (user.role === 'super_admin') return <ThemeContext.Provider value={{ theme, toggleTheme }}><SuperAdminDashboard user={user} onLogout={handleLogout} /></ThemeContext.Provider>;
  return <ThemeContext.Provider value={{ theme, toggleTheme }}><AssetManager user={user} onLogout={handleLogout} /></ThemeContext.Provider>;
};

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
